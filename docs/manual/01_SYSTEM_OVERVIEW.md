# 01. システム概要

## 1.1 システムの目的

お絵描きバトラーは、手描きのキャラクターイラストをAI解析によってRPG風のステータスに変換し、自動対戦させるシステムです。

### 主な特徴
- 📝 **アナログ描画対応**: 紙に描いたキャラクターをスキャン・撮影して利用可能
- 🤖 **AI自動解析**: Google Gemini AIがイラストからステータスを生成
- ⚔️ **完全自動バトル**: ユーザー操作なしで戦闘が進行
- 📊 **データ永続化**: Google SheetsまたはSQLiteでデータ管理
- 📱 **LINE Bot連携**: LINEからキャラクター画像を直接登録可能

---

## 1.2 システムアーキテクチャ

### 1.2.1 レイヤー構成

```
┌─────────────────────────────────────────────────────┐
│                 UI Layer (Tkinter/Pygame)           │
│  - メインメニュー (main_menu.py)                      │
│  - バトル画面 (Pygameフルスクリーン)                   │
│  - ストーリーボス管理UI (story_boss_manager.py)       │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│              Services Layer (ビジネスロジック)        │
│  - AIアナライザー (ai_analyzer.py)                    │
│  - 画像プロセッサー (image_processor.py)              │
│  - バトルエンジン (battle_engine.py)                  │
│  - ストーリーモードエンジン (story_mode_engine.py)     │
│  - エンドレスバトルエンジン (endless_battle_engine.py) │
│  - シートマネージャー (sheets_manager.py)             │
│  - データベースマネージャー (database_manager.py)      │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│              Models Layer (データ定義)                │
│  - Character (Pydantic)                             │
│  - Battle (Pydantic)                                │
│  - StoryBoss (Pydantic)                             │
│  - StoryProgress (Pydantic)                         │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│          Data Storage Layer (永続化)                 │
│  - Google Sheets (オンラインモード)                   │
│  - Google Drive (画像保存)                           │
│  - SQLite (オフラインモード)                          │
│  - ローカルファイルシステム (画像キャッシュ)            │
└─────────────────────────────────────────────────────┘
```

### 1.2.2 外部システム連携

```
┌──────────────┐
│  LINE Bot    │
│  (Node.js)   │
└──────┬───────┘
       │ Webhook
       ↓
┌──────────────────┐
│ Google Apps      │
│ Script (GAS)     │
│ - 画像保存        │
│ - Sheets書き込み  │
└──────┬───────────┘
       │
       ↓
┌──────────────────┐        ┌──────────────────┐
│ Google Drive     │←───────│ Google Sheets    │
│ (画像保存)        │        │ (データ管理)      │
└──────────────────┘        └──────────────────┘
       ↑                             ↑
       │                             │
       └─────────────┬───────────────┘
                     │
              ┌──────┴───────┐
              │ Main App     │
              │ (Python)     │
              └──────────────┘
```

---

## 1.3 技術スタック

### 1.3.1 コア技術

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| 言語 | Python | 3.11+ | メインアプリケーション |
| GUI | Tkinter | 標準ライブラリ | メニューUI |
| グラフィックス | Pygame | 2.x | バトル画面描画 |
| 画像処理 | Pillow | 10.x | 画像操作 |
| 画像処理 | OpenCV | 4.x | 背景除去・スプライト抽出 |
| データ検証 | Pydantic | 2.x | モデル定義・バリデーション |
| AI | Google Generative AI | 最新 | キャラクター解析 |
| データベース | SQLAlchemy + SQLite | 2.x | オフラインデータ管理 |

### 1.3.2 外部サービス

| サービス | 用途 | API |
|---------|------|-----|
| Google Gemini AI | イラストからステータス生成 | Generative AI API |
| Google Sheets | オンラインデータ管理 | Sheets API v4 |
| Google Drive | 画像保存・共有 | Drive API v3 |
| LINE Messaging API | LINE Bot連携 | Messaging API |

### 1.3.3 LINE Bot (オプション)

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| ランタイム | Node.js | 14+ |
| フレームワーク | Express | 4.x |
| LINE SDK | @line/bot-sdk | 最新 |
| トンネリング | ngrok | 3.x |

---

## 1.4 データフロー

### 1.4.1 キャラクター登録フロー

```
[手描きイラスト]
      ↓
[スキャン/撮影] → 画像ファイル (PNG/JPG)
      ↓
[画像アップロード]
      ↓
┌──────────────────────────────────┐
│ 画像処理パイプライン               │
│ 1. 背景除去                       │
│ 2. スプライト抽出                  │
│ 3. リサイズ・最適化                │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ AI解析 (Google Gemini)            │
│ - イラストの視覚的特徴を分析        │
│ - HP, 攻撃, 防御等のステータス生成  │
│ - キャラクター説明文生成            │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ データ検証 (Pydantic)              │
│ - ステータス範囲チェック            │
│ - 合計値制限チェック (≤350)        │
│ - 必須フィールド検証                │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ データ永続化                       │
│ - オンライン: Google Sheets/Drive  │
│ - オフライン: SQLite + ローカル保存 │
└──────────────────────────────────┘
```

### 1.4.2 バトル実行フロー

```
[バトル開始]
      ↓
┌──────────────────────────────────┐
│ キャラクターデータ読み込み          │
│ - DB/Sheetsから取得               │
│ - スプライト画像ロード              │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ バトルエンジン初期化               │
│ - HP設定                          │
│ - ターン順決定 (速さ依存)          │
│ - 初期配置                         │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ ターン処理ループ (最大100ターン)    │
│ ┌──────────────────────────────┐ │
│ │ 1. 行動順決定                 │ │
│ │ 2. 攻撃タイプ選択 (物理/魔法)  │ │
│ │ 3. ダメージ計算               │ │
│ │ 4. 特殊効果判定               │ │
│ │    - クリティカル (5-35%)     │ │
│ │    - ガードブレイク (15-30%)  │ │
│ │    - 回避 (速さ・運依存)      │ │
│ │ 5. HP更新                     │ │
│ │ 6. 画面描画                   │ │
│ └──────────────────────────────┘ │
│         ↓                         │
│   [HP ≤ 0 or ターン上限?]         │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ バトル結果処理                     │
│ - 勝敗判定                         │
│ - 統計データ計算                   │
│ - 戦績更新 (Wins/Losses/Draws)    │
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────────┐
│ データ保存                         │
│ - BattleHistoryシート (オンライン) │
│ - Rankingsシート更新               │
│ - キャラクター戦績更新              │
└──────────────────────────────────┘
```

---

## 1.5 コンポーネント構成

### 1.5.1 ディレクトリ構造

```
OekakiBattler/
├── main.py                     # エントリーポイント
├── img2txt.py                  # スタンドアロン画像解析ツール
├── config/
│   ├── settings.py            # 環境変数・定数管理
│   └── database.py            # SQLAlchemy設定
├── src/
│   ├── models/                # データモデル (Pydantic)
│   │   ├── character.py
│   │   ├── battle.py
│   │   ├── story_boss.py
│   │   └── story_progress.py
│   ├── services/              # ビジネスロジック
│   │   ├── ai_analyzer.py
│   │   ├── image_processor.py
│   │   ├── battle_engine.py
│   │   ├── story_mode_engine.py
│   │   ├── endless_battle_engine.py
│   │   ├── sheets_manager.py
│   │   ├── database_manager.py
│   │   ├── audio_manager.py
│   │   └── settings_manager.py
│   ├── ui/                    # ユーザーインターフェース
│   │   ├── main_menu.py
│   │   └── story_boss_manager.py
│   └── utils/                 # ユーティリティ
│       ├── image_utils.py
│       └── file_utils.py
├── server/                    # LINE Bot (Node.js)
│   ├── server.js
│   └── package.json
├── assets/                    # リソースファイル
│   ├── images/               # 背景画像・UI素材
│   └── sounds/               # 効果音
├── data/                      # データ保存先
│   ├── database.db           # SQLiteデータベース
│   ├── characters/           # オリジナル画像
│   └── sprites/              # スプライト画像
├── tests/                     # テストコード
└── docs/                      # ドキュメント
    └── manual/               # システムマニュアル
```

### 1.5.2 主要クラス関係図

```
┌────────────────┐
│  MainMenu      │ (Tkinter GUI)
└───────┬────────┘
        │ has-a
        ├──→ ┌──────────────────┐
        │    │ SheetsManager    │ (オンラインモード)
        │    └──────────────────┘
        │
        ├──→ ┌──────────────────┐
        │    │ DatabaseManager  │ (オフラインモード)
        │    └──────────────────┘
        │
        ├──→ ┌──────────────────┐
        │    │ AIAnalyzer       │
        │    └──────────────────┘
        │
        ├──→ ┌──────────────────┐
        │    │ ImageProcessor   │
        │    └──────────────────┘
        │
        └──→ ┌──────────────────┐
             │ BattleEngine     │
             └──────────────────┘
                      │ uses
                      ├──→ Character (model)
                      └──→ Battle (model)
```

---

## 1.6 動作モード

### 1.6.1 オンラインモード

**条件:**
- `credentials.json` が存在
- Google Sheets API が有効
- スプレッドシートが共有されている
- インターネット接続あり

**機能:**
- ✅ Google Sheetsでデータ管理
- ✅ Google Driveに画像保存
- ✅ バトル履歴記録
- ✅ ランキング自動更新
- ✅ ストーリーモード進行状況保存
- ✅ 複数デバイスでデータ共有可能

### 1.6.2 オフラインモード

**条件:**
- オンラインモード要件が満たされない場合に自動フォールバック

**機能:**
- ✅ SQLiteでローカルデータ管理
- ✅ ローカルファイルシステムに画像保存
- ✅ キャラクター登録・バトル実行可能
- ❌ バトル履歴記録なし
- ❌ ランキング機能なし
- ❌ ストーリーモード進行状況保存なし
- ❌ デバイス間データ共有不可

### 1.6.3 モード判定ロジック

```python
# config/settings.py または SheetsManager.__init__
try:
    credentials = service_account.Credentials.from_service_account_file(
        GOOGLE_CREDENTIALS_PATH,
        scopes=SCOPES
    )
    self.client = gspread.authorize(credentials)
    self.sheet = self.client.open_by_key(SPREADSHEET_ID)
    self.online_mode = True
except Exception:
    self.online_mode = False
    # SQLiteモードにフォールバック
```

---

## 1.7 セキュリティ考慮事項

### 1.7.1 機密情報管理

🔒 **環境変数で管理 (`.env`)**
```bash
GOOGLE_API_KEY=xxxxx          # Google Gemini AI
SPREADSHEET_ID=xxxxx
GOOGLE_CREDENTIALS_PATH=credentials.json
```

🔒 **Git除外設定 (`.gitignore`)**
```
.env
server/.env
credentials.json
*.db
```

### 1.7.2 API キー保護

- ⚠️ Google API キーは本番環境では IP 制限・ドメイン制限を設定
- ⚠️ サービスアカウントの権限は最小限に制限
- ⚠️ LINE Bot のチャネルシークレットは必ず環境変数で管理

### 1.7.3 データアクセス制御

- Google Sheets: サービスアカウントメールアドレスに編集権限を付与
- Google Drive: フォルダ共有設定でアクセス制御
- SQLite: ローカルファイルシステムの権限に依存

---

## 1.8 パフォーマンス特性

### 1.8.1 処理時間目安

| 処理 | 所要時間 | 備考 |
|------|---------|------|
| キャラクター登録 (AI解析含む) | 5-15秒 | Google Gemini APIのレスポンス時間に依存 |
| 画像処理 (背景除去・スプライト抽出) | 2-5秒 | 画像サイズに依存 |
| バトル1ターン描画 | 0.1-2.0秒 | 設定で調整可能 |
| 完全バトル (平均30ターン) | 3-60秒 | バトルスピード設定に依存 |
| Google Sheets書き込み | 1-3秒 | ネットワーク速度に依存 |
| Google Drive画像アップロード | 2-10秒 | 画像サイズ・ネットワーク速度に依存 |

### 1.8.2 キャッシュ戦略

**画像キャッシュ:**
- オンラインモードでもスプライト画像はローカルキャッシュ
- オリジナル画像はキャッシュせず、都度Drive URLから取得
- キャッシュ保存先: `data/sprites/{character_id}_sprite.png`

**データキャッシュ:**
- キャラクターリストはメモリ上にキャッシュ (GUIで保持)
- バトル実行時に最新データを再取得

### 1.8.3 API レート制限

| API | 制限 | 対策 |
|-----|------|------|
| Google Sheets API | 100 requests/100 seconds/user | バッチ更新の実装 |
| Google Drive API | 1000 requests/100 seconds/user | 画像キャッシュの活用 |
| Google Gemini API | プロジェクトによる | リトライ処理実装 |

---

## 1.9 制約事項

### 1.9.1 システム制約

| 項目 | 制約 | 理由 |
|------|------|------|
| キャラクター総ステータス | 最大350 | バランス調整 |
| ボス総ステータス | 最大500 | プレイヤーキャラより強力 |
| バトル最大ターン数 | 100ターン | 無限ループ防止 |
| 画像フォーマット | PNG, JPG, JPEG | Pillowサポート形式 |
| 画像最大サイズ | 制限なし (推奨: 10MB以下) | API制限・処理時間考慮 |

### 1.9.2 機能制約

**オフラインモード:**
- ❌ バトル履歴保存不可
- ❌ ランキング機能なし
- ❌ ストーリーモード進行状況保存なし

**LINE Bot:**
- ✅ 画像送信のみサポート
- ❌ テキストコマンドは未実装
- ❌ バトル実行は未実装

---

## 1.10 将来的な拡張性

### 1.10.1 アーキテクチャ上の拡張ポイント

**Webアプリケーション化:**
- UIレイヤーをFlask/FastAPI + Reactに置き換え
- Services/Modelsレイヤーはそのまま流用可能

**マルチプレイヤー対応:**
- WebSocket導入でリアルタイムバトル
- Redisでセッション管理

**モバイルアプリ化:**
- REST API実装
- React Native/Flutterクライアント

### 1.10.2 機能拡張候補

- [ ] キャラクター編集機能
- [ ] トーナメントブラケット表示
- [ ] キャラクター成長システム
- [ ] 高度なAIモデル (GPT-4V, Claude Vision)
- [ ] リアルタイム観戦機能
- [ ] キャラクターマーケットプレイス

---

## 次のセクション

次は [02_INSTALLATION.md](02_INSTALLATION.md) でインストール手順を確認してください。
