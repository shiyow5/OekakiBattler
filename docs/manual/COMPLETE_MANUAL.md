# ãŠçµµæããƒãƒˆãƒ©ãƒ¼ ã‚·ã‚¹ãƒ†ãƒ è©³ç´°ãƒžãƒ‹ãƒ¥ã‚¢ãƒ« (å®Œå…¨ç‰ˆ)

**ç”Ÿæˆæ—¥æ™‚:** 2025å¹´10æœˆ08æ—¥ 12:32:02

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.0

---

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’çµ±åˆã—ãŸã‚‚ã®ã§ã™ã€‚

---



================================================================================

# ãŠçµµæããƒãƒˆãƒ©ãƒ¼ ã‚·ã‚¹ãƒ†ãƒ è©³ç´°ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«

## ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ç›®æ¬¡

æœ¬ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ã€ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®å…¨æ©Ÿèƒ½ã¨ä»•æ§˜ã‚’ç¶²ç¾…ã—ãŸæŠ€è¡“æ–‡æ›¸ã§ã™ã€‚

### ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«æ§‹æˆ

1. **[01_SYSTEM_OVERVIEW.md](01_SYSTEM_OVERVIEW.md)** - ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦
   - ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
   - æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
   - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
   - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

2. **[02_INSTALLATION.md](02_INSTALLATION.md)** - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - å¿…è¦ãªç’°å¢ƒ
   - ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
   - Google APIè¨­å®š
   - ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

3. **[03_CHARACTER_MANAGEMENT.md](03_CHARACTER_MANAGEMENT.md)** - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†
   - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
   - ç”»åƒå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
   - AIåˆ†æžã‚·ã‚¹ãƒ†ãƒ 
   - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯

4. **[04_BATTLE_SYSTEM.md](04_BATTLE_SYSTEM.md)** - ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ 
   - ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ä»•æ§˜
   - ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—å¼
   - ç‰¹æ®ŠåŠ¹æžœï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ç­‰ï¼‰
   - ã‚¿ãƒ¼ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼
   - ãƒãƒˆãƒ«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿

5. **[05_STORY_MODE.md](05_STORY_MODE.md)** - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰
   - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ä»•æ§˜
   - ãƒœã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
   - é€²è¡ŒçŠ¶æ³ç®¡ç†
   - ãƒœã‚¹ä½œæˆãƒ»ç·¨é›†

6. **[06_DATA_MANAGEMENT.md](06_DATA_MANAGEMENT.md)** - ãƒ‡ãƒ¼ã‚¿ç®¡ç†
   - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰
   - Google Sheetsçµ±åˆ
   - SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
   - ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
   - ãƒ‡ãƒ¼ã‚¿åŒæœŸ

7. **[07_LINE_BOT.md](07_LINE_BOT.md)** - LINE Boté€£æº
   - LINE Bot ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
   - Webhookè¨­å®š
   - Google Apps Scripté€£æº
   - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

8. **[08_TROUBLESHOOTING.md](08_TROUBLESHOOTING.md)** - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
   - ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
   - ãƒ‡ãƒãƒƒã‚°æ–¹æ³•
   - ãƒ­ã‚°è§£æž

9. **[09_API_REFERENCE.md](09_API_REFERENCE.md)** - API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
   - ã‚¯ãƒ©ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ä»•æ§˜
   - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°
   - æˆ»ã‚Šå€¤å®šç¾©
   - ä½¿ç”¨ä¾‹

---

## ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã®ä½¿ã„æ–¹

### åˆã‚ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
1. [01_SYSTEM_OVERVIEW.md](01_SYSTEM_OVERVIEW.md)ã§ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ç†è§£
2. [02_INSTALLATION.md](02_INSTALLATION.md)ã§ç’°å¢ƒæ§‹ç¯‰
3. [03_CHARACTER_MANAGEMENT.md](03_CHARACTER_MANAGEMENT.md)ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆæ–¹æ³•ã‚’å­¦ç¿’

### é–‹ç™ºè€…
- [09_API_REFERENCE.md](09_API_REFERENCE.md)ã§å„ã‚¯ãƒ©ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã®ä»•æ§˜ã‚’ç¢ºèª
- [01_SYSTEM_OVERVIEW.md](01_SYSTEM_OVERVIEW.md)ã§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£
- [08_TROUBLESHOOTING.md](08_TROUBLESHOOTING.md)ã§ãƒ‡ãƒãƒƒã‚°æ–¹æ³•ã‚’ç¢ºèª

### æ©Ÿèƒ½åˆ¥ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´° â†’ [04_BATTLE_SYSTEM.md](04_BATTLE_SYSTEM.md)
- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®ä½¿ã„æ–¹ â†’ [05_STORY_MODE.md](05_STORY_MODE.md)
- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®ä»•çµ„ã¿ â†’ [06_DATA_MANAGEMENT.md](06_DATA_MANAGEMENT.md)

---

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

- **ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
- **å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ãŠçµµæããƒãƒˆãƒ©ãƒ¼ v1.x
- **æœ€çµ‚æ›´æ–°æ—¥**: 2025-10-08

---

## è¨˜å·ã®æ„å‘³

| è¨˜å· | æ„å‘³ |
|------|------|
| âœ… | æ­£å¸¸å‹•ä½œãƒ»æŽ¨å¥¨äº‹é … |
| âš ï¸ | æ³¨æ„äº‹é … |
| âŒ | éžæŽ¨å¥¨ãƒ»ç¦æ­¢äº‹é … |
| ðŸ’¡ | ãƒ’ãƒ³ãƒˆãƒ»Tips |
| ðŸ”§ | è¨­å®šãƒ»èª¿æ•´ãŒå¿…è¦ |
| ðŸ“Š | ãƒ‡ãƒ¼ã‚¿ãƒ»çµ±è¨ˆæƒ…å ± |
| ðŸ”’ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ |

---

## ã‚µãƒãƒ¼ãƒˆæƒ…å ±

### å•é¡Œå ±å‘Š
ãƒã‚°ã‚„ä¸å…·åˆã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦å ±å‘Šã—ã¦ãã ã•ã„ï¼š
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- å†ç¾æ‰‹é †
- ç’°å¢ƒæƒ…å ±ï¼ˆOSã€Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ç­‰ï¼‰
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«

### é–‹ç™ºç’°å¢ƒ
- **Python**: 3.11+
- **OS**: Windows 10/11, macOS 10.15+, Ubuntu 20.04+
- **å¿…é ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: requirements.txtå‚ç…§

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

æœ¬ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ã€ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ä¸€éƒ¨ã¨ã—ã¦æä¾›ã•ã‚Œã¾ã™ã€‚


================================================================================

# 01. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

## 1.1 ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„

ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã¯ã€æ‰‹æãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¤ãƒ©ã‚¹ãƒˆã‚’AIè§£æžã«ã‚ˆã£ã¦RPGé¢¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›ã—ã€è‡ªå‹•å¯¾æˆ¦ã•ã›ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### ä¸»ãªç‰¹å¾´
- ðŸ“ **ã‚¢ãƒŠãƒ­ã‚°æç”»å¯¾å¿œ**: ç´™ã«æã„ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ãƒ»æ’®å½±ã—ã¦åˆ©ç”¨å¯èƒ½
- ðŸ¤– **AIè‡ªå‹•è§£æž**: Google Gemini AIãŒã‚¤ãƒ©ã‚¹ãƒˆã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç”Ÿæˆ
- âš”ï¸ **å®Œå…¨è‡ªå‹•ãƒãƒˆãƒ«**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãªã—ã§æˆ¦é—˜ãŒé€²è¡Œ
- ðŸ“Š **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–**: Google Sheetsã¾ãŸã¯SQLiteã§ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- ðŸ“± **LINE Boté€£æº**: LINEã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’ç›´æŽ¥ç™»éŒ²å¯èƒ½

---

## 1.2 ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.2.1 ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 UI Layer (Tkinter/Pygame)           â”‚
â”‚  - ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (main_menu.py)                      â”‚
â”‚  - ãƒãƒˆãƒ«ç”»é¢ (Pygameãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³)                   â”‚
â”‚  - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹ç®¡ç†UI (story_boss_manager.py)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Services Layer (ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯)        â”‚
â”‚  - AIã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ (ai_analyzer.py)                    â”‚
â”‚  - ç”»åƒãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ (image_processor.py)              â”‚
â”‚  - ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ (battle_engine.py)                  â”‚
â”‚  - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³ (story_mode_engine.py)     â”‚
â”‚  - ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ (endless_battle_engine.py) â”‚
â”‚  - ã‚·ãƒ¼ãƒˆãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (sheets_manager.py)             â”‚
â”‚  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (database_manager.py)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Models Layer (ãƒ‡ãƒ¼ã‚¿å®šç¾©)                â”‚
â”‚  - Character (Pydantic)                             â”‚
â”‚  - Battle (Pydantic)                                â”‚
â”‚  - StoryBoss (Pydantic)                             â”‚
â”‚  - StoryProgress (Pydantic)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Data Storage Layer (æ°¸ç¶šåŒ–)                 â”‚
â”‚  - Google Sheets (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)                   â”‚
â”‚  - Google Drive (ç”»åƒä¿å­˜)                           â”‚
â”‚  - SQLite (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)                          â”‚
â”‚  - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ  (ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2.2 å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LINE Bot    â”‚
â”‚  (Node.js)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Webhook
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Apps      â”‚
â”‚ Script (GAS)     â”‚
â”‚ - ç”»åƒä¿å­˜        â”‚
â”‚ - Sheetsæ›¸ãè¾¼ã¿  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Drive     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”‚ Google Sheets    â”‚
â”‚ (ç”»åƒä¿å­˜)        â”‚        â”‚ (ãƒ‡ãƒ¼ã‚¿ç®¡ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                             â†‘
       â”‚                             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Main App     â”‚
              â”‚ (Python)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 1.3.1 ã‚³ã‚¢æŠ€è¡“

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|---------|------|-----------|------|
| è¨€èªž | Python | 3.11+ | ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |
| GUI | Tkinter | æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | ãƒ¡ãƒ‹ãƒ¥ãƒ¼UI |
| ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ | Pygame | 2.x | ãƒãƒˆãƒ«ç”»é¢æç”» |
| ç”»åƒå‡¦ç† | Pillow | 10.x | ç”»åƒæ“ä½œ |
| ç”»åƒå‡¦ç† | OpenCV | 4.x | èƒŒæ™¯é™¤åŽ»ãƒ»ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º |
| ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ | Pydantic | 2.x | ãƒ¢ãƒ‡ãƒ«å®šç¾©ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| AI | Google Generative AI | æœ€æ–° | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è§£æž |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | SQLAlchemy + SQLite | 2.x | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç† |

### 1.3.2 å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | API |
|---------|------|-----|
| Google Gemini AI | ã‚¤ãƒ©ã‚¹ãƒˆã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ | Generative AI API |
| Google Sheets | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç† | Sheets API v4 |
| Google Drive | ç”»åƒä¿å­˜ãƒ»å…±æœ‰ | Drive API v3 |
| LINE Messaging API | LINE Boté€£æº | Messaging API |

### 1.3.3 LINE Bot (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | Node.js | 14+ |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Express | 4.x |
| LINE SDK | @line/bot-sdk | æœ€æ–° |
| ãƒˆãƒ³ãƒãƒªãƒ³ã‚° | ngrok | 3.x |

---

## 1.4 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1.4.1 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```
[æ‰‹æãã‚¤ãƒ©ã‚¹ãƒˆ]
      â†“
[ã‚¹ã‚­ãƒ£ãƒ³/æ’®å½±] â†’ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (PNG/JPG)
      â†“
[ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”»åƒå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³               â”‚
â”‚ 1. èƒŒæ™¯é™¤åŽ»                       â”‚
â”‚ 2. ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º                  â”‚
â”‚ 3. ãƒªã‚µã‚¤ã‚ºãƒ»æœ€é©åŒ–                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIè§£æž (Google Gemini)            â”‚
â”‚ - ã‚¤ãƒ©ã‚¹ãƒˆã®è¦–è¦šçš„ç‰¹å¾´ã‚’åˆ†æž        â”‚
â”‚ - HP, æ”»æ’ƒ, é˜²å¾¡ç­‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ  â”‚
â”‚ - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¬æ˜Žæ–‡ç”Ÿæˆ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ (Pydantic)              â”‚
â”‚ - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¯„å›²ãƒã‚§ãƒƒã‚¯            â”‚
â”‚ - åˆè¨ˆå€¤åˆ¶é™ãƒã‚§ãƒƒã‚¯ (â‰¤350)        â”‚
â”‚ - å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œè¨¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–                       â”‚
â”‚ - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: Google Sheets/Drive  â”‚
â”‚ - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³: SQLite + ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4.2 ãƒãƒˆãƒ«å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```
[ãƒãƒˆãƒ«é–‹å§‹]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿          â”‚
â”‚ - DB/Sheetsã‹ã‚‰å–å¾—               â”‚
â”‚ - ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒãƒ­ãƒ¼ãƒ‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–               â”‚
â”‚ - HPè¨­å®š                          â”‚
â”‚ - ã‚¿ãƒ¼ãƒ³é †æ±ºå®š (é€Ÿã•ä¾å­˜)          â”‚
â”‚ - åˆæœŸé…ç½®                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¿ãƒ¼ãƒ³å‡¦ç†ãƒ«ãƒ¼ãƒ— (æœ€å¤§100ã‚¿ãƒ¼ãƒ³)    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. è¡Œå‹•é †æ±ºå®š                 â”‚ â”‚
â”‚ â”‚ 2. æ”»æ’ƒã‚¿ã‚¤ãƒ—é¸æŠž (ç‰©ç†/é­”æ³•)  â”‚ â”‚
â”‚ â”‚ 3. ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—               â”‚ â”‚
â”‚ â”‚ 4. ç‰¹æ®ŠåŠ¹æžœåˆ¤å®š               â”‚ â”‚
â”‚ â”‚    - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« (5-35%)     â”‚ â”‚
â”‚ â”‚    - ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ (15-30%)  â”‚ â”‚
â”‚ â”‚    - å›žé¿ (é€Ÿã•ãƒ»é‹ä¾å­˜)      â”‚ â”‚
â”‚ â”‚ 5. HPæ›´æ–°                     â”‚ â”‚
â”‚ â”‚ 6. ç”»é¢æç”»                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                         â”‚
â”‚   [HP â‰¤ 0 or ã‚¿ãƒ¼ãƒ³ä¸Šé™?]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒãƒˆãƒ«çµæžœå‡¦ç†                     â”‚
â”‚ - å‹æ•—åˆ¤å®š                         â”‚
â”‚ - çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¨ˆç®—                   â”‚
â”‚ - æˆ¦ç¸¾æ›´æ–° (Wins/Losses/Draws)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿ä¿å­˜                         â”‚
â”‚ - BattleHistoryã‚·ãƒ¼ãƒˆ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³) â”‚
â”‚ - Rankingsã‚·ãƒ¼ãƒˆæ›´æ–°               â”‚
â”‚ - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆ¦ç¸¾æ›´æ–°              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1.5 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

### 1.5.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
OekakiBattler/
â”œâ”€â”€ main.py                     # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ img2txt.py                  # ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç”»åƒè§£æžãƒ„ãƒ¼ãƒ«
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py            # ç’°å¢ƒå¤‰æ•°ãƒ»å®šæ•°ç®¡ç†
â”‚   â””â”€â”€ database.py            # SQLAlchemyè¨­å®š
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/                # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« (Pydantic)
â”‚   â”‚   â”œâ”€â”€ character.py
â”‚   â”‚   â”œâ”€â”€ battle.py
â”‚   â”‚   â”œâ”€â”€ story_boss.py
â”‚   â”‚   â””â”€â”€ story_progress.py
â”‚   â”œâ”€â”€ services/              # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ ai_analyzer.py
â”‚   â”‚   â”œâ”€â”€ image_processor.py
â”‚   â”‚   â”œâ”€â”€ battle_engine.py
â”‚   â”‚   â”œâ”€â”€ story_mode_engine.py
â”‚   â”‚   â”œâ”€â”€ endless_battle_engine.py
â”‚   â”‚   â”œâ”€â”€ sheets_manager.py
â”‚   â”‚   â”œâ”€â”€ database_manager.py
â”‚   â”‚   â”œâ”€â”€ audio_manager.py
â”‚   â”‚   â””â”€â”€ settings_manager.py
â”‚   â”œâ”€â”€ ui/                    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ main_menu.py
â”‚   â”‚   â””â”€â”€ story_boss_manager.py
â”‚   â””â”€â”€ utils/                 # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ image_utils.py
â”‚       â””â”€â”€ file_utils.py
â”œâ”€â”€ server/                    # LINE Bot (Node.js)
â”‚   â”œâ”€â”€ server.js
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ assets/                    # ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ images/               # èƒŒæ™¯ç”»åƒãƒ»UIç´ æ
â”‚   â””â”€â”€ sounds/               # åŠ¹æžœéŸ³
â”œâ”€â”€ data/                      # ãƒ‡ãƒ¼ã‚¿ä¿å­˜å…ˆ
â”‚   â”œâ”€â”€ database.db           # SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ characters/           # ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒ
â”‚   â””â”€â”€ sprites/              # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒ
â”œâ”€â”€ tests/                     # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
â””â”€â”€ docs/                      # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    â””â”€â”€ manual/               # ã‚·ã‚¹ãƒ†ãƒ ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«
```

### 1.5.2 ä¸»è¦ã‚¯ãƒ©ã‚¹é–¢ä¿‚å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MainMenu      â”‚ (Tkinter GUI)
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ has-a
        â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    â”‚ SheetsManager    â”‚ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    â”‚ DatabaseManager  â”‚ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    â”‚ AIAnalyzer       â”‚
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    â”‚ ImageProcessor   â”‚
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ BattleEngine     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ uses
                      â”œâ”€â”€â†’ Character (model)
                      â””â”€â”€â†’ Battle (model)
```

---

## 1.6 å‹•ä½œãƒ¢ãƒ¼ãƒ‰

### 1.6.1 ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰

**æ¡ä»¶:**
- `credentials.json` ãŒå­˜åœ¨
- Google Sheets API ãŒæœ‰åŠ¹
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå…±æœ‰ã•ã‚Œã¦ã„ã‚‹
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã‚ã‚Š

**æ©Ÿèƒ½:**
- âœ… Google Sheetsã§ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- âœ… Google Driveã«ç”»åƒä¿å­˜
- âœ… ãƒãƒˆãƒ«å±¥æ­´è¨˜éŒ²
- âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è‡ªå‹•æ›´æ–°
- âœ… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é€²è¡ŒçŠ¶æ³ä¿å­˜
- âœ… è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§ãƒ‡ãƒ¼ã‚¿å…±æœ‰å¯èƒ½

### 1.6.2 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰

**æ¡ä»¶:**
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰è¦ä»¶ãŒæº€ãŸã•ã‚Œãªã„å ´åˆã«è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**æ©Ÿèƒ½:**
- âœ… SQLiteã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ç”»åƒä¿å­˜
- âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²ãƒ»ãƒãƒˆãƒ«å®Ÿè¡Œå¯èƒ½
- âŒ ãƒãƒˆãƒ«å±¥æ­´è¨˜éŒ²ãªã—
- âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãªã—
- âŒ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é€²è¡ŒçŠ¶æ³ä¿å­˜ãªã—
- âŒ ãƒ‡ãƒã‚¤ã‚¹é–“ãƒ‡ãƒ¼ã‚¿å…±æœ‰ä¸å¯

### 1.6.3 ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```python
# config/settings.py ã¾ãŸã¯ SheetsManager.__init__
try:
    credentials = service_account.Credentials.from_service_account_file(
        GOOGLE_CREDENTIALS_PATH,
        scopes=SCOPES
    )
    self.client = gspread.authorize(credentials)
    self.sheet = self.client.open_by_key(SPREADSHEET_ID)
    self.online_mode = True
except Exception:
    self.online_mode = False
    # SQLiteãƒ¢ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
```

---

## 1.7 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1.7.1 æ©Ÿå¯†æƒ…å ±ç®¡ç†

ðŸ”’ **ç’°å¢ƒå¤‰æ•°ã§ç®¡ç† (`.env`)**
```bash
GOOGLE_API_KEY=xxxxx          # Google Gemini AI
SPREADSHEET_ID=xxxxx
GOOGLE_CREDENTIALS_PATH=credentials.json
```

ðŸ”’ **Gité™¤å¤–è¨­å®š (`.gitignore`)**
```
.env
server/.env
credentials.json
*.db
```

### 1.7.2 API ã‚­ãƒ¼ä¿è­·

- âš ï¸ Google API ã‚­ãƒ¼ã¯æœ¬ç•ªç’°å¢ƒã§ã¯ IP åˆ¶é™ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã‚’è¨­å®š
- âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™ã¯æœ€å°é™ã«åˆ¶é™
- âš ï¸ LINE Bot ã®ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯å¿…ãšç’°å¢ƒå¤‰æ•°ã§ç®¡ç†

### 1.7.3 ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

- Google Sheets: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç·¨é›†æ¨©é™ã‚’ä»˜ä¸Ž
- Google Drive: ãƒ•ã‚©ãƒ«ãƒ€å…±æœ‰è¨­å®šã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- SQLite: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®æ¨©é™ã«ä¾å­˜

---

## 1.8 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç‰¹æ€§

### 1.8.1 å‡¦ç†æ™‚é–“ç›®å®‰

| å‡¦ç† | æ‰€è¦æ™‚é–“ | å‚™è€ƒ |
|------|---------|------|
| ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ² (AIè§£æžå«ã‚€) | 5-15ç§’ | Google Gemini APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã«ä¾å­˜ |
| ç”»åƒå‡¦ç† (èƒŒæ™¯é™¤åŽ»ãƒ»ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º) | 2-5ç§’ | ç”»åƒã‚µã‚¤ã‚ºã«ä¾å­˜ |
| ãƒãƒˆãƒ«1ã‚¿ãƒ¼ãƒ³æç”» | 0.1-2.0ç§’ | è¨­å®šã§èª¿æ•´å¯èƒ½ |
| å®Œå…¨ãƒãƒˆãƒ« (å¹³å‡30ã‚¿ãƒ¼ãƒ³) | 3-60ç§’ | ãƒãƒˆãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰è¨­å®šã«ä¾å­˜ |
| Google Sheetsæ›¸ãè¾¼ã¿ | 1-3ç§’ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€Ÿåº¦ã«ä¾å­˜ |
| Google Driveç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | 2-10ç§’ | ç”»åƒã‚µã‚¤ã‚ºãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€Ÿåº¦ã«ä¾å­˜ |

### 1.8.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥:**
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã›ãšã€éƒ½åº¦Drive URLã‹ã‚‰å–å¾—
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å…ˆ: `data/sprites/{character_id}_sprite.png`

**ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥:**
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã¯ãƒ¡ãƒ¢ãƒªä¸Šã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (GUIã§ä¿æŒ)
- ãƒãƒˆãƒ«å®Ÿè¡Œæ™‚ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—

### 1.8.3 API ãƒ¬ãƒ¼ãƒˆåˆ¶é™

| API | åˆ¶é™ | å¯¾ç­– |
|-----|------|------|
| Google Sheets API | 100 requests/100 seconds/user | ãƒãƒƒãƒæ›´æ–°ã®å®Ÿè£… |
| Google Drive API | 1000 requests/100 seconds/user | ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨ |
| Google Gemini API | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã‚‹ | ãƒªãƒˆãƒ©ã‚¤å‡¦ç†å®Ÿè£… |

---

## 1.9 åˆ¶ç´„äº‹é …

### 1.9.1 ã‚·ã‚¹ãƒ†ãƒ åˆ¶ç´„

| é …ç›® | åˆ¶ç´„ | ç†ç”± |
|------|------|------|
| ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æœ€å¤§350 | ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ |
| ãƒœã‚¹ç·ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æœ€å¤§500 | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚ˆã‚Šå¼·åŠ› |
| ãƒãƒˆãƒ«æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•° | 100ã‚¿ãƒ¼ãƒ³ | ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ |
| ç”»åƒãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ | PNG, JPG, JPEG | Pillowã‚µãƒãƒ¼ãƒˆå½¢å¼ |
| ç”»åƒæœ€å¤§ã‚µã‚¤ã‚º | åˆ¶é™ãªã— (æŽ¨å¥¨: 10MBä»¥ä¸‹) | APIåˆ¶é™ãƒ»å‡¦ç†æ™‚é–“è€ƒæ…® |

### 1.9.2 æ©Ÿèƒ½åˆ¶ç´„

**ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰:**
- âŒ ãƒãƒˆãƒ«å±¥æ­´ä¿å­˜ä¸å¯
- âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãªã—
- âŒ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é€²è¡ŒçŠ¶æ³ä¿å­˜ãªã—

**LINE Bot:**
- âœ… ç”»åƒé€ä¿¡ã®ã¿ã‚µãƒãƒ¼ãƒˆ
- âŒ ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒžãƒ³ãƒ‰ã¯æœªå®Ÿè£…
- âŒ ãƒãƒˆãƒ«å®Ÿè¡Œã¯æœªå®Ÿè£…

---

## 1.10 å°†æ¥çš„ãªæ‹¡å¼µæ€§

### 1.10.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸Šã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

**Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŒ–:**
- UIãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’Flask/FastAPI + Reactã«ç½®ãæ›ãˆ
- Services/Modelsãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãã®ã¾ã¾æµç”¨å¯èƒ½

**ãƒžãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œ:**
- WebSocketå°Žå…¥ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒˆãƒ«
- Redisã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

**ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªåŒ–:**
- REST APIå®Ÿè£…
- React Native/Flutterã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

### 1.10.2 æ©Ÿèƒ½æ‹¡å¼µå€™è£œ

- [ ] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†æ©Ÿèƒ½
- [ ] ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ–ãƒ©ã‚±ãƒƒãƒˆè¡¨ç¤º
- [ ] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚·ã‚¹ãƒ†ãƒ 
- [ ] é«˜åº¦ãªAIãƒ¢ãƒ‡ãƒ« (GPT-4V, Claude Vision)
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¦³æˆ¦æ©Ÿèƒ½
- [ ] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒžãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [02_INSTALLATION.md](02_INSTALLATION.md) ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 02. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

## 2.1 ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

### 2.1.1 ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è¦ä»¶

| é …ç›® | æœ€å°è¦ä»¶ | æŽ¨å¥¨è¦ä»¶ |
|------|---------|---------|
| CPU | 2ã‚³ã‚¢ 2GHz | 4ã‚³ã‚¢ 3GHzä»¥ä¸Š |
| ãƒ¡ãƒ¢ãƒª | 4GB RAM | 8GB RAMä»¥ä¸Š |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | 2GBç©ºãå®¹é‡ | 10GBç©ºãå®¹é‡ |
| ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ | 1024x768 | 1920x1080ä»¥ä¸Š |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | - | å®‰å®šã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶š (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨) |

### 2.1.2 ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¦ä»¶

**å¿…é ˆ:**
- Python 3.11 ä»¥ä¸Š
- pip (Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼)

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ (LINE Botä½¿ç”¨æ™‚):**
- Node.js 14 ä»¥ä¸Š
- npm
- ngrok

### 2.1.3 å¯¾å¿œOS

| OS | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ |
|----|-----------|------|
| Windows | 10, 11 | âœ… å®Œå…¨å¯¾å¿œ |
| macOS | 10.15 (Catalina) ä»¥ä¸Š | âœ… å®Œå…¨å¯¾å¿œ |
| Linux (Ubuntu) | 20.04 LTS ä»¥ä¸Š | âœ… å®Œå…¨å¯¾å¿œ |
| Linux (Debian) | 11 ä»¥ä¸Š | âœ… å®Œå…¨å¯¾å¿œ |

---

## 2.2 Pythonã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### 2.2.1 Windows

**æ–¹æ³•1: å…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ (æŽ¨å¥¨)**
```powershell
# 1. https://www.python.org/downloads/ ã‹ã‚‰æœ€æ–°ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
# 2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œæ™‚ã« "Add Python to PATH" ã‚’ãƒã‚§ãƒƒã‚¯
# 3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†å¾Œã€ç¢ºèª:
python --version
# Python 3.11.x ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°OK
```

**æ–¹æ³•2: Microsoft Store**
```powershell
# Microsoft Storeã‹ã‚‰Python 3.11ã‚’æ¤œç´¢ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
python --version
```

### 2.2.2 macOS

**æ–¹æ³•1: Homebrew (æŽ¨å¥¨)**
```bash
# HomebrewãŒãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Python 3.11ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install python@3.11

# ç¢ºèª
python3.11 --version
```

**æ–¹æ³•2: å…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼**
```bash
# https://www.python.org/downloads/macos/ ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œ
python3 --version
```

### 2.2.3 Linux (Ubuntu/Debian)

```bash
# ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°
sudo apt-get update

# Python 3.11ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt-get install -y \
    python3.11 \
    python3.11-venv \
    python3.11-dev \
    python3-pip

# ç¢ºèª
python3.11 --version
```

---

## 2.3 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 2.3.1 ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

```bash
# GitHubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ)
git clone https://github.com/your-username/OekakiBattler.git
cd OekakiBattler

# ã¾ãŸã¯ã€ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã—ã¦cd
cd OekakiBattler
```

### 2.3.2 ä»®æƒ³ç’°å¢ƒã®ä½œæˆã¨æœ‰åŠ¹åŒ–

**Windows:**
```powershell
# ä»®æƒ³ç’°å¢ƒä½œæˆ
python -m venv .venv

# æœ‰åŠ¹åŒ–
.venv\Scripts\activate

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒ (.venv) ã§å§‹ã¾ã‚Œã°OK
```

**macOS/Linux:**
```bash
# ä»®æƒ³ç’°å¢ƒä½œæˆ
python3.11 -m venv .venv

# æœ‰åŠ¹åŒ–
source .venv/bin/activate

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒ (.venv) ã§å§‹ã¾ã‚Œã°OK
```

### 2.3.3 ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# pip ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°
pip install --upgrade pip

# å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
pip list
```

**ä¸»è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:**
```
pygame>=2.5.0
Pillow>=10.0.0
opencv-python>=4.8.0
google-generativeai>=0.3.0
gspread>=5.10.0
google-auth>=2.22.0
google-api-python-client>=2.95.0
pydantic>=2.0.0
python-dotenv>=1.0.0
SQLAlchemy>=2.0.0
```

---

## 2.4 ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥è¿½åŠ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 2.4.1 Windows

**Tkinterç¢ºèª:**
```python
# Pythonã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ã§å®Ÿè¡Œ
import tkinter
tkinter._test()
# å°ã•ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK
```

**Visual C++ å†é ’å¸ƒå¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (ä¸€éƒ¨ä¾å­˜é–¢ä¿‚ã«å¿…è¦):**
- https://aka.ms/vs/17/release/vc_redist.x64.exe ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### 2.4.2 macOS

**Xcode Command Line Tools:**
```bash
xcode-select --install
```

**Tkinterç¢ºèª:**
```bash
python3.11 -m tkinter
# å°ã•ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK
```

### 2.4.3 Linux (Ubuntu/Debian)

**ã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:**
```bash
sudo apt-get install -y \
    python3-tk \
    libgl1-mesa-glx \
    libglib2.0-0 \
    fonts-noto-cjk \
    fonts-takao-gothic
```

**Tkinterç¢ºèª:**
```bash
python3.11 -m tkinter
# å°ã•ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK
```

---

## 2.5 ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

### 2.5.1 `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ:

```bash
# .env.example ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç·¨é›†
cp .env.example .env

# ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ã
nano .env  # ã¾ãŸã¯ vim, code ç­‰
```

### 2.5.2 å¿…é ˆç’°å¢ƒå¤‰æ•°

```bash
# Google Generative AI (å¿…é ˆ)
GOOGLE_API_KEY=your_google_api_key_here
MODEL_NAME=gemini-2.5-flash-lite-preview-06-17

# Google Sheets (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨)
SPREADSHEET_ID=your_spreadsheet_id_here
WORKSHEET_NAME=Characters
BATTLE_HISTORY_SHEET=BattleHistory
RANKING_SHEET=Rankings
GOOGLE_CREDENTIALS_PATH=credentials.json

# Google Drive (ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ç‰¹å®šãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ãŸã„å ´åˆ)
DRIVE_FOLDER_ID=your_drive_folder_id_here
```

### 2.5.3 ç’°å¢ƒå¤‰æ•°ã®èª¬æ˜Ž

| å¤‰æ•°å | èª¬æ˜Ž | å–å¾—æ–¹æ³• |
|--------|------|---------|
| `GOOGLE_API_KEY` | Google Gemini AI APIã‚­ãƒ¼ | [2.6.1](#261-google-gemini-ai-api) å‚ç…§ |
| `MODEL_NAME` | ä½¿ç”¨ã™ã‚‹Geminiãƒ¢ãƒ‡ãƒ« | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨æŽ¨å¥¨ |
| `SPREADSHEET_ID` | Google Sheetsã®ID | [2.6.2](#262-google-sheets-api) å‚ç…§ |
| `WORKSHEET_NAME` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆå | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `Characters` |
| `BATTLE_HISTORY_SHEET` | ãƒãƒˆãƒ«å±¥æ­´ã‚·ãƒ¼ãƒˆå | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `BattleHistory` |
| `RANKING_SHEET` | ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ãƒ¼ãƒˆå | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `Rankings` |
| `GOOGLE_CREDENTIALS_PATH` | ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSON | [2.6.2](#262-google-sheets-api) å‚ç…§ |
| `DRIVE_FOLDER_ID` | Driveãƒ•ã‚©ãƒ«ãƒ€ID (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) | [2.6.3](#263-google-drive-api) å‚ç…§ |

---

## 2.6 Google APIè¨­å®š

### 2.6.1 Google Gemini AI API

**1. Google AI Studioã«ã‚¢ã‚¯ã‚»ã‚¹:**
- https://makersuite.google.com/app/apikey

**2. APIã‚­ãƒ¼ã‚’ä½œæˆ:**
- "Get API Key" ã¾ãŸã¯ "APIã‚­ãƒ¼ã‚’ä½œæˆ" ã‚’ã‚¯ãƒªãƒƒã‚¯
- æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã€ã¾ãŸã¯æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠž
- APIã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã‚‹ (ä¾‹: `AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`)

**3. `.env` ã«è¨­å®š:**
```bash
GOOGLE_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

**âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„:**
- APIã‚­ãƒ¼ã¯çµ¶å¯¾ã«Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
- æœ¬ç•ªç’°å¢ƒã§ã¯IPåˆ¶é™ã‚’è¨­å®š
- å®šæœŸçš„ã«ã‚­ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

### 2.6.2 Google Sheets API

**1. Google Cloud Consoleã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ:**
- https://console.cloud.google.com/
- æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ (ä¾‹: "OekakiBattler")

**2. å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–:**
```
Google Sheets API
Google Drive API
```
- ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã‹ã‚‰æ¤œç´¢ã—ã¦æœ‰åŠ¹åŒ–

**3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ:**
- ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œèªè¨¼æƒ…å ±ã€â†’ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€â†’ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå: `oekaki-battler-service`
- å½¹å‰²: `ç·¨é›†è€…` (Editor)

**4. JSONã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:**
- ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
- ã€Œã‚­ãƒ¼ã€ã‚¿ãƒ–â†’ã€Œéµã‚’è¿½åŠ ã€â†’ã€Œæ–°ã—ã„éµã‚’ä½œæˆã€
- å½¢å¼: JSON
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `credentials.json` ã¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«é…ç½®

**5. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆãƒ»å…±æœ‰:**
```bash
# 1. Google Sheetsã§æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
# 2. URLã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å–å¾—
#    ä¾‹: https://docs.google.com/spreadsheets/d/1AbC123XyZ.../edit
#    â†’ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID = 1AbC123XyZ...
# 3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (credentials.jsonã® "client_email") ã¨å…±æœ‰
#    æ¨©é™: ç·¨é›†è€…
```

**6. `.env` ã«è¨­å®š:**
```bash
SPREADSHEET_ID=1AbC123XyZ...
GOOGLE_CREDENTIALS_PATH=credentials.json
```

### 2.6.3 Google Drive API

**å‰æ:** Google Sheets APIè¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ (2.6.2)

**1. Drive APIã‚’æœ‰åŠ¹åŒ–:**
- Google Cloud Consoleã§ã€ŒGoogle Drive APIã€ã‚’æœ‰åŠ¹åŒ– (2.6.2ã§å®Ÿæ–½æ¸ˆã¿)

**2. ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³):**
```bash
# 1. Google Driveã§æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ (ä¾‹: "OekakiBattler_Images")
# 2. URLã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å–å¾—
#    ä¾‹: https://drive.google.com/drive/folders/1XyZ987AbC...
#    â†’ ãƒ•ã‚©ãƒ«ãƒ€ID = 1XyZ987AbC...
# 3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…±æœ‰ (ç·¨é›†è€…æ¨©é™)
```

**3. `.env` ã«è¨­å®š (ã‚ªãƒ—ã‚·ãƒ§ãƒ³):**
```bash
DRIVE_FOLDER_ID=1XyZ987AbC...
```

ðŸ’¡ **ãƒ’ãƒ³ãƒˆ:** `DRIVE_FOLDER_ID` ã‚’è¨­å®šã—ãªã„å ´åˆã€ç”»åƒã¯ãƒžã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ«ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

---

## 2.7 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–

### 2.7.1 Google Sheets (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆå›žèµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã™:

**ä½œæˆã•ã‚Œã‚‹ã‚·ãƒ¼ãƒˆ:**
1. `Characters` (15åˆ—) - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
2. `BattleHistory` (15åˆ—) - ãƒãƒˆãƒ«å±¥æ­´
3. `Rankings` (10åˆ—) - ãƒ©ãƒ³ã‚­ãƒ³ã‚°
4. `StoryBosses` (11åˆ—) - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿
5. `StoryProgress` (6åˆ—) - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡ŒçŠ¶æ³

**æ‰‹å‹•ã§ä½œæˆã™ã‚‹å ´åˆ:**
```bash
python -c "from src.services.sheets_manager import SheetsManager; SheetsManager().initialize_sheets()"
```

### 2.7.2 SQLite (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

åˆå›žèµ·å‹•æ™‚ã«è‡ªå‹•çš„ã« `data/database.db` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

**æ‰‹å‹•ã§ä½œæˆã™ã‚‹å ´åˆ:**
```bash
python -c "from config.database import init_db; init_db()"
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèª:**
```bash
sqlite3 data/database.db
.schema characters
.schema battles
.exit
```

---

## 2.8 LINE Bot ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

### 2.8.1 Node.js ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**Windows:**
- https://nodejs.org/ ã‹ã‚‰ LTSç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**macOS:**
```bash
brew install node
```

**Linux:**
```bash
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**ç¢ºèª:**
```bash
node --version  # v14.x ä»¥ä¸Š
npm --version   # 6.x ä»¥ä¸Š
```

### 2.8.2 LINE Developersã§ãƒãƒ£ãƒãƒ«ä½œæˆ

**1. LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹:**
- https://developers.line.biz/console/

**2. æ–°è¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä½œæˆ:**
- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å: ä»»æ„ (ä¾‹: "OekakiBattler")

**3. Messaging APIãƒãƒ£ãƒãƒ«ä½œæˆ:**
- ãƒãƒ£ãƒãƒ«å: ä»»æ„ (ä¾‹: "ãŠçµµæããƒãƒˆãƒ©ãƒ¼")
- ãƒãƒ£ãƒãƒ«èª¬æ˜Ž: ä»»æ„
- æ¥­ç¨®: ä»»æ„
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: è‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

**4. å¿…è¦ãªæƒ…å ±ã‚’å–å¾—:**
```
ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ: [åŸºæœ¬è¨­å®š] ã‚¿ãƒ–
ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: [Messaging APIè¨­å®š] ã‚¿ãƒ– â†’ [ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ (é•·æœŸ)] ç™ºè¡Œ
```

### 2.8.3 ngrok ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:**
- https://ngrok.com/download

**ã¾ãŸã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼:**
```bash
# macOS
brew install ngrok

# Linux
snap install ngrok

# Windows
choco install ngrok
```

**èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š:**
```bash
# ngrokã«ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
ngrok authtoken YOUR_AUTH_TOKEN
```

### 2.8.4 LINE Bot ã‚µãƒ¼ãƒãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

**1. ã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:**
```bash
cd server
```

**2. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:**
```bash
npm install
```

**3. `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ:**
```bash
# server/.env
PORT=3000
LINE_CHANNEL_SECRET=your_line_channel_secret
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
GAS_WEBHOOK_URL=https://script.google.com/macros/s/YOUR_GAS_ID/exec
SHARED_SECRET=your_shared_secret_for_gas_authentication
```

**4. Google Apps Script (GAS) ã®è¨­å®š:**

**GASã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤:**
```javascript
// Google Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã§ä»¥ä¸‹ã‚’ä½œæˆ
// è©³ç´°ã¯ 07_LINE_BOT.md å‚ç…§

function doPost(e) {
  // LINEã‹ã‚‰å—ä¿¡ã—ãŸç”»åƒã‚’Driveã«ä¿å­˜
  // Sheetsã«è¨˜éŒ²
  // è©³ç´°å®Ÿè£…ã¯ 07_LINE_BOT.md
}
```

**5. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:**

**Windows (`server_up.bat`):**
```batch
@echo off
cd server
start ngrok http 3000
timeout /t 5
node server.js
```

**macOS/Linux (`server_up.sh`):**
```bash
#!/bin/bash
cd server
ngrok http 3000 &
sleep 5
node server.js
```

**6. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•:**
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§
./server_up.sh  # macOS/Linux
# ã¾ãŸã¯
server_up.bat   # Windows
```

**7. Webhook URLã®è¨­å®š:**
```bash
# ngrokãŒè¡¨ç¤ºã™ã‚‹HTTPS URL (ä¾‹: https://xxxx-xx-xx-xxx-xxx.ngrok.io)
# LINE Developers Console â†’ Messaging APIè¨­å®š â†’ Webhook URL ã«è¨­å®š
# ä¾‹: https://xxxx-xx-xx-xxx-xxx.ngrok.io/webhook
```

---

## 2.9 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª

### 2.9.1 åŸºæœ¬å‹•ä½œç¢ºèª

```bash
# ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–
source .venv/bin/activate  # macOS/Linux
# ã¾ãŸã¯
.venv\Scripts\activate     # Windows

# ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
python main.py
```

**ç¢ºèªé …ç›®:**
- âœ… Tkinterã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã«ã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã€ã¾ãŸã¯ã€Œã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã€Œã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½

### 2.9.2 Google APIæŽ¥ç¶šç¢ºèª

**ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç¢ºèª:**
```python
# Pythonã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ã§å®Ÿè¡Œ
from src.services.sheets_manager import SheetsManager

manager = SheetsManager()
print(f"Online Mode: {manager.online_mode}")
# True ãªã‚‰æˆåŠŸ

# ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
characters = manager.get_all_characters()
print(f"Characters: {len(characters)}")
```

**AIè§£æžç¢ºèª:**
```bash
# ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç”»åƒè§£æžãƒ„ãƒ¼ãƒ«ã§ç¢ºèª
python img2txt.py path/to/test_image.png
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK
```

### 2.9.3 LINE BotæŽ¥ç¶šç¢ºèª

**1. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•:**
```bash
./server_up.sh
```

**2. LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ¤œè¨¼:**
- Messaging APIè¨­å®š â†’ Webhookè¨­å®š â†’ æ¤œè¨¼ãƒœã‚¿ãƒ³
- "Success" ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°OK

**3. å®Ÿéš›ã«ç”»åƒé€ä¿¡:**
- LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç”»åƒã‚’é€ä¿¡
- Google Sheetsã«è¨˜éŒ²ã•ã‚Œã‚‹ã‹ç¢ºèª

---

## 2.10 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ‰‹é †

### 2.10.1 ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

```bash
# Gitã‹ã‚‰æœ€æ–°ç‰ˆã‚’å–å¾—
git pull origin main

# ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–
source .venv/bin/activate

# ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°
pip install --upgrade -r requirements.txt

# LINE Botã‚µãƒ¼ãƒãƒ¼æ›´æ–° (ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ)
cd server
npm install
cd ..
```

### 2.10.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**SQLite:**
```bash
# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚‹å ´åˆ
python scripts/migrate_db.py
```

**Google Sheets:**
- æ–°ã—ã„ã‚·ãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã€ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•ä½œæˆã•ã‚Œã¾ã™

### 2.10.3 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

```bash
# æ–°ã—ã„ç’°å¢ƒå¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆ
# .env.example ã¨è‡ªåˆ†ã® .env ã‚’æ¯”è¼ƒ
diff .env.example .env

# ä¸è¶³ã—ã¦ã„ã‚‹å¤‰æ•°ã‚’è¿½åŠ 
nano .env
```

---

## 2.11 ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### 2.11.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰Šé™¤

```bash
# 1. ä»®æƒ³ç’°å¢ƒã‚’ç„¡åŠ¹åŒ–
deactivate

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
cd ..
rm -rf OekakiBattler

# Windows:
# rmdir /s /q OekakiBattler
```

### 2.11.2 Google APIè¨­å®šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

**1. Google Cloud Console:**
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ (èª²é‡‘ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆ)
- ã¾ãŸã¯ã€APIã‚’ç„¡åŠ¹åŒ–

**2. Google Sheets:**
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤
- Google Driveã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤

**3. LINE Developers:**
- ãƒãƒ£ãƒãƒ«ã‚’å‰Šé™¤
- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å‰Šé™¤ (ä»–ã«ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆ)

### 2.11.3 ngrok ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
pkill ngrok  # macOS/Linux
taskkill /F /IM ngrok.exe  # Windows

# ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
brew uninstall ngrok  # macOS
snap remove ngrok     # Linux
choco uninstall ngrok # Windows
```

---

## 2.12 ã‚ˆãã‚ã‚‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å•é¡Œ

### 2.12.1 Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `Microsoft Visual C++ 14.0 is required`**
```powershell
# Windows: Visual Studio Build Toolsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# https://visualstudio.microsoft.com/visual-cpp-build-tools/
```

**ã‚¨ãƒ©ãƒ¼: `error: command 'gcc' failed`**
```bash
# Linux: ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt-get install build-essential python3-dev
```

### 2.12.2 Tkinter ãŒè¦‹ã¤ã‹ã‚‰ãªã„

**Linux:**
```bash
sudo apt-get install python3-tk
```

**macOS:**
```bash
# Homebrewã§å…¥ã‚ŒãŸPythonã«ã¯TkinterãŒå«ã¾ã‚Œã¦ã„ã¾ã™
# ã‚·ã‚¹ãƒ†ãƒ Pythonã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€Homebrewã§å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install python-tk@3.11
```

### 2.12.3 OpenCV ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `ImportError: libGL.so.1`**
```bash
# Linux
sudo apt-get install libgl1-mesa-glx libglib2.0-0
```

### 2.12.4 æ—¥æœ¬èªžãƒ•ã‚©ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„

**Linux:**
```bash
sudo apt-get install fonts-noto-cjk fonts-takao-gothic
```

**macOS/Windows:**
- ã‚·ã‚¹ãƒ†ãƒ ã«æ—¥æœ¬èªžãƒ•ã‚©ãƒ³ãƒˆãŒæ¨™æº–ã§å«ã¾ã‚Œã¦ã„ã¾ã™

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [03_CHARACTER_MANAGEMENT.md](03_CHARACTER_MANAGEMENT.md) ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 03. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†

## 3.1 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### 3.1.1 Character ã‚¯ãƒ©ã‚¹å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/models/character.py`

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional

class Character(BaseModel):
    id: str = Field(description="UUIDå½¢å¼ã®ä¸€æ„è­˜åˆ¥å­")
    name: str = Field(min_length=1, max_length=50, description="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å")
    image_path: str = Field(description="ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒã®ãƒ‘ã‚¹ã¾ãŸã¯URL")
    sprite_path: str = Field(description="ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒã®ãƒ‘ã‚¹ã¾ãŸã¯URL")

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (RPGé¢¨)
    hp: int = Field(ge=10, le=200, description="ä½“åŠ›")
    attack: int = Field(ge=10, le=150, description="æ”»æ’ƒåŠ›")
    defense: int = Field(ge=10, le=100, description="é˜²å¾¡åŠ›")
    speed: int = Field(ge=10, le=100, description="é€Ÿã•")
    magic: int = Field(ge=10, le=100, description="é­”åŠ›")
    luck: int = Field(ge=0, le=100, description="é‹")

    description: str = Field(description="AIç”Ÿæˆã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¬æ˜Ž")
    created_at: datetime = Field(default_factory=datetime.now)

    # æˆ¦ç¸¾
    wins: int = Field(default=0, ge=0)
    losses: int = Field(default=0, ge=0)
    draws: int = Field(default=0, ge=0)

    @property
    def total_stats(self) -> int:
        """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆè¨ˆå€¤ã‚’è¨ˆç®—"""
        return self.hp + self.attack + self.defense + self.speed + self.magic + self.luck

    @property
    def win_rate(self) -> float:
        """å‹çŽ‡ã‚’è¨ˆç®— (0.0-1.0)"""
        total = self.wins + self.losses + self.draws
        return self.wins / total if total > 0 else 0.0

    @property
    def rating(self) -> int:
        """ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨ˆç®— (WinsÃ—3 + Draws)"""
        return self.wins * 3 + self.draws
```

### 3.1.2 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¶ç´„

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æœ€å°å€¤ | æœ€å¤§å€¤ | èª¬æ˜Ž |
|-----------|--------|--------|------|
| HP | 10 | 200 | ä½“åŠ›ã€‚0ã«ãªã‚‹ã¨æ•—åŒ— |
| æ”»æ’ƒåŠ› (Attack) | 10 | 150 | ç‰©ç†æ”»æ’ƒãƒ»é­”æ³•æ”»æ’ƒã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã«å½±éŸ¿ |
| é˜²å¾¡åŠ› (Defense) | 10 | 100 | å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸› |
| é€Ÿã• (Speed) | 10 | 100 | è¡Œå‹•é †ãƒ»å›žé¿çŽ‡ã«å½±éŸ¿ |
| é­”åŠ› (Magic) | 10 | 100 | é­”æ³•æ”»æ’ƒã®ç™ºå‹•ç¢ºçŽ‡ã«å½±éŸ¿ |
| é‹ (Luck) | 0 | 100 | ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«çŽ‡ãƒ»ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯çŽ‡ãƒ»å›žé¿çŽ‡ã«å½±éŸ¿ |

**ç·åˆåˆ¶ç´„:**
- **åˆè¨ˆå€¤ä¸Šé™:** `HP + Attack + Defense + Speed + Magic + Luck â‰¤ 350`
- **ãƒãƒ©ãƒ³ã‚¹èª¿æ•´:** AIè§£æžæ™‚ã«è‡ªå‹•çš„ã«èª¿æ•´

### 3.1.3 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å½¹å‰²

**HP (ä½“åŠ›):**
- ãƒãƒˆãƒ«ä¸­ã®ãƒ€ãƒ¡ãƒ¼ã‚¸è“„ç©
- 0ä»¥ä¸‹ã«ãªã‚‹ã¨æ•—åŒ—

**Attack (æ”»æ’ƒåŠ›):**
- ç‰©ç†æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸ã®åŸºç¤Žå€¤
- é­”æ³•æ”»æ’ƒã«ã‚‚å½±éŸ¿

**Defense (é˜²å¾¡åŠ›):**
- å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›
- ç‰©ç†æ”»æ’ƒ: `damage = attack - defense`
- é­”æ³•æ”»æ’ƒ: `damage = attack - (defense * 0.5)`

**Speed (é€Ÿã•):**
- ã‚¿ãƒ¼ãƒ³è¡Œå‹•é †ã‚’æ±ºå®š (é€Ÿã„æ–¹ãŒå…ˆæ”»)
- å›žé¿çŽ‡ã«å½±éŸ¿: `evasion_bonus = speed / 500`

**Magic (é­”åŠ›):**
- é­”æ³•æ”»æ’ƒã®ç™ºå‹•ç¢ºçŽ‡: `magic_chance = magic / 200`
- é­”æ³•æ”»æ’ƒã¯é˜²å¾¡åŠ›ã‚’50%è²«é€š

**Luck (é‹):**
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«çŽ‡: `5% + (luck / 10)%` (æœ€å¤§35%)
- ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯çŽ‡: `15% + (luck / 20)%` (æœ€å¤§30%)
- é˜²å¾¡å´ã®é‹ã¯æ”»æ’ƒå´ã®å‘½ä¸­çŽ‡ã‚’ä¸‹ã’ã‚‹: æœ€å¤§-30%

---

## 3.2 ç”»åƒå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### 3.2.1 å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
[å…¥åŠ›ç”»åƒ] (PNG/JPG/JPEG)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”»åƒèª­ã¿è¾¼ã¿ (Pillow)              â”‚
â”‚    - ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæ¤œè¨¼                  â”‚
â”‚    - RGBAå¤‰æ›                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. èƒŒæ™¯é™¤åŽ» (OpenCV + Pillow)         â”‚
â”‚    - ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›                â”‚
â”‚    - äºŒå€¤åŒ– (é–¾å€¤: 240)                â”‚
â”‚    - è¼ªéƒ­æ¤œå‡º                          â”‚
â”‚    - ãƒžã‚¹ã‚¯ç”Ÿæˆ                        â”‚
â”‚    - ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«åˆæˆ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º                      â”‚
â”‚    - ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¨ˆç®—         â”‚
â”‚    - ä½™ç™½ãƒˆãƒªãƒŸãƒ³ã‚° (10pxãƒžãƒ¼ã‚¸ãƒ³)      â”‚
â”‚    - ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ãƒªã‚µã‚¤ã‚ºãƒ»æœ€é©åŒ–                    â”‚
â”‚    - æœ€å¤§ã‚µã‚¤ã‚º: 300x300px            â”‚
â”‚    - ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹é©ç”¨               â”‚
â”‚    - PNGåœ§ç¸®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
[å‡ºåŠ›ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ] (é€éŽPNG)
```

### 3.2.2 ImageProcessor ã‚¯ãƒ©ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/image_processor.py`

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:**

```python
class ImageProcessor:
    def __init__(self):
        self.max_sprite_size = (300, 300)
        self.background_threshold = 240

    def remove_background(self, image_path: str, output_path: str) -> str:
        """èƒŒæ™¯ã‚’é™¤åŽ»ã—ã¦é€éŽPNGã‚’ç”Ÿæˆ"""

    def extract_sprite(self, image_path: str, output_path: str) -> str:
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’æŠ½å‡º"""

    def process_character_image(self,
                                 original_path: str,
                                 character_id: str) -> tuple[str, str]:
        """ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒã‹ã‚‰ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆ

        Returns:
            (original_save_path, sprite_save_path)
        """
```

### 3.2.3 èƒŒæ™¯é™¤åŽ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**æ‰‹æ³•:** ç™½èƒŒæ™¯æ¤œå‡º + ãƒžã‚¹ã‚¯ç”Ÿæˆ

```python
import cv2
import numpy as np
from PIL import Image

def remove_background(image_path: str, threshold: int = 240) -> Image:
    # 1. ç”»åƒèª­ã¿è¾¼ã¿
    img = Image.open(image_path).convert("RGBA")
    img_array = np.array(img)

    # 2. ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
    gray = cv2.cvtColor(img_array, cv2.COLOR_RGBA2GRAY)

    # 3. äºŒå€¤åŒ– (ç™½èƒŒæ™¯ã‚’æ¤œå‡º)
    _, binary = cv2.threshold(gray, threshold, 255, cv2.THRESH_BINARY)

    # 4. ãƒžã‚¹ã‚¯åè»¢ (ç™½èƒŒæ™¯ã‚’é€æ˜Žã«)
    mask = cv2.bitwise_not(binary)

    # 5. ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ã«é©ç”¨
    img_array[:, :, 3] = mask

    return Image.fromarray(img_array)
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´:**
- `threshold`: èƒŒæ™¯åˆ¤å®šã®é–¾å€¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 240)
  - é«˜ã„å€¤ (250-255): ã‚ˆã‚Šç™½ã„éƒ¨åˆ†ã®ã¿é™¤åŽ»
  - ä½Žã„å€¤ (200-239): è–„ã„ã‚°ãƒ¬ãƒ¼ã‚‚é™¤åŽ»

### 3.2.4 ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**æ‰‹æ³•:** è¼ªéƒ­æ¤œå‡º + ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹

```python
def extract_sprite(image: Image) -> Image:
    # 1. ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰è¼ªéƒ­æ¤œå‡º
    alpha = np.array(image.split()[-1])
    contours, _ = cv2.findContours(alpha, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # 2. æœ€å¤§ã®è¼ªéƒ­ã‚’å–å¾—
    if not contours:
        return image
    largest_contour = max(contours, key=cv2.contourArea)

    # 3. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¨ˆç®—
    x, y, w, h = cv2.boundingRect(largest_contour)

    # 4. ãƒžãƒ¼ã‚¸ãƒ³è¿½åŠ 
    margin = 10
    x = max(0, x - margin)
    y = max(0, y - margin)
    w = min(image.width - x, w + margin * 2)
    h = min(image.height - y, h + margin * 2)

    # 5. ã‚¯ãƒ­ãƒƒãƒ—
    return image.crop((x, y, x + w, y + h))
```

### 3.2.5 ãƒªã‚µã‚¤ã‚ºå‡¦ç†

**ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒãƒªã‚µã‚¤ã‚º:**

```python
def resize_sprite(image: Image, max_size: tuple = (300, 300)) -> Image:
    # ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ãƒªã‚µã‚¤ã‚º
    image.thumbnail(max_size, Image.Resampling.LANCZOS)
    return image
```

**æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³:**
- **ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:** `LANCZOS` (é«˜å“è³ª)
- **PNGæœ€é©åŒ–:** `optimize=True`
- **åœ§ç¸®ãƒ¬ãƒ™ãƒ«:** `compress_level=9`

---

## 3.3 AIè§£æžã‚·ã‚¹ãƒ†ãƒ 

### 3.3.1 Google Gemini çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/ai_analyzer.py`

**ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:** `gemini-2.5-flash-lite-preview-06-17` (è¨­å®šã§å¤‰æ›´å¯èƒ½)

```python
import google.generativeai as genai
from PIL import Image

class AIAnalyzer:
    def __init__(self):
        genai.configure(api_key=GOOGLE_API_KEY)
        self.model = genai.GenerativeModel(MODEL_NAME)

    def analyze_character(self, image_path: str) -> dict:
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’è§£æžã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç”Ÿæˆ"""
```

### 3.3.2 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ

**ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:**

```text
ã‚ãªãŸã¯RPGã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç”Ÿæˆã™ã‚‹AIã§ã™ã€‚
æä¾›ã•ã‚ŒãŸæ‰‹æãã‚¤ãƒ©ã‚¹ãƒˆã‹ã‚‰ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆãƒ«ãƒ¼ãƒ«ã€‘
1. HP (ä½“åŠ›): 10-200
   - å¤§æŸ„ãƒ»é ‘ä¸ˆãã† â†’ é«˜ã‚
   - å°æŸ„ãƒ»è¯å¥¢ â†’ ä½Žã‚

2. Attack (æ”»æ’ƒåŠ›): 10-150
   - æ­¦å™¨ã‚’æŒã£ã¦ã„ã‚‹ â†’ é«˜ã‚
   - ç­‹è‚‰è³ªãƒ»æˆ¦é—˜çš„ â†’ é«˜ã‚
   - éžæˆ¦é—˜çš„ãƒ»å¹³å’Œçš„ â†’ ä½Žã‚

3. Defense (é˜²å¾¡åŠ›): 10-100
   - éŽ§ãƒ»é˜²å…·ã‚ã‚Š â†’ é«˜ã‚
   - éœ²å‡ºãŒå¤šã„ â†’ ä½Žã‚
   - ç¡¬ãã†ãªè¦‹ãŸç›® â†’ é«˜ã‚

4. Speed (é€Ÿã•): 10-100
   - ã‚¹ãƒªãƒ ãªä½“åž‹ â†’ é«˜ã‚
   - è»½è£… â†’ é«˜ã‚
   - é‡è£…å‚™ â†’ ä½Žã‚
   - é£›è¡Œå¯èƒ½ãã† â†’ é«˜ã‚

5. Magic (é­”åŠ›): 10-100
   - é­”æ³•ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒ»æ– â†’ é«˜ã‚
   - ç¥žç§˜çš„ãªè¦‹ãŸç›® â†’ é«˜ã‚
   - ç‰©ç†çš„ãªæ­¦å™¨ã®ã¿ â†’ ä½Žã‚

6. Luck (é‹): 0-100
   - å¹¸é‹ãã†ãƒ»æ˜Žã‚‹ã„ â†’ é«˜ã‚
   - ä¸é‹ãã†ãƒ»æš—ã„ â†’ ä½Žã‚

ã€é‡è¦ãªåˆ¶ç´„ã€‘
- åˆè¨ˆå€¤ã¯å¿…ãš350ä»¥ä¸‹ã«ã™ã‚‹ã“ã¨
- å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ä¸Šè¨˜ç¯„å›²å†…ã«ã™ã‚‹ã“ã¨
- ãƒãƒ©ãƒ³ã‚¹ã‚ˆãé…åˆ†ã™ã‚‹ã“ã¨

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§ä»¥ä¸‹ã‚’å‡ºåŠ›:
{
  "hp": æ•°å€¤,
  "attack": æ•°å€¤,
  "defense": æ•°å€¤,
  "speed": æ•°å€¤,
  "magic": æ•°å€¤,
  "luck": æ•°å€¤,
  "description": "æ—¥æœ¬èªžã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®èª¬æ˜Ž (2-3æ–‡)"
}
```

### 3.3.3 ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

```python
def analyze_character(self, image_path: str) -> dict:
    # 1. ç”»åƒèª­ã¿è¾¼ã¿
    img = Image.open(image_path)

    # 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    prompt = self._build_prompt()

    # 3. Gemini APIå‘¼ã³å‡ºã—
    response = self.model.generate_content([prompt, img])

    # 4. JSONæŠ½å‡º
    json_str = self._extract_json(response.text)
    stats = json.loads(json_str)

    # 5. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    stats = self._validate_stats(stats)

    return stats

def _validate_stats(self, stats: dict) -> dict:
    """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¤œè¨¼ãƒ»èª¿æ•´"""
    # ç¯„å›²ãƒã‚§ãƒƒã‚¯
    stats['hp'] = max(10, min(200, stats['hp']))
    stats['attack'] = max(10, min(150, stats['attack']))
    stats['defense'] = max(10, min(100, stats['defense']))
    stats['speed'] = max(10, min(100, stats['speed']))
    stats['magic'] = max(10, min(100, stats['magic']))
    stats['luck'] = max(0, min(100, stats['luck']))

    # åˆè¨ˆå€¤ãƒã‚§ãƒƒã‚¯
    total = sum([stats['hp'], stats['attack'], stats['defense'],
                 stats['speed'], stats['magic'], stats['luck']])

    if total > 350:
        # æ¯”ä¾‹é…åˆ†ã§èª¿æ•´
        ratio = 350 / total
        stats['hp'] = int(stats['hp'] * ratio)
        stats['attack'] = int(stats['attack'] * ratio)
        stats['defense'] = int(stats['defense'] * ratio)
        stats['speed'] = int(stats['speed'] * ratio)
        stats['magic'] = int(stats['magic'] * ratio)
        stats['luck'] = int(stats['luck'] * ratio)

    return stats
```

### 3.3.4 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
def analyze_character(self, image_path: str, retries: int = 3) -> dict:
    for attempt in range(retries):
        try:
            response = self.model.generate_content([prompt, img])
            return self._parse_response(response)
        except json.JSONDecodeError:
            # JSONè§£æžå¤±æ•— â†’ ãƒªãƒˆãƒ©ã‚¤
            if attempt < retries - 1:
                continue
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            return self._default_stats()
        except Exception as e:
            logging.error(f"AI analysis failed: {e}")
            return self._default_stats()

def _default_stats(self) -> dict:
    """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (AIè§£æžå¤±æ•—æ™‚)"""
    return {
        'hp': 100,
        'attack': 50,
        'defense': 40,
        'speed': 40,
        'magic': 40,
        'luck': 50,
        'description': 'AIã«ã‚ˆã‚‹è§£æžã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚'
    }
```

---

## 3.4 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼

### 3.4.1 GUIæ“ä½œãƒ•ãƒ­ãƒ¼

**ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²:**

```
1. [ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²] ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
2. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠžãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ã
   - å¯¾å¿œå½¢å¼: PNG, JPG, JPEG
   â†“
3. ç”»åƒã‚’é¸æŠžã—ã¦ [é–‹ã]
   â†“
4. å‡¦ç†é–‹å§‹ (ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º)
   - ç”»åƒå‡¦ç†ä¸­...
   - AIè§£æžä¸­...
   â†“
5. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ
   - ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   - èª¬æ˜Žæ–‡
   â†“
6. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å…¥åŠ›
   â†“
7. [ä¿å­˜] ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
8. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (Google Sheets/SQLite)
   â†“
9. å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

### 3.4.2 å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

**ã‚³ãƒ¼ãƒ‰ä¾‹ (MainMenu.register_character()):**

```python
def register_character(self):
    # 1. ç”»åƒé¸æŠž
    file_path = filedialog.askopenfilename(
        title="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’é¸æŠž",
        filetypes=[
            ("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«", "*.png *.jpg *.jpeg"),
            ("ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«", "*.*")
        ]
    )
    if not file_path:
        return

    # 2. ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
    progress = self.show_progress("å‡¦ç†ä¸­...")

    try:
        # 3. UUIDç”Ÿæˆ
        character_id = str(uuid.uuid4())

        # 4. ç”»åƒå‡¦ç†
        progress.update("ç”»åƒå‡¦ç†ä¸­...")
        original_path, sprite_path = self.image_processor.process_character_image(
            file_path, character_id
        )

        # 5. AIè§£æž
        progress.update("AIè§£æžä¸­...")
        stats = self.ai_analyzer.analyze_character(sprite_path)

        # 6. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        progress.close()
        result = self.show_character_confirm_dialog(
            sprite_path, stats
        )

        if not result:
            return

        # 7. Characterãƒ¢ãƒ‡ãƒ«ä½œæˆ
        character = Character(
            id=character_id,
            name=result['name'],
            image_path=original_path,
            sprite_path=sprite_path,
            hp=stats['hp'],
            attack=stats['attack'],
            defense=stats['defense'],
            speed=stats['speed'],
            magic=stats['magic'],
            luck=stats['luck'],
            description=stats['description'],
            created_at=datetime.now()
        )

        # 8. ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        if self.db_manager.online_mode:
            # Google Sheetsã«ä¿å­˜
            self.db_manager.save_character(character)
        else:
            # SQLiteã«ä¿å­˜
            self.db_manager.add_character(character)

        # 9. UIãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        self.refresh_character_list()

        messagebox.showinfo("æˆåŠŸ", f"{character.name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼")

    except Exception as e:
        messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
```

### 3.4.3 ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°UI

**è¡¨ç¤ºå†…å®¹:**
- ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (200x200px)
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º (ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å½¢å¼)
- èª¬æ˜Žæ–‡ãƒ†ã‚­ã‚¹ãƒˆ
- åå‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- [ä¿å­˜] / [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] ãƒœã‚¿ãƒ³

```python
def show_character_confirm_dialog(self, sprite_path, stats):
    dialog = tk.Toplevel(self.root)
    dialog.title("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç¢ºèª")

    # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆè¡¨ç¤º
    img = Image.open(sprite_path)
    img.thumbnail((200, 200))
    photo = ImageTk.PhotoImage(img)
    label_img = tk.Label(dialog, image=photo)
    label_img.image = photo  # å‚ç…§ä¿æŒ
    label_img.pack(pady=10)

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    stats_frame = tk.Frame(dialog)
    stats_frame.pack(pady=10, padx=20, fill=tk.BOTH)

    for stat_name, value in stats.items():
        if stat_name == 'description':
            continue
        self._create_stat_bar(stats_frame, stat_name, value)

    # èª¬æ˜Žæ–‡
    desc_label = tk.Label(dialog, text=stats['description'],
                          wraplength=300, justify=tk.LEFT)
    desc_label.pack(pady=10)

    # åå‰å…¥åŠ›
    name_frame = tk.Frame(dialog)
    name_frame.pack(pady=10)
    tk.Label(name_frame, text="åå‰:").pack(side=tk.LEFT)
    name_entry = tk.Entry(name_frame, width=30)
    name_entry.pack(side=tk.LEFT, padx=5)

    # ãƒœã‚¿ãƒ³
    result = {'confirmed': False, 'name': ''}

    def on_save():
        result['confirmed'] = True
        result['name'] = name_entry.get()
        dialog.destroy()

    def on_cancel():
        dialog.destroy()

    button_frame = tk.Frame(dialog)
    button_frame.pack(pady=10)
    tk.Button(button_frame, text="ä¿å­˜", command=on_save).pack(side=tk.LEFT, padx=5)
    tk.Button(button_frame, text="ã‚­ãƒ£ãƒ³ã‚»ãƒ«", command=on_cancel).pack(side=tk.LEFT, padx=5)

    dialog.wait_window()
    return result if result['confirmed'] else None
```

---

## 3.5 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§è¡¨ç¤º

### 3.5.1 ãƒªã‚¹ãƒˆè¡¨ç¤ºUI

**è¡¨ç¤ºé …ç›®:**
- ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒã‚µãƒ ãƒã‚¤ãƒ« (50x50px)
- åå‰
- ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- æˆ¦ç¸¾ (W-L-D)
- å‹çŽ‡

```python
def refresh_character_list(self):
    # æ—¢å­˜ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    for widget in self.character_list_frame.winfo_children():
        widget.destroy()

    # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    characters = self.db_manager.get_all_characters()

    # ã‚½ãƒ¼ãƒˆ (ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é †)
    characters.sort(key=lambda c: c.rating, reverse=True)

    # ãƒªã‚¹ãƒˆè¡¨ç¤º
    for i, character in enumerate(characters):
        self._create_character_row(character, i)

def _create_character_row(self, character: Character, index: int):
    row_frame = tk.Frame(self.character_list_frame,
                         bg='white' if index % 2 == 0 else '#f0f0f0')
    row_frame.pack(fill=tk.X, padx=5, pady=2)

    # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ
    img = Image.open(character.sprite_path)
    img.thumbnail((50, 50))
    photo = ImageTk.PhotoImage(img)
    label_img = tk.Label(row_frame, image=photo)
    label_img.image = photo
    label_img.pack(side=tk.LEFT, padx=5)

    # åå‰
    tk.Label(row_frame, text=character.name, width=15, anchor='w').pack(side=tk.LEFT)

    # ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    tk.Label(row_frame, text=f"ç·åˆ: {character.total_stats}", width=10).pack(side=tk.LEFT)

    # æˆ¦ç¸¾
    record = f"{character.wins}-{character.losses}-{character.draws}"
    tk.Label(row_frame, text=record, width=10).pack(side=tk.LEFT)

    # å‹çŽ‡
    win_rate = f"{character.win_rate * 100:.1f}%"
    tk.Label(row_frame, text=win_rate, width=8).pack(side=tk.LEFT)

    # é¸æŠžãƒœã‚¿ãƒ³
    tk.Button(row_frame, text="é¸æŠž",
              command=lambda: self.select_character(character)).pack(side=tk.RIGHT, padx=5)
```

### 3.5.2 ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆ

**ã‚½ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³:**
- ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é † (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
- åå‰é †
- ä½œæˆæ—¥é †
- ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é †

```python
def sort_characters(self, sort_by: str):
    characters = self.db_manager.get_all_characters()

    if sort_by == 'rating':
        characters.sort(key=lambda c: c.rating, reverse=True)
    elif sort_by == 'name':
        characters.sort(key=lambda c: c.name)
    elif sort_by == 'created_at':
        characters.sort(key=lambda c: c.created_at, reverse=True)
    elif sort_by == 'total_stats':
        characters.sort(key=lambda c: c.total_stats, reverse=True)

    self.display_characters(characters)
```

**æ¤œç´¢æ©Ÿèƒ½:**

```python
def search_characters(self, query: str):
    all_characters = self.db_manager.get_all_characters()

    # åå‰ã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
    results = [c for c in all_characters if query.lower() in c.name.lower()]

    self.display_characters(results)
```

---

## 3.6 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°è¡¨ç¤º

### 3.6.1 è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°

**è¡¨ç¤ºå†…å®¹:**
- å¤§ããªã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ (300x300px)
- å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (ãƒãƒ¼è¡¨ç¤º)
- èª¬æ˜Žæ–‡
- è©³ç´°æˆ¦ç¸¾
- ãƒãƒˆãƒ«å±¥æ­´ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã¿)

```python
def show_character_detail(self, character: Character):
    dialog = tk.Toplevel(self.root)
    dialog.title(f"{character.name} - è©³ç´°")
    dialog.geometry("600x700")

    # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ
    img = Image.open(character.sprite_path)
    img.thumbnail((300, 300))
    photo = ImageTk.PhotoImage(img)
    label_img = tk.Label(dialog, image=photo)
    label_img.image = photo
    label_img.pack(pady=10)

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    stats_frame = tk.Frame(dialog)
    stats_frame.pack(pady=10, padx=20, fill=tk.BOTH)

    self._create_stat_bar(stats_frame, "HP", character.hp, 200)
    self._create_stat_bar(stats_frame, "æ”»æ’ƒ", character.attack, 150)
    self._create_stat_bar(stats_frame, "é˜²å¾¡", character.defense, 100)
    self._create_stat_bar(stats_frame, "é€Ÿã•", character.speed, 100)
    self._create_stat_bar(stats_frame, "é­”åŠ›", character.magic, 100)
    self._create_stat_bar(stats_frame, "é‹", character.luck, 100)

    tk.Label(stats_frame, text=f"ç·åˆ: {character.total_stats}/350",
             font=("Arial", 12, "bold")).pack(pady=5)

    # èª¬æ˜Žæ–‡
    tk.Label(dialog, text=character.description,
             wraplength=500, justify=tk.LEFT).pack(pady=10)

    # æˆ¦ç¸¾
    record_frame = tk.Frame(dialog)
    record_frame.pack(pady=10)

    tk.Label(record_frame, text=f"æˆ¦ç¸¾: {character.wins}å‹ {character.losses}æ•— {character.draws}åˆ†",
             font=("Arial", 12)).pack()
    tk.Label(record_frame, text=f"å‹çŽ‡: {character.win_rate * 100:.1f}%",
             font=("Arial", 12)).pack()
    tk.Label(record_frame, text=f"ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: {character.rating}",
             font=("Arial", 12)).pack()

    # ãƒãƒˆãƒ«å±¥æ­´ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã¿)
    if self.db_manager.online_mode:
        self._show_battle_history(dialog, character.id)

def _create_stat_bar(self, parent, label, value, max_value):
    frame = tk.Frame(parent)
    frame.pack(fill=tk.X, pady=2)

    tk.Label(frame, text=f"{label}:", width=8, anchor='w').pack(side=tk.LEFT)

    bar_frame = tk.Frame(frame, width=300, height=20, bg='#ddd')
    bar_frame.pack(side=tk.LEFT, padx=5)
    bar_frame.pack_propagate(False)

    filled_width = int(300 * (value / max_value))
    filled_bar = tk.Frame(bar_frame, width=filled_width, bg='#4CAF50')
    filled_bar.pack(side=tk.LEFT, fill=tk.Y)

    tk.Label(frame, text=str(value), width=5, anchor='e').pack(side=tk.LEFT)
```

---

## 3.7 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤

### 3.7.1 å‰Šé™¤ãƒ•ãƒ­ãƒ¼

```python
def delete_character(self, character: Character):
    # ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    result = messagebox.askyesno(
        "ç¢ºèª",
        f"{character.name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚"
    )

    if not result:
        return

    try:
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤
        self.db_manager.delete_character(character.id)

        # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        if os.path.exists(character.sprite_path):
            os.remove(character.sprite_path)
        if os.path.exists(character.image_path):
            os.remove(character.image_path)

        # UIãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        self.refresh_character_list()

        messagebox.showinfo("æˆåŠŸ", f"{character.name} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")

    except Exception as e:
        messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
```

### 3.7.2 å‰Šé™¤æ™‚ã®æ³¨æ„äº‹é …

âš ï¸ **å‰Šé™¤å‰ã«ç¢ºèªã™ã¹ãäº‹é …:**
- ãƒãƒˆãƒ«å±¥æ­´ã¯ä¿æŒã•ã‚Œã‚‹ (ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼IDã¯æ®‹ã‚‹)
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã‚‹
- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤ã•ã‚Œã‚‹ (å¾©å…ƒä¸å¯)
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: Google Sheets/Driveã‹ã‚‰ã‚‚å‰Šé™¤

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [04_BATTLE_SYSTEM.md](04_BATTLE_SYSTEM.md) ã§ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 04. ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ 

## 4.1 ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³æ¦‚è¦

### 4.1.1 åŸºæœ¬ä»•æ§˜

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/battle_engine.py`

**ãƒãƒˆãƒ«å½¢å¼:**
- ã‚¿ãƒ¼ãƒ³åˆ¶ã‚³ãƒžãƒ³ãƒ‰ãƒãƒˆãƒ« (å®Œå…¨è‡ªå‹•)
- 1å¯¾1ã®å¯¾æˆ¦
- æœ€å¤§100ã‚¿ãƒ¼ãƒ³ (åˆ¶é™æ™‚é–“)
- HP 0ã§æ•—åŒ—

**å‹åˆ©æ¡ä»¶:**
1. ç›¸æ‰‹ã®HPã‚’0ä»¥ä¸‹ã«ã™ã‚‹ (KOå‹åˆ©)
2. 100ã‚¿ãƒ¼ãƒ³çµŒéŽæ™‚ã«HPãŒå¤šã„æ–¹ (æ™‚é–“åˆ‡ã‚Œå‹åˆ©)
3. 100ã‚¿ãƒ¼ãƒ³çµŒéŽæ™‚ã«HPåŒå€¤ (å¼•ãåˆ†ã‘)

### 4.1.2 BattleEngine ã‚¯ãƒ©ã‚¹æ§‹é€ 

```python
class BattleEngine:
    def __init__(self, character1: Character, character2: Character,
                 battle_speed: float = 1.0):
        self.char1 = character1
        self.char2 = character2
        self.char1_hp = character1.hp
        self.char2_hp = character2.hp
        self.battle_speed = battle_speed  # 0.1-2.0ç§’/ã‚¿ãƒ¼ãƒ³
        self.max_turns = 100
        self.current_turn = 0
        self.battle_log: list[str] = []
        self.turns: list[BattleTurn] = []

        # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        self.char1_damage_dealt = 0
        self.char2_damage_dealt = 0

    def execute_battle(self) -> Battle:
        """ãƒãƒˆãƒ«ã‚’å®Ÿè¡Œã—ã¦Battleãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™"""

    def _execute_turn(self) -> bool:
        """1ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè¡Œã€‚Falseã§æˆ¦é—˜çµ‚äº†"""

    def _calculate_damage(self, attacker, defender, is_magic: bool) -> int:
        """ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—"""

    def _check_critical(self, attacker) -> bool:
        """ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š"""

    def _check_guard_break(self, attacker) -> bool:
        """ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®š"""

    def _check_evasion(self, attacker, defender) -> bool:
        """å›žé¿åˆ¤å®š"""
```

---

## 4.2 ã‚¿ãƒ¼ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 4.2.1 ã‚¿ãƒ¼ãƒ³å®Ÿè¡Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```
[ã‚¿ãƒ¼ãƒ³é–‹å§‹]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¡Œå‹•é †æ±ºå®š                         â”‚
â”‚    - é€Ÿã•ãŒé«˜ã„æ–¹ãŒå…ˆæ”»               â”‚
â”‚    - åŒé€Ÿã®å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ”»æ’ƒã‚¿ã‚¤ãƒ—é¸æŠž (å…ˆæ”»å´)            â”‚
â”‚    - é­”æ³•åˆ¤å®š: magic / 200           â”‚
â”‚    - æˆåŠŸ â†’ é­”æ³•æ”»æ’ƒ                  â”‚
â”‚    - å¤±æ•— â†’ ç‰©ç†æ”»æ’ƒ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å›žé¿åˆ¤å®š (é˜²å¾¡å´)                  â”‚
â”‚    - åŸºæœ¬å›žé¿çŽ‡: speed / 500         â”‚
â”‚    - é‹è£œæ­£: defender_luck / 1000    â”‚
â”‚    - é‹ãƒšãƒŠãƒ«ãƒ†ã‚£: -attacker_luck/1000â”‚
â”‚    - æˆåŠŸ â†’ ãƒ€ãƒ¡ãƒ¼ã‚¸0ã€æ¬¡ã®è¡Œå‹•ã¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š (æ”»æ’ƒå´)          â”‚
â”‚    - åŸºæœ¬: 5%                        â”‚
â”‚    - é‹è£œæ­£: +attacker_luck / 10     â”‚
â”‚    - æœ€å¤§: 35%                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®š (ç‰©ç†æ”»æ’ƒã®ã¿)   â”‚
â”‚    - åŸºæœ¬: 15%                       â”‚
â”‚    - é‹è£œæ­£: +attacker_luck / 20     â”‚
â”‚    - æœ€å¤§: 30%                       â”‚
â”‚    - æˆåŠŸ â†’ é˜²å¾¡åŠ›ç„¡è¦–                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—                       â”‚
â”‚    ã€ç‰©ç†æ”»æ’ƒã€‘                        â”‚
â”‚    - é€šå¸¸: attack - defense + rand   â”‚
â”‚    - GBæ™‚: attack - 0 + rand         â”‚
â”‚    ã€é­”æ³•æ”»æ’ƒã€‘                        â”‚
â”‚    - attack - (defense * 0.5) + rand â”‚
â”‚    - GBåˆ¤å®šãªã—                       â”‚
â”‚    ã€å…±é€šã€‘                           â”‚
â”‚    - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ™‚: Ã—1.5            â”‚
â”‚    - æœ€ä½Žãƒ€ãƒ¡ãƒ¼ã‚¸: 1                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. HPæ›´æ–°                            â”‚
â”‚    - defender_hp -= damage          â”‚
â”‚    - çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ç”»é¢æç”»                          â”‚
â”‚    - HPãƒãƒ¼æ›´æ–°                      â”‚
â”‚    - ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º                   â”‚
â”‚    - ãƒ­ã‚°è¿½åŠ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. å‹æ•—åˆ¤å®š                          â”‚
â”‚    - HP â‰¤ 0 â†’ KOå‹åˆ©                 â”‚
â”‚    - 100ã‚¿ãƒ¼ãƒ³çµŒéŽ â†’ æ™‚é–“åˆ‡ã‚Œåˆ¤å®š     â”‚
â”‚    - ç¶™ç¶š â†’ å¾Œæ”»å´ã®è¡Œå‹•ã¸            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
         [ã‚¿ãƒ¼ãƒ³çµ‚äº†]
```

### 4.2.2 ã‚³ãƒ¼ãƒ‰å®Ÿè£…

```python
def _execute_turn(self) -> bool:
    """1ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè¡Œã€‚æˆ¦é—˜çµ‚äº†æ™‚ã«False"""
    self.current_turn += 1

    # 1. è¡Œå‹•é †æ±ºå®š
    if self.char1.speed >= self.char2.speed:
        first, second = (self.char1, self.char1_hp), (self.char2, self.char2_hp)
        first_is_char1 = True
    else:
        first, second = (self.char2, self.char2_hp), (self.char1, self.char1_hp)
        first_is_char1 = False

    # 2. å…ˆæ”»ã®è¡Œå‹•
    damage = self._perform_attack(first[0], second[0])
    if first_is_char1:
        self.char2_hp -= damage
        self.char1_damage_dealt += damage
    else:
        self.char1_hp -= damage
        self.char2_damage_dealt += damage

    # 3. å‹æ•—åˆ¤å®š
    if self.char1_hp <= 0 or self.char2_hp <= 0:
        return False

    # 4. å¾Œæ”»ã®è¡Œå‹•
    damage = self._perform_attack(second[0], first[0])
    if first_is_char1:
        self.char1_hp -= damage
        self.char2_damage_dealt += damage
    else:
        self.char2_hp -= damage
        self.char1_damage_dealt += damage

    # 5. å‹æ•—åˆ¤å®š
    if self.char1_hp <= 0 or self.char2_hp <= 0:
        return False

    # 6. ã‚¿ãƒ¼ãƒ³ä¸Šé™ãƒã‚§ãƒƒã‚¯
    if self.current_turn >= self.max_turns:
        return False

    return True

def _perform_attack(self, attacker: Character, defender: Character) -> int:
    """æ”»æ’ƒã‚’å®Ÿè¡Œã—ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¿”ã™"""
    # æ”»æ’ƒã‚¿ã‚¤ãƒ—æ±ºå®š
    is_magic = random.random() < (attacker.magic / 200)

    # å›žé¿åˆ¤å®š
    if self._check_evasion(attacker, defender):
        self._log(f"{defender.name} ã¯æ”»æ’ƒã‚’å›žé¿ã—ãŸï¼")
        return 0

    # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š
    is_critical = self._check_critical(attacker)

    # ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®š (ç‰©ç†ã®ã¿)
    is_guard_break = False
    if not is_magic:
        is_guard_break = self._check_guard_break(attacker)

    # ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
    damage = self._calculate_damage(
        attacker, defender, is_magic, is_critical, is_guard_break
    )

    # ãƒ­ã‚°
    attack_type = "é­”æ³•æ”»æ’ƒ" if is_magic else "ç‰©ç†æ”»æ’ƒ"
    log_msg = f"{attacker.name} ã®{attack_type}ï¼"
    if is_critical:
        log_msg += " ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼"
    if is_guard_break:
        log_msg += " ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ï¼"
    log_msg += f" {damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"
    self._log(log_msg)

    return damage
```

---

## 4.3 ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—

### 4.3.1 åŸºæœ¬è¨ˆç®—å¼

**ç‰©ç†æ”»æ’ƒ (é€šå¸¸):**
```
damage = (attack - defense) + random(-5, 5)
damage = max(1, damage)  # æœ€ä½Ž1ãƒ€ãƒ¡ãƒ¼ã‚¸
```

**ç‰©ç†æ”»æ’ƒ (ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯æ™‚):**
```
damage = (attack - 0) + random(-5, 5)  # é˜²å¾¡åŠ›å®Œå…¨ç„¡è¦–
damage = max(1, damage)
```

**é­”æ³•æ”»æ’ƒ:**
```
damage = (attack - defense * 0.5) + random(-5, 5)  # é˜²å¾¡è²«é€š50%
damage = max(1, damage)
```

**ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ™‚:**
```
damage = damage * 1.5
```

### 4.3.2 å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```python
def _calculate_damage(self, attacker: Character, defender: Character,
                      is_magic: bool, is_critical: bool = False,
                      is_guard_break: bool = False) -> int:
    """ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—"""
    # åŸºç¤Žãƒ€ãƒ¡ãƒ¼ã‚¸
    if is_guard_break:
        # ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯: é˜²å¾¡åŠ›ç„¡è¦–
        base_damage = attacker.attack
    elif is_magic:
        # é­”æ³•æ”»æ’ƒ: é˜²å¾¡åŠ›50%è²«é€š
        base_damage = attacker.attack - (defender.defense * 0.5)
    else:
        # ç‰©ç†æ”»æ’ƒ: é€šå¸¸è¨ˆç®—
        base_damage = attacker.attack - defender.defense

    # ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ 
    randomness = random.randint(-5, 5)
    damage = base_damage + randomness

    # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«
    if is_critical:
        damage = damage * 1.5

    # æœ€ä½Žãƒ€ãƒ¡ãƒ¼ã‚¸ä¿è¨¼
    damage = max(1, int(damage))

    return damage
```

### 4.3.3 ãƒ€ãƒ¡ãƒ¼ã‚¸ä¾‹

**ä¾‹1: é€šå¸¸ç‰©ç†æ”»æ’ƒ**
- æ”»æ’ƒå´: Attack 100
- é˜²å¾¡å´: Defense 40
- ãƒ€ãƒ¡ãƒ¼ã‚¸: 100 - 40 + rand(-5, 5) = 55-65

**ä¾‹2: ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ç‰©ç†æ”»æ’ƒ**
- æ”»æ’ƒå´: Attack 100, Luck 80
- é˜²å¾¡å´: Defense 40
- ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯æˆåŠŸ (19%ç¢ºçŽ‡)
- ãƒ€ãƒ¡ãƒ¼ã‚¸: 100 - 0 + rand(-5, 5) = 95-105

**ä¾‹3: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«é­”æ³•æ”»æ’ƒ**
- æ”»æ’ƒå´: Attack 100, Luck 80
- é˜²å¾¡å´: Defense 40
- é­”æ³•æ”»æ’ƒ + ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«
- ãƒ€ãƒ¡ãƒ¼ã‚¸: ((100 - 20) + rand(-5, 5)) Ã— 1.5 = 112-127

---

## 4.4 ç‰¹æ®ŠåŠ¹æžœ

### 4.4.1 ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆ

**ç™ºå‹•æ¡ä»¶:**
- å…¨ã¦ã®æ”»æ’ƒã§åˆ¤å®š
- ç‰©ç†ãƒ»é­”æ³•ä¸¡æ–¹ã§ç™ºå‹•å¯èƒ½

**ç™ºå‹•ç¢ºçŽ‡:**
```
critical_rate = 5% + (attacker.luck / 10)%
max_rate = 35%
```

**åŠ¹æžœ:**
- ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€
- èµ¤ã„å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
- ãƒ­ã‚°ã« "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼" è¡¨ç¤º

**å®Ÿè£…:**
```python
def _check_critical(self, attacker: Character) -> bool:
    """ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š"""
    base_rate = 0.05  # 5%
    luck_bonus = attacker.luck / 1000  # æœ€å¤§10%
    critical_rate = min(0.35, base_rate + luck_bonus)  # ä¸Šé™35%

    return random.random() < critical_rate
```

### 4.4.2 ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯

**ç™ºå‹•æ¡ä»¶:**
- **ç‰©ç†æ”»æ’ƒã®ã¿** (é­”æ³•æ”»æ’ƒã§ã¯ç™ºå‹•ã—ãªã„)

**ç™ºå‹•ç¢ºçŽ‡:**
```
guard_break_rate = 15% + (attacker.luck / 20)%
max_rate = 30%
```

**åŠ¹æžœ:**
- é˜²å¾¡åŠ›ã‚’å®Œå…¨ç„¡è¦– (Defense = 0ã¨ã—ã¦è¨ˆç®—)
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã¨åŒæ™‚ç™ºå‹•å¯èƒ½
- é’ã„çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
- ãƒ­ã‚°ã« "ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ï¼" è¡¨ç¤º

**å®Ÿè£…:**
```python
def _check_guard_break(self, attacker: Character) -> bool:
    """ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®š (ç‰©ç†æ”»æ’ƒã®ã¿)"""
    base_rate = 0.15  # 15%
    luck_bonus = attacker.luck / 2000  # æœ€å¤§5%
    guard_break_rate = min(0.30, base_rate + luck_bonus)  # ä¸Šé™30%

    return random.random() < guard_break_rate
```

**ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ + ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åŒæ™‚ç™ºå‹•ä¾‹:**
```
æ”»æ’ƒå´: Attack 120, Luck 100
é˜²å¾¡å´: Defense 60

é€šå¸¸ç‰©ç†: (120 - 60) = 60ãƒ€ãƒ¡ãƒ¼ã‚¸
GBç™ºå‹•: (120 - 0) = 120ãƒ€ãƒ¡ãƒ¼ã‚¸
GB + Crit: 120 Ã— 1.5 = 180ãƒ€ãƒ¡ãƒ¼ã‚¸
```

### 4.4.3 å›žé¿

**ç™ºå‹•æ¡ä»¶:**
- å…¨ã¦ã®æ”»æ’ƒã«å¯¾ã—ã¦åˆ¤å®š

**å›žé¿ç¢ºçŽ‡:**
```
evasion_rate = (defender.speed / 500) + (defender.luck / 1000)
                - (attacker.luck / 1000)
max_rate = 30%
```

**åŠ¹æžœ:**
- ãƒ€ãƒ¡ãƒ¼ã‚¸0
- ãƒ­ã‚°ã« "â—‹â—‹ã¯æ”»æ’ƒã‚’å›žé¿ã—ãŸï¼" è¡¨ç¤º

**å®Ÿè£…:**
```python
def _check_evasion(self, attacker: Character, defender: Character) -> bool:
    """å›žé¿åˆ¤å®š"""
    # é˜²å¾¡å´ã®é€Ÿã•ãƒœãƒ¼ãƒŠã‚¹
    speed_bonus = defender.speed / 500  # æœ€å¤§20%

    # é˜²å¾¡å´ã®é‹ãƒœãƒ¼ãƒŠã‚¹
    defender_luck_bonus = defender.luck / 1000  # æœ€å¤§10%

    # æ”»æ’ƒå´ã®é‹ãƒšãƒŠãƒ«ãƒ†ã‚£ (é˜²å¾¡å´ã®å›žé¿çŽ‡ã‚’ä¸‹ã’ã‚‹)
    attacker_luck_penalty = attacker.luck / 1000  # æœ€å¤§10%

    evasion_rate = speed_bonus + defender_luck_bonus - attacker_luck_penalty
    evasion_rate = max(0, min(0.30, evasion_rate))  # 0-30%

    return random.random() < evasion_rate
```

### 4.4.4 é­”æ³•æ”»æ’ƒ

**ç™ºå‹•æ¡ä»¶:**
- æ¯Žã‚¿ãƒ¼ãƒ³è‡ªå‹•åˆ¤å®š

**ç™ºå‹•ç¢ºçŽ‡:**
```
magic_rate = attacker.magic / 200
max_rate = 50%
```

**åŠ¹æžœ:**
- é˜²å¾¡åŠ›50%è²«é€š
- ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®šãªã—
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã¯ç™ºå‹•å¯èƒ½
- ç´«è‰²ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ

**å®Ÿè£…:**
```python
def _select_attack_type(self, attacker: Character) -> bool:
    """æ”»æ’ƒã‚¿ã‚¤ãƒ—ã‚’é¸æŠžã€‚Trueã§é­”æ³•æ”»æ’ƒ"""
    magic_chance = min(0.50, attacker.magic / 200)
    return random.random() < magic_chance
```

---

## 4.5 ãƒãƒˆãƒ«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿

### 4.5.1 Battle ãƒ¢ãƒ‡ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/models/battle.py`

```python
class BattleTurn(BaseModel):
    turn_number: int
    attacker_name: str
    defender_name: str
    damage: int
    is_critical: bool = False
    is_guard_break: bool = False
    is_magic: bool = False
    is_evaded: bool = False
    attacker_hp: int
    defender_hp: int

class Battle(BaseModel):
    id: str
    character1_id: str
    character1_name: str
    character2_id: str
    character2_name: str
    winner_id: Optional[str]
    winner_name: Optional[str]
    battle_log: list[str]
    turns: list[BattleTurn]
    duration: float  # ç§’
    created_at: datetime

    # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
    total_turns: int
    char1_final_hp: int
    char2_final_hp: int
    char1_damage_dealt: int
    char2_damage_dealt: int
    result_type: str  # "KO", "Time Limit", "Draw"
```

### 4.5.2 è¨˜éŒ²ã•ã‚Œã‚‹çµ±è¨ˆæƒ…å ±

| é …ç›® | èª¬æ˜Ž |
|------|------|
| total_turns | ç·ã‚¿ãƒ¼ãƒ³æ•° |
| char1_final_hp | ã‚­ãƒ£ãƒ©1ã®æœ€çµ‚HP |
| char2_final_hp | ã‚­ãƒ£ãƒ©2ã®æœ€çµ‚HP |
| char1_damage_dealt | ã‚­ãƒ£ãƒ©1ãŒä¸ŽãˆãŸç·ãƒ€ãƒ¡ãƒ¼ã‚¸ |
| char2_damage_dealt | ã‚­ãƒ£ãƒ©2ãŒä¸ŽãˆãŸç·ãƒ€ãƒ¡ãƒ¼ã‚¸ |
| result_type | å‹æ•—ã®ç¨®é¡ž (KO/Time Limit/Draw) |
| duration | ãƒãƒˆãƒ«æ‰€è¦æ™‚é–“ (ç§’) |

### 4.5.3 çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨

**ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—:**
```python
rating = (wins * 3) + draws
```

**å¹³å‡ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—:**
```python
avg_damage = total_damage_dealt / total_battles
```

**å‹çŽ‡è¨ˆç®—:**
```python
win_rate = wins / (wins + losses + draws)
```

---

## 4.6 ãƒãƒˆãƒ«ç”»é¢UI (Pygame)

### 4.6.1 ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    èƒŒæ™¯ç”»åƒ                       â”‚
â”‚                                                  â”‚
â”‚  [ã‚­ãƒ£ãƒ©1ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ]              [ã‚­ãƒ£ãƒ©2ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ]â”‚
â”‚    (å·¦å´)                           (å³å´)       â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ã‚­ãƒ£ãƒ©1å      â”‚              â”‚ã‚­ãƒ£ãƒ©2å      â”‚  â”‚
â”‚  â”‚HP: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  â”‚              â”‚HP: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ãƒãƒˆãƒ«ãƒ­ã‚°                                  â”‚ â”‚
â”‚  â”‚ â—‹â—‹ã®ç‰©ç†æ”»æ’ƒï¼ 30ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼                â”‚ â”‚
â”‚  â”‚ Ã—Ã—ã®é­”æ³•æ”»æ’ƒï¼ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ 45ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ â”‚ â”‚
â”‚  â”‚ ...                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚                Turn: 25/100                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.6.2 PygameåˆæœŸåŒ–

```python
import pygame

class BattleEngine:
    def __init__(self, char1, char2, battle_speed=1.0):
        # PygameåˆæœŸåŒ–
        pygame.init()
        self.screen = pygame.display.set_mode((1024, 768))
        pygame.display.set_caption("ãŠçµµæããƒãƒˆãƒ©ãƒ¼")

        # ãƒ•ã‚©ãƒ³ãƒˆ
        self.font_large = pygame.font.Font(None, 48)
        self.font_medium = pygame.font.Font(None, 32)
        self.font_small = pygame.font.Font(None, 24)

        # æ—¥æœ¬èªžãƒ•ã‚©ãƒ³ãƒˆ (ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆä½¿ç”¨)
        try:
            self.font_jp = pygame.font.Font("/usr/share/fonts/truetype/fonts-japanese-gothic.ttf", 28)
        except:
            self.font_jp = self.font_medium

        # èƒŒæ™¯
        self.background = pygame.image.load("assets/images/battle_bg.png")

        # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆèª­ã¿è¾¼ã¿
        self.sprite1 = pygame.image.load(char1.sprite_path)
        self.sprite2 = pygame.image.load(char2.sprite_path)

        # HPãƒãƒ¼è‰²
        self.hp_bar_bg = (100, 100, 100)
        self.hp_bar_fg = (0, 255, 0)
```

### 4.6.3 æç”»å‡¦ç†

```python
def _draw_battle_screen(self):
    """ãƒãƒˆãƒ«ç”»é¢ã‚’æç”»"""
    # èƒŒæ™¯
    self.screen.blit(self.background, (0, 0))

    # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ
    self.screen.blit(self.sprite1, (100, 300))
    self.screen.blit(self.sprite2, (700, 300))

    # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
    name1_surface = self.font_jp.render(self.char1.name, True, (255, 255, 255))
    name2_surface = self.font_jp.render(self.char2.name, True, (255, 255, 255))
    self.screen.blit(name1_surface, (100, 200))
    self.screen.blit(name2_surface, (700, 200))

    # HPãƒãƒ¼
    self._draw_hp_bar(100, 240, self.char1_hp, self.char1.hp)
    self._draw_hp_bar(700, 240, self.char2_hp, self.char2.hp)

    # ã‚¿ãƒ¼ãƒ³æ•°
    turn_text = f"Turn: {self.current_turn}/{self.max_turns}"
    turn_surface = self.font_medium.render(turn_text, True, (255, 255, 255))
    self.screen.blit(turn_surface, (450, 700))

    # ãƒãƒˆãƒ«ãƒ­ã‚°
    self._draw_battle_log()

    pygame.display.flip()

def _draw_hp_bar(self, x, y, current_hp, max_hp):
    """HPãƒãƒ¼ã‚’æç”»"""
    bar_width = 200
    bar_height = 20

    # èƒŒæ™¯
    pygame.draw.rect(self.screen, self.hp_bar_bg, (x, y, bar_width, bar_height))

    # HP (ç·‘è‰²)
    hp_ratio = max(0, current_hp / max_hp)
    filled_width = int(bar_width * hp_ratio)
    pygame.draw.rect(self.screen, self.hp_bar_fg, (x, y, filled_width, bar_height))

    # æž ç·š
    pygame.draw.rect(self.screen, (255, 255, 255), (x, y, bar_width, bar_height), 2)

    # HPæ•°å€¤
    hp_text = f"{max(0, current_hp)}/{max_hp}"
    hp_surface = self.font_small.render(hp_text, True, (255, 255, 255))
    self.screen.blit(hp_surface, (x + bar_width + 10, y))
```

### 4.6.4 ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º

```python
def _show_effect(self, effect_type: str, x: int, y: int):
    """ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º"""
    if effect_type == "critical":
        # èµ¤ã„å…‰
        color = (255, 0, 0)
        radius = 50
    elif effect_type == "guard_break":
        # é’ã„çˆ†ç™º
        color = (0, 100, 255)
        radius = 60
    elif effect_type == "magic":
        # ç´«ã®é­”æ³•é™£
        color = (200, 0, 255)
        radius = 40
    else:
        return

    # å††å½¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    for i in range(10):
        alpha_surface = pygame.Surface((radius * 2, radius * 2), pygame.SRCALPHA)
        alpha = int(255 * (1 - i / 10))
        pygame.draw.circle(alpha_surface, (*color, alpha), (radius, radius), radius - i * 5)
        self.screen.blit(alpha_surface, (x - radius, y - radius))
        pygame.display.flip()
        pygame.time.wait(30)
```

---

## 4.7 ãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰

### 4.7.1 é€šå¸¸ãƒãƒˆãƒ« (1å¯¾1)

**èµ·å‹•æ–¹æ³•:**
```python
# ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰
main_menu.start_battle(character1, character2)
```

**ç‰¹å¾´:**
- 2ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠžã—ã¦å¯¾æˆ¦
- ãƒãƒˆãƒ«çµ‚äº†å¾Œã«çµæžœè¡¨ç¤º
- æˆ¦ç¸¾ãŒæ›´æ–°ã•ã‚Œã‚‹
- ãƒãƒˆãƒ«å±¥æ­´ã«è¨˜éŒ² (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

### 4.7.2 ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒˆãƒ«

**èµ·å‹•æ–¹æ³•:**
```python
# ãƒ©ãƒ³ãƒ€ãƒ ã«2ã‚­ãƒ£ãƒ©é¸æŠžã—ã¦å¯¾æˆ¦
main_menu.start_random_battle()
```

**ç‰¹å¾´:**
- å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«2ä½“é¸å‡º
- é€šå¸¸ãƒãƒˆãƒ«ã¨åŒæ§˜ã®å‡¦ç†

### 4.7.3 ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒˆãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/endless_battle_engine.py`

**èµ·å‹•æ–¹æ³•:**
```python
# å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ
main_menu.start_endless_battle()
```

**ç‰¹å¾´:**
- å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè‡ªå‹•ã§ç·å½“ãŸã‚Šæˆ¦
- ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³åˆ¶: å‹è€…ãŒæ¬¡ã®æŒ‘æˆ¦è€…ã¨å¯¾æˆ¦
- å…¨ãƒãƒˆãƒ«çµ‚äº†ã¾ã§è‡ªå‹•é€²è¡Œ
- ãƒãƒˆãƒ«é–“éš”: 2ç§’
- å…¨ãƒãƒˆãƒ«å±¥æ­´ã‚’è¨˜éŒ²

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
```
å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
     â†“
ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³é¸å‡º      â”‚ (å…ˆé ­ã®ã‚­ãƒ£ãƒ©)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‘æˆ¦è€…ãƒªã‚¹ãƒˆã‹ã‚‰1ä½“é¸å‡º           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ãƒãƒˆãƒ«å®Ÿè¡Œ                    â”‚ â”‚
â”‚ â”‚  - å‹è€…ãŒãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã«        â”‚ â”‚
â”‚ â”‚  - æ•—è€…ã¯é™¤å¤–                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â†“                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ¬¡ã®æŒ‘æˆ¦è€…é¸å‡º                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â†“                           â”‚
â”‚   (æŒ‘æˆ¦è€…ãƒªã‚¹ãƒˆãŒç©º?)             â”‚
â”‚    No â†’ ç¹°ã‚Šè¿”ã—                  â”‚
â”‚    Yes â†’ çµ‚äº†                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4.8 ãƒãƒˆãƒ«çµæžœå‡¦ç†

### 4.8.1 å‹æ•—åˆ¤å®š

```python
def _determine_winner(self) -> tuple[Optional[str], str]:
    """å‹è€…ã‚’åˆ¤å®š

    Returns:
        (winner_id, result_type)
    """
    if self.char1_hp <= 0 and self.char2_hp <= 0:
        return None, "Draw"  # ç›¸æ‰“ã¡
    elif self.char1_hp <= 0:
        return self.char2.id, "KO"
    elif self.char2_hp <= 0:
        return self.char1.id, "KO"
    elif self.current_turn >= self.max_turns:
        # æ™‚é–“åˆ‡ã‚Œ: HPãŒå¤šã„æ–¹ã®å‹ã¡
        if self.char1_hp > self.char2_hp:
            return self.char1.id, "Time Limit"
        elif self.char2_hp > self.char1_hp:
            return self.char2.id, "Time Limit"
        else:
            return None, "Draw"
    else:
        return None, "Ongoing"
```

### 4.8.2 æˆ¦ç¸¾æ›´æ–°

```python
def _update_records(self, battle: Battle):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æˆ¦ç¸¾ã‚’æ›´æ–°"""
    if battle.winner_id == self.char1.id:
        self.char1.wins += 1
        self.char2.losses += 1
    elif battle.winner_id == self.char2.id:
        self.char2.wins += 1
        self.char1.losses += 1
    else:
        # å¼•ãåˆ†ã‘
        self.char1.draws += 1
        self.char2.draws += 1

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    self.db_manager.update_character(self.char1)
    self.db_manager.update_character(self.char2)
```

### 4.8.3 çµæžœè¡¨ç¤º

```python
def _show_battle_result(self, battle: Battle):
    """ãƒãƒˆãƒ«çµæžœã‚’è¡¨ç¤º"""
    result_window = tk.Toplevel(self.root)
    result_window.title("ãƒãƒˆãƒ«çµæžœ")
    result_window.geometry("500x400")

    # å‹è€…è¡¨ç¤º
    if battle.winner_id:
        winner_text = f"å‹è€…: {battle.winner_name}"
        color = "gold"
    else:
        winner_text = "å¼•ãåˆ†ã‘"
        color = "gray"

    tk.Label(result_window, text=winner_text,
             font=("Arial", 24, "bold"), fg=color).pack(pady=20)

    # çµ±è¨ˆæƒ…å ±
    stats_frame = tk.Frame(result_window)
    stats_frame.pack(pady=10)

    stats_text = f"""
ã‚¿ãƒ¼ãƒ³æ•°: {battle.total_turns}
æ‰€è¦æ™‚é–“: {battle.duration:.1f}ç§’
çµæžœã‚¿ã‚¤ãƒ—: {battle.result_type}

{battle.character1_name}:
  æœ€çµ‚HP: {battle.char1_final_hp}
  ä¸Žãƒ€ãƒ¡ãƒ¼ã‚¸: {battle.char1_damage_dealt}

{battle.character2_name}:
  æœ€çµ‚HP: {battle.char2_final_hp}
  ä¸Žãƒ€ãƒ¡ãƒ¼ã‚¸: {battle.char2_damage_dealt}
    """

    tk.Label(stats_frame, text=stats_text, justify=tk.LEFT).pack()

    # é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    tk.Button(result_window, text="é–‰ã˜ã‚‹",
              command=result_window.destroy).pack(pady=10)
```

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [05_STORY_MODE.md](05_STORY_MODE.md) ã§ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 05. ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰

## 5.1 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰æ¦‚è¦

### 5.1.1 åŸºæœ¬ä»•æ§˜

**ç›®çš„:**
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§Lv1ï½žLv5ã®ãƒœã‚¹ã‚’é€£ç¶šæ’ƒç ´
- Lv5ãƒœã‚¹ã‚’å€’ã™ã¨ã‚¯ãƒªã‚¢
- 1åº¦ã§ã‚‚æ•—åŒ—ã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼

**ç‰¹å¾´:**
- âœ… ãƒŽãƒ³ã‚¹ãƒˆãƒƒãƒ—å®Ÿè¡Œ (Lv1â†’Lv5ã¾ã§è‡ªå‹•é€²è¡Œ)
- âœ… ãƒœã‚¹æŒ‘æˆ¦å‰ã«2ç§’é–“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”»é¢è¡¨ç¤º
- âœ… é€²è¡ŒçŠ¶æ³ã¯Google Sheetsã«ä¿å­˜ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)
- âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ¯Žã«ç‹¬ç«‹ã—ãŸé€²è¡Œç®¡ç†
- âœ… ã„ã¤ã§ã‚‚ãƒªã‚»ãƒƒãƒˆå¯èƒ½

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `src/services/story_mode_engine.py` - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³
- `src/ui/story_boss_manager.py` - ãƒœã‚¹ç®¡ç†UI
- `src/models/story_boss.py` - ãƒœã‚¹ãƒ»é€²è¡ŒçŠ¶æ³ãƒ¢ãƒ‡ãƒ«

---

## 5.2 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹ãƒ¢ãƒ‡ãƒ«

### 5.2.1 StoryBoss ã‚¯ãƒ©ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/models/story_boss.py`

```python
from pydantic import BaseModel, Field
from typing import Optional

class StoryBoss(BaseModel):
    level: int = Field(ge=1, le=5, description="ãƒœã‚¹ãƒ¬ãƒ™ãƒ« 1-5")
    name: str = Field(min_length=1, max_length=50, description="ãƒœã‚¹å")

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚ˆã‚Šé«˜ã„ä¸Šé™)
    hp: int = Field(ge=50, le=300, description="ä½“åŠ›")
    attack: int = Field(ge=30, le=200, description="æ”»æ’ƒåŠ›")
    defense: int = Field(ge=20, le=150, description="é˜²å¾¡åŠ›")
    speed: int = Field(ge=40, le=180, description="é€Ÿã•")
    magic: int = Field(ge=10, le=150, description="é­”åŠ›")
    luck: int = Field(ge=0, le=100, description="é‹")

    description: str = Field(description="ãƒœã‚¹ã®èª¬æ˜Ž")
    image_path: Optional[str] = Field(default=None, description="ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒ")
    sprite_path: Optional[str] = Field(default=None, description="ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒ")

    @property
    def total_stats(self) -> int:
        """ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"""
        return self.hp + self.attack + self.defense + self.speed + self.magic + self.luck
```

### 5.2.2 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¶ç´„

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æœ€å°å€¤ | æœ€å¤§å€¤ | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æœ€å¤§å€¤ã¨ã®æ¯”è¼ƒ |
|-----------|--------|--------|------------------------|
| HP | 50 | 300 | +100 (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 200) |
| Attack | 30 | 200 | +50 (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 150) |
| Defense | 20 | 150 | +50 (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 100) |
| Speed | 40 | 180 | +80 (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 100) |
| Magic | 10 | 150 | +50 (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 100) |
| Luck | 0 | 100 | åŒã˜ |

**ç·åˆåˆ¶ç´„:**
- **åˆè¨ˆå€¤ä¸Šé™:** æœ€å¤§500 (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 350)
- ãƒœã‚¹ã¯å¼·åŠ›ã ãŒã€ç·åˆå€¤åˆ¶é™ã¯ç·©ã„

### 5.2.3 æŽ¨å¥¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é…åˆ† (ãƒ¬ãƒ™ãƒ«åˆ¥)

| ãƒ¬ãƒ™ãƒ« | HP | Attack | Defense | Speed | Magic | ç·åˆ | é›£æ˜“åº¦ |
|-------|-----|--------|---------|-------|-------|------|-------|
| Lv1 | 100 | 50 | 40 | 50 | 40 | 280 | â˜…â˜†â˜†â˜†â˜† |
| Lv2 | 120 | 70 | 50 | 60 | 50 | 350 | â˜…â˜…â˜†â˜†â˜† |
| Lv3 | 150 | 90 | 60 | 70 | 60 | 430 | â˜…â˜…â˜…â˜†â˜† |
| Lv4 | 180 | 110 | 70 | 80 | 70 | 510 | â˜…â˜…â˜…â˜…â˜† |
| Lv5 | 220 | 130 | 90 | 100 | 90 | 630 | â˜…â˜…â˜…â˜…â˜… |

---

## 5.3 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡ŒçŠ¶æ³ãƒ¢ãƒ‡ãƒ«

### 5.3.1 StoryProgress ã‚¯ãƒ©ã‚¹

```python
from pydantic import BaseModel, Field
from datetime import datetime

class StoryProgress(BaseModel):
    character_id: str = Field(description="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID")
    current_level: int = Field(default=1, ge=1, le=5, description="ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«")
    completed: bool = Field(default=False, description="Lv5ã‚¯ãƒªã‚¢æ¸ˆã¿ã‹")
    victories: list[int] = Field(default_factory=list, description="æ’ƒç ´æ¸ˆã¿ãƒœã‚¹ãƒ¬ãƒ™ãƒ«")
    attempts: int = Field(default=0, description="æŒ‘æˆ¦å›žæ•°")
    last_played: datetime = Field(default_factory=datetime.now)

    def add_victory(self, level: int):
        """ãƒœã‚¹æ’ƒç ´ã‚’è¨˜éŒ²"""
        if level not in self.victories:
            self.victories.append(level)
        self.current_level = level + 1
        if level == 5:
            self.completed = True

    def reset(self):
        """é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ"""
        self.current_level = 1
        self.completed = False
        self.victories = []
```

---

## 5.4 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³

### 5.4.1 StoryModeEngine ã‚¯ãƒ©ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/story_mode_engine.py`

```python
class StoryModeEngine:
    def __init__(self, db_manager, character: Character):
        self.db_manager = db_manager
        self.character = character
        self.bosses: dict[int, StoryBoss] = {}
        self.progress: StoryProgress = None

    def load_bosses(self):
        """å…¨ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ (Lv1-5)"""
        for level in range(1, 6):
            boss = self.db_manager.get_story_boss(level)
            if boss:
                self.bosses[level] = boss

    def load_progress(self) -> StoryProgress:
        """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€²è¡ŒçŠ¶æ³ã‚’èª­ã¿è¾¼ã¿"""
        progress = self.db_manager.get_story_progress(self.character.id)
        if not progress:
            # åˆå›žãƒ—ãƒ¬ã‚¤
            progress = StoryProgress(character_id=self.character.id)
        return progress

    def start_story_mode(self) -> bool:
        """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹

        Returns:
            True: Lv5ã‚¯ãƒªã‚¢, False: æ•—åŒ—
        """
        self.progress = self.load_progress()
        self.progress.attempts += 1

        # Lv1ã‹ã‚‰é †ã«æŒ‘æˆ¦
        for level in range(self.progress.current_level, 6):
            # ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”»é¢è¡¨ç¤º (2ç§’)
            self._show_challenge_screen(level)

            # ãƒœã‚¹ãƒãƒˆãƒ«å®Ÿè¡Œ
            boss = self.bosses[level]
            result = self._battle_boss(boss)

            if result == "win":
                # å‹åˆ©
                self.progress.add_victory(level)
                self.db_manager.save_story_progress(self.progress)

                if level == 5:
                    # ã‚¯ãƒªã‚¢ï¼
                    self._show_clear_screen()
                    return True
            else:
                # æ•—åŒ—
                self._show_game_over_screen(level)
                self.db_manager.save_story_progress(self.progress)
                return False

        return True

    def _show_challenge_screen(self, level: int):
        """æŒ‘æˆ¦ç”»é¢ã‚’2ç§’è¡¨ç¤º"""
        boss = self.bosses[level]

        # Tkinterãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        dialog = tk.Toplevel()
        dialog.title("æŒ‘æˆ¦ï¼")
        dialog.geometry("400x300")

        tk.Label(dialog, text=f"Lv{level} ãƒœã‚¹",
                 font=("Arial", 32, "bold")).pack(pady=20)
        tk.Label(dialog, text=boss.name,
                 font=("Arial", 24)).pack(pady=10)
        tk.Label(dialog, text="æŒ‘æˆ¦ã—ã¾ã™ï¼",
                 font=("Arial", 20)).pack(pady=20)

        # 2ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
        dialog.after(2000, dialog.destroy)
        dialog.wait_window()

    def _battle_boss(self, boss: StoryBoss) -> str:
        """ãƒœã‚¹ã¨ãƒãƒˆãƒ«

        Returns:
            "win" or "lose"
        """
        # BattleEngineã§ãƒãƒˆãƒ«å®Ÿè¡Œ
        battle_engine = BattleEngine(self.character, boss)
        battle = battle_engine.execute_battle()

        if battle.winner_id == self.character.id:
            return "win"
        else:
            return "lose"
```

### 5.4.2 å‡¦ç†ãƒ•ãƒ­ãƒ¼å›³

```
[ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é–‹å§‹]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€²è¡ŒçŠ¶æ³èª­ã¿è¾¼ã¿                    â”‚
â”‚ - current_levelå–å¾—                â”‚
â”‚ - åˆå›žãªã‚‰Lv1ã‹ã‚‰é–‹å§‹               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (Lv1-5)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ãƒ¬ãƒ™ãƒ«ãƒ«ãƒ¼ãƒ— â”‚ (current_level â†’ 5)
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”»é¢è¡¨ç¤º (2ç§’)            â”‚
â”‚ - Lvâ—‹ ãƒœã‚¹                         â”‚
â”‚ - ãƒœã‚¹å                            â”‚
â”‚ - ã€ŒæŒ‘æˆ¦ã—ã¾ã™ï¼ã€                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒœã‚¹ãƒãƒˆãƒ«å®Ÿè¡Œ                      â”‚
â”‚ - BattleEngineä½¿ç”¨                 â”‚
â”‚ - é€šå¸¸ãƒãƒˆãƒ«ã¨åŒã˜ä»•æ§˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
       ã€å‹æ•—åˆ¤å®šã€‘
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚
  å‹åˆ©           æ•—åŒ—
    â”‚              â”‚
    â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚é€²è¡ŒçŠ¶æ³  â”‚  â”‚ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼â”‚
â”‚æ›´æ–°      â”‚  â”‚ç”»é¢è¡¨ç¤º      â”‚
â”‚- æ’ƒç ´è¨˜éŒ²â”‚  â”‚- æ•—åŒ—ãƒ¬ãƒ™ãƒ«  â”‚
â”‚- Lv+1    â”‚  â”‚ è¡¨ç¤º         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
  Lv5ã‚¯ãƒªã‚¢?      çµ‚äº†
     â”‚              â†“
   Yes â†’ [ã‚¯ãƒªã‚¢ç”»é¢]
     â”‚
   No â†’ [æ¬¡ã®ãƒœã‚¹ã¸]
```

---

## 5.5 ãƒœã‚¹ç®¡ç†UI

### 5.5.1 Story Boss Manager

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/ui/story_boss_manager.py`

**èµ·å‹•æ–¹æ³•:**
```
ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ â†’ ã‚²ãƒ¼ãƒ  â†’ Story Boss Manager
```

**æ©Ÿèƒ½:**
- âœ… Lv1-5ã®ãƒœã‚¹ã‚’ä½œæˆãƒ»ç·¨é›†
- âœ… ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- âœ… ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒè‡ªå‹•ç”Ÿæˆ (é€éŽå‡¦ç†)
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š (ç¯„å›²ãƒã‚§ãƒƒã‚¯ä»˜ã)
- âœ… Google Sheetsä¿å­˜ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)
- âœ… ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

### 5.5.2 UI ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Story Boss Manager                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ãƒœã‚¹é¸æŠž    â”‚  â”‚ ãƒœã‚¹ç·¨é›†ã‚¨ãƒªã‚¢                 â”‚ â”‚
â”‚ â”‚            â”‚  â”‚                               â”‚ â”‚
â”‚ â”‚ â—‹ Lv1     â”‚  â”‚ åå‰: [____________]         â”‚ â”‚
â”‚ â”‚ â—‹ Lv2     â”‚  â”‚                               â”‚ â”‚
â”‚ â”‚ â—‹ Lv3     â”‚  â”‚ HP:      [___] / 300         â”‚ â”‚
â”‚ â”‚ â—‹ Lv4     â”‚  â”‚ æ”»æ’ƒåŠ›:  [___] / 200         â”‚ â”‚
â”‚ â”‚ â—‹ Lv5     â”‚  â”‚ é˜²å¾¡åŠ›:  [___] / 150         â”‚ â”‚
â”‚ â”‚            â”‚  â”‚ é€Ÿã•:    [___] / 180         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ é­”åŠ›:    [___] / 150         â”‚ â”‚
â”‚                 â”‚ é‹:      [___] / 100         â”‚ â”‚
â”‚                 â”‚                               â”‚ â”‚
â”‚                 â”‚ ç·åˆ: â—‹â—‹â—‹ / 500              â”‚ â”‚
â”‚                 â”‚                               â”‚ â”‚
â”‚                 â”‚ èª¬æ˜Ž:                         â”‚ â”‚
â”‚                 â”‚ [_____________________________â”‚ â”‚
â”‚                 â”‚  _____________________________â”‚ â”‚
â”‚                 â”‚  ____________________________]â”‚ â”‚
â”‚                 â”‚                               â”‚ â”‚
â”‚                 â”‚ [ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰]             â”‚ â”‚
â”‚                 â”‚ [ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”Ÿæˆ]               â”‚ â”‚
â”‚                 â”‚                               â”‚ â”‚
â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚ â”‚
â”‚                 â”‚ â”‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼  â”‚               â”‚ â”‚
â”‚                 â”‚ â”‚           â”‚               â”‚ â”‚
â”‚                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â”‚
â”‚                 â”‚                               â”‚ â”‚
â”‚                 â”‚ [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]           â”‚ â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.5.3 ãƒœã‚¹ä½œæˆãƒ•ãƒ­ãƒ¼

```python
class StoryBossManager:
    def __init__(self, db_manager):
        self.db_manager = db_manager
        self.current_boss: Optional[StoryBoss] = None
        self.current_level = 1

    def select_boss_level(self, level: int):
        """ãƒœã‚¹ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠž"""
        self.current_level = level
        # æ—¢å­˜ãƒœã‚¹ã‚’èª­ã¿è¾¼ã¿
        boss = self.db_manager.get_story_boss(level)
        if boss:
            self.load_boss_data(boss)
        else:
            self.create_new_boss(level)

    def upload_image(self):
        """ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"""
        file_path = filedialog.askopenfilename(
            title="ãƒœã‚¹ç”»åƒã‚’é¸æŠž",
            filetypes=[("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«", "*.png *.jpg *.jpeg")]
        )
        if file_path:
            self.original_image_path = file_path
            self.preview_image(file_path)

    def generate_sprite(self):
        """ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆ (èƒŒæ™¯é™¤åŽ»)"""
        if not self.original_image_path:
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", "å…ˆã«ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„")
            return

        # ç”»åƒå‡¦ç†
        processor = ImageProcessor()
        sprite_path = processor.process_character_image(
            self.original_image_path,
            f"boss_lv{self.current_level}"
        )[1]

        self.sprite_path = sprite_path
        self.preview_image(sprite_path)

    def save_boss(self):
        """ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜"""
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if not self.validate_boss_stats():
            return

        boss = StoryBoss(
            level=self.current_level,
            name=self.name_entry.get(),
            hp=int(self.hp_entry.get()),
            attack=int(self.attack_entry.get()),
            defense=int(self.defense_entry.get()),
            speed=int(self.speed_entry.get()),
            magic=int(self.magic_entry.get()),
            luck=int(self.luck_entry.get()),
            description=self.desc_text.get("1.0", tk.END),
            image_path=self.original_image_path,
            sprite_path=self.sprite_path
        )

        # Google Sheetsã«ä¿å­˜
        self.db_manager.save_story_boss(boss)
        messagebox.showinfo("æˆåŠŸ", f"Lv{self.current_level} ãƒœã‚¹ã‚’ä¿å­˜ã—ã¾ã—ãŸ")

    def validate_boss_stats(self) -> bool:
        """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"""
        try:
            hp = int(self.hp_entry.get())
            attack = int(self.attack_entry.get())
            defense = int(self.defense_entry.get())
            speed = int(self.speed_entry.get())
            magic = int(self.magic_entry.get())
            luck = int(self.luck_entry.get())

            # ç¯„å›²ãƒã‚§ãƒƒã‚¯
            if not (50 <= hp <= 300):
                raise ValueError("HPã¯50-300ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„")
            if not (30 <= attack <= 200):
                raise ValueError("æ”»æ’ƒåŠ›ã¯30-200ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„")
            if not (20 <= defense <= 150):
                raise ValueError("é˜²å¾¡åŠ›ã¯20-150ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„")
            if not (40 <= speed <= 180):
                raise ValueError("é€Ÿã•ã¯40-180ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„")
            if not (10 <= magic <= 150):
                raise ValueError("é­”åŠ›ã¯10-150ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„")
            if not (0 <= luck <= 100):
                raise ValueError("é‹ã¯0-100ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„")

            # ç·åˆå€¤ãƒã‚§ãƒƒã‚¯
            total = hp + attack + defense + speed + magic + luck
            if total > 500:
                raise ValueError(f"ç·åˆå€¤ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ ({total}/500)")

            return True

        except ValueError as e:
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", str(e))
            return False
```

---

## 5.6 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤

### 5.6.1 èµ·å‹•æ–¹æ³•

**ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰:**
```
ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ â†’ ã‚²ãƒ¼ãƒ  â†’ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰
```

**ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠž:**
1. ç™»éŒ²æ¸ˆã¿ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
2. ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠž
3. ã€Œãƒãƒˆãƒ«é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

### 5.6.2 ãƒ—ãƒ¬ã‚¤ãƒ•ãƒ­ãƒ¼

```
[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠž]
      â†“
[ãƒãƒˆãƒ«é–‹å§‹]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lv1 æŒ‘æˆ¦ç”»é¢ (2ç§’)   â”‚
â”‚ "Lv1 ãƒœã‚¹"            â”‚
â”‚ "â—‹â—‹â—‹"               â”‚
â”‚ "æŒ‘æˆ¦ã—ã¾ã™ï¼"         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lv1 ãƒãƒˆãƒ«å®Ÿè¡Œ       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
    ã€å‹æ•—åˆ¤å®šã€‘
       â†“
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
 å‹åˆ©       æ•—åŒ—
   â”‚         â”‚
   â†“         â†“
[Lv2ã¸]  [ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼]
   â”‚
   â†“
[Lv2 æŒ‘æˆ¦ç”»é¢]
   ...
   â†“
[Lv5 ãƒãƒˆãƒ«]
   â†“
 å‹åˆ©
   â†“
[ã‚¯ãƒªã‚¢ç”»é¢]
```

### 5.6.3 ã‚¯ãƒªã‚¢ç”»é¢

```python
def _show_clear_screen(self):
    """ã‚¯ãƒªã‚¢ç”»é¢ã‚’è¡¨ç¤º"""
    clear_window = tk.Toplevel()
    clear_window.title("ã‚¯ãƒªã‚¢ï¼")
    clear_window.geometry("500x400")

    # ã‚¯ãƒªã‚¢è¡¨ç¤º
    tk.Label(clear_window, text="CLEAR!",
             font=("Arial", 48, "bold"), fg="gold").pack(pady=30)

    tk.Label(clear_window, text=f"{self.character.name} ã¯å…¨ã¦ã®ãƒœã‚¹ã‚’å€’ã—ã¾ã—ãŸï¼",
             font=("Arial", 18)).pack(pady=20)

    # çµ±è¨ˆæƒ…å ±
    stats_text = f"""
ç·æŒ‘æˆ¦å›žæ•°: {self.progress.attempts}
ã‚¯ãƒªã‚¢ãƒ¬ãƒ™ãƒ«: Lv5

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
    """
    tk.Label(clear_window, text=stats_text,
             font=("Arial", 14), justify=tk.LEFT).pack(pady=20)

    tk.Button(clear_window, text="é–‰ã˜ã‚‹",
              font=("Arial", 14),
              command=clear_window.destroy).pack(pady=20)
```

### 5.6.4 ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢

```python
def _show_game_over_screen(self, level: int):
    """ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤º"""
    game_over_window = tk.Toplevel()
    game_over_window.title("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼")
    game_over_window.geometry("500x400")

    # ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤º
    tk.Label(game_over_window, text="GAME OVER",
             font=("Arial", 48, "bold"), fg="red").pack(pady=30)

    tk.Label(game_over_window, text=f"Lv{level} ã§æ•—åŒ—ã—ã¾ã—ãŸ",
             font=("Arial", 18)).pack(pady=20)

    # çµ±è¨ˆæƒ…å ±
    stats_text = f"""
åˆ°é”ãƒ¬ãƒ™ãƒ«: Lv{level}
ç·æŒ‘æˆ¦å›žæ•°: {self.progress.attempts}

ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã™ã‹ï¼Ÿ
    """
    tk.Label(game_over_window, text=stats_text,
             font=("Arial", 14), justify=tk.LEFT).pack(pady=20)

    button_frame = tk.Frame(game_over_window)
    button_frame.pack(pady=20)

    tk.Button(button_frame, text="ãƒªãƒˆãƒ©ã‚¤",
              font=("Arial", 14),
              command=lambda: self._retry(game_over_window)).pack(side=tk.LEFT, padx=10)

    tk.Button(button_frame, text="é–‰ã˜ã‚‹",
              font=("Arial", 14),
              command=game_over_window.destroy).pack(side=tk.LEFT, padx=10)

def _retry(self, window):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªãƒˆãƒ©ã‚¤"""
    window.destroy()
    self.start_story_mode()
```

---

## 5.7 é€²è¡ŒçŠ¶æ³ç®¡ç†

### 5.7.1 é€²è¡ŒçŠ¶æ³ãƒªã‚»ãƒƒãƒˆ

**UIæ“ä½œ:**
```
ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”»é¢ â†’ [é€²è¡ŒçŠ¶æ³ãƒªã‚»ãƒƒãƒˆ] ãƒœã‚¿ãƒ³
```

**å®Ÿè£…:**
```python
def reset_story_progress(self):
    """é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ"""
    result = messagebox.askyesno(
        "ç¢ºèª",
        f"{self.character.name} ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n"
        "Lv1ã‹ã‚‰ã‚„ã‚Šç›´ã—ã«ãªã‚Šã¾ã™ã€‚"
    )

    if result:
        progress = self.load_progress()
        progress.reset()
        self.db_manager.save_story_progress(progress)
        messagebox.showinfo("æˆåŠŸ", "é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ")
        self.refresh_progress_display()
```

### 5.7.2 é€²è¡ŒçŠ¶æ³è¡¨ç¤º

```python
def display_story_progress(self, character: Character):
    """é€²è¡ŒçŠ¶æ³ã‚’è¡¨ç¤º"""
    progress = self.db_manager.get_story_progress(character.id)
    if not progress:
        return "æœªãƒ—ãƒ¬ã‚¤"

    if progress.completed:
        return f"ã‚¯ãƒªã‚¢æ¸ˆã¿ (æŒ‘æˆ¦å›žæ•°: {progress.attempts})"
    else:
        return f"Lv{progress.current_level} ã¾ã§åˆ°é” (æŒ‘æˆ¦å›žæ•°: {progress.attempts})"
```

---

## 5.8 ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (Google Sheets)

### 5.8.1 StoryBosses ã‚·ãƒ¼ãƒˆ

**åˆ—æ§‹æˆ (11åˆ—):**
| åˆ— | é …ç›® | ãƒ‡ãƒ¼ã‚¿åž‹ |
|----|------|---------|
| A | Level | 1-5 |
| B | Name | æ–‡å­—åˆ— |
| C | Image URL | URL (Google Drive) |
| D | Sprite URL | URL (Google Drive) |
| E | HP | 50-300 |
| F | Attack | 30-200 |
| G | Defense | 20-150 |
| H | Speed | 40-180 |
| I | Magic | 10-150 |
| J | Luck | 0-100 |
| K | Description | æ–‡å­—åˆ— |

### 5.8.2 StoryProgress ã‚·ãƒ¼ãƒˆ

**åˆ—æ§‹æˆ (6åˆ—):**
| åˆ— | é …ç›® | ãƒ‡ãƒ¼ã‚¿åž‹ |
|----|------|---------|
| A | Character ID | UUID |
| B | Current Level | 1-5 |
| C | Completed | TRUE/FALSE |
| D | Victories | ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Š (ä¾‹: "1,2,3") |
| E | Attempts | æ•´æ•° |
| F | Last Played | ISO8601å½¢å¼ |

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [06_DATA_MANAGEMENT.md](06_DATA_MANAGEMENT.md) ã§ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 06. ãƒ‡ãƒ¼ã‚¿ç®¡ç†

## 6.1 ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰

### 6.1.1 ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

**èµ·å‹•æ™‚ã®è‡ªå‹•åˆ¤å®š:**

```python
# src/services/sheets_manager.py

class SheetsManager:
    def __init__(self):
        self.online_mode = False
        try:
            # 1. credentials.jsonå­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if not os.path.exists(GOOGLE_CREDENTIALS_PATH):
                raise FileNotFoundError("credentials.json not found")

            # 2. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼
            credentials = service_account.Credentials.from_service_account_file(
                GOOGLE_CREDENTIALS_PATH,
                scopes=SCOPES
            )

            # 3. Google SheetsæŽ¥ç¶š
            self.client = gspread.authorize(credentials)
            self.sheet = self.client.open_by_key(SPREADSHEET_ID)

            # 4. ã‚·ãƒ¼ãƒˆåˆæœŸåŒ–
            self.initialize_sheets()

            self.online_mode = True
            logging.info("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸ")

        except Exception as e:
            logging.warning(f"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰æŽ¥ç¶šå¤±æ•—: {e}")
            logging.info("ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™")
            self.online_mode = False
```

### 6.1.2 ãƒ¢ãƒ¼ãƒ‰åˆ¥æ©Ÿèƒ½æ¯”è¼ƒ

| æ©Ÿèƒ½ | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ |
|------|-----------------|-----------------|
| ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† | âœ… Google Sheets | âœ… SQLite |
| ç”»åƒä¿å­˜ | âœ… Google Drive + ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ |
| ãƒãƒˆãƒ«å®Ÿè¡Œ | âœ… å¯èƒ½ | âœ… å¯èƒ½ |
| ãƒãƒˆãƒ«å±¥æ­´ | âœ… è¨˜éŒ²ã•ã‚Œã‚‹ | âŒ è¨˜éŒ²ã•ã‚Œãªã„ |
| ãƒ©ãƒ³ã‚­ãƒ³ã‚° | âœ… è‡ªå‹•æ›´æ–° | âŒ ãªã— |
| ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é€²è¡Œ | âœ… ä¿å­˜ã•ã‚Œã‚‹ | âŒ ä¿å­˜ã•ã‚Œãªã„ |
| ãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸ | âœ… å¯èƒ½ | âŒ ä¸å¯ |

---

## 6.2 Google Sheetsçµ±åˆ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

### 6.2.1 ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ§‹é€ 

**ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ:** 1ã¤ (SPREADSHEET_IDã§æŒ‡å®š)
**ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ:** 5æžš

```
OekakiBattler Spreadsheet
â”œâ”€â”€ Characters (15åˆ—)
â”œâ”€â”€ BattleHistory (15åˆ—)
â”œâ”€â”€ Rankings (10åˆ—)
â”œâ”€â”€ StoryBosses (11åˆ—)
â””â”€â”€ StoryProgress (6åˆ—)
```

### 6.2.2 Characters ã‚·ãƒ¼ãƒˆ

**åˆ—æ§‹æˆ:**
| åˆ— | é …ç›® | ãƒ‡ãƒ¼ã‚¿åž‹ | ä¾‹ |
|----|------|---------|-----|
| A | ID | UUID | 123e4567-e89b-12d3-a456-426614174000 |
| B | Name | æ–‡å­—åˆ— | å‹‡è€…ãã‚“ |
| C | Image URL | URL | https://drive.google.com/... |
| D | Sprite URL | URL | https://drive.google.com/... |
| E | HP | 10-200 | 150 |
| F | Attack | 10-150 | 80 |
| G | Defense | 10-100 | 60 |
| H | Speed | 10-100 | 70 |
| I | Magic | 10-100 | 50 |
| J | Luck | 0-100 | 40 |
| K | Description | æ–‡å­—åˆ— | å‰£ã‚’æŒã£ãŸå‹‡æ•¢ãªæˆ¦å£«... |
| L | Created At | ISO8601 | 2025-10-08T10:30:00 |
| M | Wins | æ•´æ•° | 15 |
| N | Losses | æ•´æ•° | 3 |
| O | Draws | æ•´æ•° | 2 |

**åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰:**
```python
def _initialize_characters_sheet(self):
    """Charactersã‚·ãƒ¼ãƒˆã‚’åˆæœŸåŒ–"""
    try:
        worksheet = self.sheet.worksheet("Characters")
    except gspread.exceptions.WorksheetNotFound:
        worksheet = self.sheet.add_worksheet("Characters", rows=1000, cols=15)

    # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
    headers = [
        "ID", "Name", "Image URL", "Sprite URL",
        "HP", "Attack", "Defense", "Speed", "Magic", "Luck",
        "Description", "Created At", "Wins", "Losses", "Draws"
    ]
    worksheet.update('A1:O1', [headers])
```

### 6.2.3 BattleHistory ã‚·ãƒ¼ãƒˆ

**åˆ—æ§‹æˆ:**
| åˆ— | é …ç›® | ãƒ‡ãƒ¼ã‚¿åž‹ |
|----|------|---------|
| A | Battle ID | UUID |
| B | Date | ISO8601 |
| C | Character1 ID | UUID |
| D | Character1 Name | æ–‡å­—åˆ— |
| E | Character2 ID | UUID |
| F | Character2 Name | æ–‡å­—åˆ— |
| G | Winner ID | UUID (NULLå¯) |
| H | Winner Name | æ–‡å­—åˆ— (NULLå¯) |
| I | Total Turns | æ•´æ•° |
| J | Duration (seconds) | æµ®å‹•å°æ•° |
| K | Char1 Final HP | æ•´æ•° |
| L | Char2 Final HP | æ•´æ•° |
| M | Char1 Damage Dealt | æ•´æ•° |
| N | Char2 Damage Dealt | æ•´æ•° |
| O | Result Type | KO/Time Limit/Draw |

**ãƒãƒˆãƒ«è¨˜éŒ²ä¾‹:**
```python
def save_battle_history(self, battle: Battle):
    """ãƒãƒˆãƒ«å±¥æ­´ã‚’ä¿å­˜"""
    worksheet = self.sheet.worksheet("BattleHistory")

    row = [
        battle.id,
        battle.created_at.isoformat(),
        battle.character1_id,
        battle.character1_name,
        battle.character2_id,
        battle.character2_name,
        battle.winner_id or "",
        battle.winner_name or "",
        battle.total_turns,
        battle.duration,
        battle.char1_final_hp,
        battle.char2_final_hp,
        battle.char1_damage_dealt,
        battle.char2_damage_dealt,
        battle.result_type
    ]

    worksheet.append_row(row)
```

### 6.2.4 Rankings ã‚·ãƒ¼ãƒˆ

**åˆ—æ§‹æˆ:**
| åˆ— | é …ç›® | è¨ˆç®—æ–¹æ³• |
|----|------|---------|
| A | Rank | é †ä½ (Ratingé †) |
| B | Character ID | UUID |
| C | Name | æ–‡å­—åˆ— |
| D | Total Battles | Wins + Losses + Draws |
| E | Wins | æ•´æ•° |
| F | Losses | æ•´æ•° |
| G | Draws | æ•´æ•° |
| H | Win Rate | Wins / Total Battles |
| I | Avg Damage | å¹³å‡ä¸Žãƒ€ãƒ¡ãƒ¼ã‚¸ |
| J | Rating | (Wins Ã— 3) + Draws |

**ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°:**
```python
def update_rankings(self):
    """ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°"""
    # å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    characters = self.get_all_characters()

    # ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é †ã«ã‚½ãƒ¼ãƒˆ
    characters.sort(key=lambda c: c.rating, reverse=True)

    # Rankingsã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
    rankings_sheet = self.sheet.worksheet("Rankings")
    rankings_sheet.clear()

    # ãƒ˜ãƒƒãƒ€ãƒ¼
    headers = [
        "Rank", "Character ID", "Name", "Total Battles",
        "Wins", "Losses", "Draws", "Win Rate", "Avg Damage", "Rating"
    ]
    rankings_sheet.update('A1:J1', [headers])

    # ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
    rows = []
    for rank, char in enumerate(characters, start=1):
        total_battles = char.wins + char.losses + char.draws
        win_rate = char.wins / total_battles if total_battles > 0 else 0
        avg_damage = self._calculate_avg_damage(char.id)

        rows.append([
            rank,
            char.id,
            char.name,
            total_battles,
            char.wins,
            char.losses,
            char.draws,
            f"{win_rate:.2%}",
            avg_damage,
            char.rating
        ])

    # ä¸€æ‹¬æ›¸ãè¾¼ã¿ (APIå‘¼ã³å‡ºã—å‰Šæ¸›)
    if rows:
        rankings_sheet.update(f'A2:J{len(rows)+1}', rows)
```

### 6.2.5 ãƒãƒƒãƒæ›´æ–°ã«ã‚ˆã‚‹æœ€é©åŒ–

**å•é¡Œ:** Google Sheets APIã¯100 requests/100ç§’ã®åˆ¶é™ã‚ã‚Š

**è§£æ±ºç­–:** ãƒãƒƒãƒæ›´æ–°ã‚’ä½¿ç”¨

```python
def bulk_import_characters(self, characters: list[Character]):
    """è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸€æ‹¬ç™»éŒ²"""
    worksheet = self.sheet.worksheet("Characters")

    # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®è¡Œæ•°ã‚’å–å¾—
    current_rows = len(worksheet.get_all_values())

    # ãƒ‡ãƒ¼ã‚¿æº–å‚™
    rows = []
    for char in characters:
        row = [
            char.id, char.name, char.image_path, char.sprite_path,
            char.hp, char.attack, char.defense, char.speed,
            char.magic, char.luck, char.description,
            char.created_at.isoformat(),
            char.wins, char.losses, char.draws
        ]
        rows.append(row)

    # ä¸€æ‹¬æ›¸ãè¾¼ã¿ (1å›žã®APIå‘¼ã³å‡ºã—)
    start_row = current_rows + 1
    end_row = start_row + len(rows) - 1
    worksheet.update(f'A{start_row}:O{end_row}', rows)
```

---

## 6.3 Google Driveçµ±åˆ

### 6.3.1 Drive APIè¨­å®š

**ã‚¹ã‚³ãƒ¼ãƒ—:**
```python
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/drive'
]
```

**åˆæœŸåŒ–:**
```python
from googleapiclient.discovery import build

def __init__(self):
    # ... (Sheetsèªè¨¼å¾Œ)
    self.drive_service = build('drive', 'v3', credentials=credentials)
    self.drive_folder_id = DRIVE_FOLDER_ID  # .envã‹ã‚‰å–å¾—
```

### 6.3.2 ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```python
def upload_image_to_drive(self, image_path: str, file_name: str) -> str:
    """ç”»åƒã‚’Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

    Args:
        image_path: ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒãƒ‘ã‚¹
        file_name: Driveã§ã®ãƒ•ã‚¡ã‚¤ãƒ«å

    Returns:
        å…¬é–‹URL
    """
    file_metadata = {
        'name': file_name,
        'mimeType': 'image/png'
    }

    # ãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šãŒã‚ã‚‹å ´åˆ
    if self.drive_folder_id:
        file_metadata['parents'] = [self.drive_folder_id]

    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    from googleapiclient.http import MediaFileUpload
    media = MediaFileUpload(image_path, mimetype='image/png')

    file = self.drive_service.files().create(
        body=file_metadata,
        media_body=media,
        fields='id, webViewLink'
    ).execute()

    file_id = file['id']

    # å…¬é–‹è¨­å®š
    self.drive_service.permissions().create(
        fileId=file_id,
        body={'type': 'anyone', 'role': 'reader'}
    ).execute()

    # ç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURL
    public_url = f"https://drive.google.com/uc?id={file_id}"

    return public_url
```

### 6.3.3 ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**ç›®çš„:** APIå‘¼ã³å‡ºã—å‰Šæ¸›ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ

**å®Ÿè£…:**
```python
def get_sprite_image(self, character: Character) -> str:
    """ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒã‚’å–å¾— (ã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆ)

    Returns:
        ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¹
    cache_path = f"data/sprites/{character.id}_sprite.png"

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if os.path.exists(cache_path):
        return cache_path

    # ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: Driveã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    if self.online_mode and character.sprite_path.startswith("http"):
        self._download_from_drive(character.sprite_path, cache_path)
        return cache_path

    # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹
    return character.sprite_path

def _download_from_drive(self, drive_url: str, save_path: str):
    """DriveURLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""
    import requests

    # URLå¤‰æ›: webViewLink â†’ ç›´æŽ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL
    file_id = self._extract_file_id(drive_url)
    download_url = f"https://drive.google.com/uc?export=download&id={file_id}"

    response = requests.get(download_url)
    with open(save_path, 'wb') as f:
        f.write(response.content)

def _extract_file_id(self, url: str) -> str:
    """DriveURLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡º"""
    if 'id=' in url:
        return url.split('id=')[1].split('&')[0]
    elif '/d/' in url:
        return url.split('/d/')[1].split('/')[0]
    else:
        raise ValueError(f"Invalid Drive URL: {url}")
```

---

## 6.4 SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

### 6.4.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `data/database.db`

**ãƒ†ãƒ¼ãƒ–ãƒ«:**

```sql
-- characters ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE characters (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    image_path TEXT,
    sprite_path TEXT,
    hp INTEGER,
    attack INTEGER,
    defense INTEGER,
    speed INTEGER,
    magic INTEGER,
    luck INTEGER,
    description TEXT,
    created_at TIMESTAMP,
    wins INTEGER DEFAULT 0,
    losses INTEGER DEFAULT 0,
    draws INTEGER DEFAULT 0
);

-- battles ãƒ†ãƒ¼ãƒ–ãƒ« (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä½¿ç”¨ã—ãªã„)
CREATE TABLE battles (
    id TEXT PRIMARY KEY,
    character1_id TEXT,
    character2_id TEXT,
    winner_id TEXT,
    created_at TIMESTAMP
);
```

### 6.4.2 SQLAlchemy ãƒ¢ãƒ‡ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«:** `config/database.py`

```python
from sqlalchemy import create_engine, Column, String, Integer, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

class CharacterDB(Base):
    __tablename__ = 'characters'

    id = Column(String, primary_key=True)
    name = Column(String, nullable=False)
    image_path = Column(String)
    sprite_path = Column(String)
    hp = Column(Integer)
    attack = Column(Integer)
    defense = Column(Integer)
    speed = Column(Integer)
    magic = Column(Integer)
    luck = Column(Integer)
    description = Column(String)
    created_at = Column(DateTime)
    wins = Column(Integer, default=0)
    losses = Column(Integer, default=0)
    draws = Column(Integer, default=0)

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
engine = create_engine('sqlite:///data/database.db')
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)
```

### 6.4.3 DatabaseManager ã‚¯ãƒ©ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/database_manager.py`

```python
class DatabaseManager:
    def __init__(self):
        self.online_mode = False
        self.session = Session()

    def add_character(self, character: Character):
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ """
        char_db = CharacterDB(
            id=character.id,
            name=character.name,
            image_path=character.image_path,
            sprite_path=character.sprite_path,
            hp=character.hp,
            attack=character.attack,
            defense=character.defense,
            speed=character.speed,
            magic=character.magic,
            luck=character.luck,
            description=character.description,
            created_at=character.created_at,
            wins=character.wins,
            losses=character.losses,
            draws=character.draws
        )
        self.session.add(char_db)
        self.session.commit()

    def get_all_characters(self) -> list[Character]:
        """å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—"""
        char_dbs = self.session.query(CharacterDB).all()
        return [self._db_to_model(char_db) for char_db in char_dbs]

    def update_character(self, character: Character):
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ›´æ–°"""
        char_db = self.session.query(CharacterDB).filter_by(id=character.id).first()
        if char_db:
            char_db.wins = character.wins
            char_db.losses = character.losses
            char_db.draws = character.draws
            self.session.commit()

    def delete_character(self, character_id: str):
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤"""
        char_db = self.session.query(CharacterDB).filter_by(id=character_id).first()
        if char_db:
            self.session.delete(char_db)
            self.session.commit()

    def _db_to_model(self, char_db: CharacterDB) -> Character:
        """DBãƒ¢ãƒ‡ãƒ«ã‚’Pydanticãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›"""
        return Character(
            id=char_db.id,
            name=char_db.name,
            image_path=char_db.image_path,
            sprite_path=char_db.sprite_path,
            hp=char_db.hp,
            attack=char_db.attack,
            defense=char_db.defense,
            speed=char_db.speed,
            magic=char_db.magic,
            luck=char_db.luck,
            description=char_db.description,
            created_at=char_db.created_at,
            wins=char_db.wins,
            losses=char_db.losses,
            draws=char_db.draws
        )
```

---

## 6.5 ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

### 6.5.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
data/
â”œâ”€â”€ database.db              # SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”œâ”€â”€ characters/              # ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒ
â”‚   â”œâ”€â”€ {uuid}_original.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ sprites/                 # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒ
â”‚   â”œâ”€â”€ {uuid}_sprite.png
â”‚   â””â”€â”€ ...
â””â”€â”€ story_bosses/            # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹ç”»åƒ
    â”œâ”€â”€ boss_lv1_original.png
    â”œâ”€â”€ boss_lv1_sprite.png
    â””â”€â”€ ...
```

### 6.5.2 ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

**ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:**
- ã‚ªãƒªã‚¸ãƒŠãƒ«: `{character_id}_original.{ext}`
- ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ: `{character_id}_sprite.png`

**ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹:**
- ã‚ªãƒªã‚¸ãƒŠãƒ«: `boss_lv{level}_original.{ext}`
- ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ: `boss_lv{level}_sprite.png`

### 6.5.3 ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

```python
# src/utils/file_utils.py

import os
import shutil
from pathlib import Path

class FileManager:
    def __init__(self):
        self.data_dir = Path("data")
        self.characters_dir = self.data_dir / "characters"
        self.sprites_dir = self.data_dir / "sprites"
        self.bosses_dir = self.data_dir / "story_bosses"

        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        self.characters_dir.mkdir(parents=True, exist_ok=True)
        self.sprites_dir.mkdir(parents=True, exist_ok=True)
        self.bosses_dir.mkdir(parents=True, exist_ok=True)

    def save_character_image(self, src_path: str, character_id: str,
                             image_type: str = "original") -> str:
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’ä¿å­˜

        Args:
            src_path: å…ƒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
            character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
            image_type: "original" or "sprite"

        Returns:
            ä¿å­˜å…ˆãƒ‘ã‚¹
        """
        ext = Path(src_path).suffix
        if image_type == "original":
            dest_path = self.characters_dir / f"{character_id}_original{ext}"
        else:
            dest_path = self.sprites_dir / f"{character_id}_sprite.png"

        shutil.copy2(src_path, dest_path)
        return str(dest_path)

    def delete_character_files(self, character_id: str):
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"""
        # ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒ
        for ext in ['.png', '.jpg', '.jpeg']:
            original = self.characters_dir / f"{character_id}_original{ext}"
            if original.exists():
                original.unlink()

        # ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ
        sprite = self.sprites_dir / f"{character_id}_sprite.png"
        if sprite.exists():
            sprite.unlink()
```

---

## 6.6 ãƒ‡ãƒ¼ã‚¿åŒæœŸã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### 6.6.1 ã‚ªãƒ³ãƒ©ã‚¤ãƒ³â†’ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ

**ã‚·ãƒŠãƒªã‚ª:** ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ä½œæ¥­ã™ã‚‹ãŸã‚ã€äº‹å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```python
def sync_online_to_offline(self):
    """ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«åŒæœŸ"""
    if not self.sheets_manager.online_mode:
        raise Exception("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“")

    # å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    characters = self.sheets_manager.get_all_characters()

    # SQLiteã«ä¿å­˜
    db_manager = DatabaseManager()
    for char in characters:
        # ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        if char.sprite_path.startswith("http"):
            local_sprite = self._download_sprite(char)
            char.sprite_path = local_sprite

        db_manager.add_character(char)

    print(f"{len(characters)} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’åŒæœŸã—ã¾ã—ãŸ")
```

### 6.6.2 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³â†’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸ

**ã‚·ãƒŠãƒªã‚ª:** ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½œæˆã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```python
def sync_offline_to_online(self):
    """ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«åŒæœŸ"""
    if not self.sheets_manager.online_mode:
        raise Exception("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“")

    # SQLiteã‹ã‚‰å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    db_manager = DatabaseManager()
    local_characters = db_manager.get_all_characters()

    # ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
    online_characters = self.sheets_manager.get_all_characters()
    online_ids = {char.id for char in online_characters}

    # æ–°è¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    new_characters = [char for char in local_characters if char.id not in online_ids]

    for char in new_characters:
        # ç”»åƒã‚’Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if not char.sprite_path.startswith("http"):
            sprite_url = self.sheets_manager.upload_image_to_drive(
                char.sprite_path,
                f"{char.id}_sprite.png"
            )
            char.sprite_path = sprite_url

        self.sheets_manager.save_character(char)

    print(f"{len(new_characters)} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ")
```

### 6.6.3 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

**Google Sheetsè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:**
- Google Driveã®ç‰ˆç®¡ç†æ©Ÿèƒ½ã§è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹
- ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œç‰ˆã®å±¥æ­´ã€â†’ã€Œç‰ˆã®å±¥æ­´ã‚’è¡¨ç¤ºã€ã§å¾©å…ƒå¯èƒ½

**SQLiteãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:**
```bash
# æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp data/database.db data/database_backup_$(date +%Y%m%d).db

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
python scripts/backup_database.py
```

**ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹:**
```python
# scripts/backup_database.py

import shutil
from datetime import datetime
from pathlib import Path

def backup_database():
    src = Path("data/database.db")
    if not src.exists():
        print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    dest = Path(f"data/backups/database_{timestamp}.db")
    dest.parent.mkdir(exist_ok=True)

    shutil.copy2(src, dest)
    print(f"ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: {dest}")

if __name__ == "__main__":
    backup_database()
```

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [07_LINE_BOT.md](07_LINE_BOT.md) ã§LINE Boté€£æºã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 07. LINE Boté€£æº

## 7.1 LINE Bot ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 7.1.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
[LINEãƒ¦ãƒ¼ã‚¶ãƒ¼]
      â†“ ç”»åƒé€ä¿¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LINE Platform    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ Webhook (HTTPS)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ngrok Tunnel     â”‚
â”‚ (ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨)  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node.js Server           â”‚
â”‚ (Express + LINE SDK)     â”‚
â”‚ - Webhookå—ä¿¡            â”‚
â”‚ - ç”»åƒãƒã‚¤ãƒŠãƒªå–å¾—        â”‚
â”‚ - GASã¸è»¢é€              â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ HTTPS POST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Apps Script (GAS) â”‚
â”‚ - ç”»åƒã‚’Driveã«ä¿å­˜       â”‚
â”‚ - Sheetsã«è¨˜éŒ²            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.1.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLINEã§ç”»åƒé€ä¿¡
   â†“
2. LINE PlatformãŒwebhookã‚’é€ä¿¡
   {
     "type": "message",
     "message": {
       "type": "image",
       "id": "message_id"
     }
   }
   â†“
3. Node.jsã‚µãƒ¼ãƒãƒ¼ãŒWebhookå—ä¿¡
   â†“
4. LINE Messaging APIã‹ã‚‰ç”»åƒå–å¾—
   GET https://api-data.line.me/v2/bot/message/{messageId}/content
   â†“
5. ç”»åƒã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
   â†“
6. GASã«POST
   {
     "image": "data:image/jpeg;base64,/9j/4AAQ...",
     "userId": "U1234567890abcdef...",
     "timestamp": "2025-10-08T10:30:00Z"
   }
   â†“
7. GASãŒç”»åƒã‚’Driveã«ä¿å­˜
   â†“
8. GASãŒSheetsã«è¨˜éŒ²
   â†“
9. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å®Œäº†é€šçŸ¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
```

---

## 7.2 Node.js ã‚µãƒ¼ãƒãƒ¼

### 7.2.1 server.js å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«:** `server/server.js`

```javascript
const express = require('express');
const line = require('@line/bot-sdk');
const axios = require('axios');
require('dotenv').config();

// ç’°å¢ƒå¤‰æ•°
const config = {
  channelSecret: process.env.LINE_CHANNEL_SECRET,
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN
};

const GAS_WEBHOOK_URL = process.env.GAS_WEBHOOK_URL;
const SHARED_SECRET = process.env.SHARED_SECRET;
const PORT = process.env.PORT || 3000;

// Express ã‚¢ãƒ—ãƒª
const app = express();

// LINE SDK ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
const client = new line.Client(config);

// Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/webhook', line.middleware(config), (req, res) => {
  Promise
    .all(req.body.events.map(handleEvent))
    .then((result) => res.json(result))
    .catch((err) => {
      console.error(err);
      res.status(500).end();
    });
});

// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
async function handleEvent(event) {
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å‡¦ç†
  if (event.type !== 'message') {
    return Promise.resolve(null);
  }

  // ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å‡¦ç†
  if (event.message.type !== 'image') {
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: 'ç”»åƒã‚’é€ä¿¡ã—ã¦ãã ã•ã„'
    });
  }

  try {
    // ç”»åƒå–å¾—
    const imageBuffer = await getImageContent(event.message.id);

    // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    const base64Image = imageBuffer.toString('base64');
    const dataUrl = `data:image/jpeg;base64,${base64Image}`;

    // GASã«é€ä¿¡
    const gasResponse = await sendToGAS({
      image: dataUrl,
      userId: event.source.userId,
      timestamp: new Date(event.timestamp).toISOString()
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ä¿¡
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: `ç”»åƒã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼\nDriveã«ä¿å­˜ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å: ${gasResponse.fileName}`
    });

  } catch (error) {
    console.error('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚'
    });
  }
}

// LINE Messaging APIã‹ã‚‰ç”»åƒã‚’å–å¾—
async function getImageContent(messageId) {
  const url = `https://api-data.line.me/v2/bot/message/${messageId}/content`;

  const response = await axios.get(url, {
    headers: {
      'Authorization': `Bearer ${config.channelAccessToken}`
    },
    responseType: 'arraybuffer'
  });

  return Buffer.from(response.data);
}

// GASã«ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
async function sendToGAS(data) {
  const response = await axios.post(GAS_WEBHOOK_URL, {
    ...data,
    secret: SHARED_SECRET  // èªè¨¼ç”¨
  }, {
    headers: {
      'Content-Type': 'application/json'
    }
  });

  return response.data;
}

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
app.listen(PORT, () => {
  console.log(`Server listening on port ${PORT}`);
  console.log(`Webhook URL: http://localhost:${PORT}/webhook`);
});
```

### 7.2.2 package.json

```json
{
  "name": "oekaki-battler-line-bot",
  "version": "1.0.0",
  "description": "LINE Bot for OekakiBattler",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "@line/bot-sdk": "^7.5.0",
    "express": "^4.18.2",
    "axios": "^1.4.0",
    "dotenv": "^16.0.3"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}
```

### 7.2.3 ç’°å¢ƒå¤‰æ•°è¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«:** `server/.env`

```bash
# LINEãƒãƒ£ãƒãƒ«è¨­å®š
LINE_CHANNEL_SECRET=your_channel_secret_here
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here

# Google Apps Script Webhook
GAS_WEBHOOK_URL=https://script.google.com/macros/s/YOUR_GAS_ID/exec

# å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ (GASèªè¨¼ç”¨)
SHARED_SECRET=your_shared_secret_here

# ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆ
PORT=3000
```

---

## 7.3 Google Apps Script (GAS)

### 7.3.1 GAS ã‚³ãƒ¼ãƒ‰

**Google Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã§ä½œæˆ:**

```javascript
// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
const SPREADSHEET_ID = 'your_spreadsheet_id';
const SHEET_NAME = 'LINE_Uploads';

// Driveãƒ•ã‚©ãƒ«ãƒ€ID
const DRIVE_FOLDER_ID = 'your_drive_folder_id';

// å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ (Node.jsã‚µãƒ¼ãƒãƒ¼ã¨åŒã˜å€¤)
const SHARED_SECRET = 'your_shared_secret_here';

function doPost(e) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£è§£æž
    const data = JSON.parse(e.postData.contents);

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (data.secret !== SHARED_SECRET) {
      return ContentService.createTextOutput(JSON.stringify({
        error: 'Unauthorized'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // ç”»åƒãƒ‡ãƒ¼ã‚¿å–å¾—
    const imageData = data.image;  // data:image/jpeg;base64,xxxxx
    const userId = data.userId;
    const timestamp = data.timestamp;

    // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
    const base64Data = imageData.split(',')[1];
    const blob = Utilities.newBlob(
      Utilities.base64Decode(base64Data),
      'image/jpeg',
      `line_${userId}_${Date.now()}.jpg`
    );

    // Driveã«ä¿å­˜
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const file = folder.createFile(blob);

    // å…¬é–‹è¨­å®š
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // ãƒ•ã‚¡ã‚¤ãƒ«URL
    const fileUrl = file.getUrl();
    const fileName = file.getName();

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);

    // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['Timestamp', 'User ID', 'File Name', 'File URL']);
    }

    // ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
    sheet.appendRow([
      timestamp,
      userId,
      fileName,
      fileUrl
    ]);

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      fileName: fileName,
      fileUrl: fileUrl
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('Error: ' + error.toString());

    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
```

### 7.3.2 GAS ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

**1. Google Apps Scriptä½œæˆ:**
```
1. https://script.google.com/ ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ã€ŒOekakiBattler LINE Botã€ã«å¤‰æ›´
4. ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘
5. SPREADSHEET_ID, DRIVE_FOLDER_ID, SHARED_SECRET ã‚’è¨­å®š
```

**2. Webã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤:**
```
1. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€
2. ç¨®é¡ž: Webã‚¢ãƒ—ãƒª
3. èª¬æ˜Ž: LINE Bot Webhook
4. æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œ: è‡ªåˆ†
5. ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼: å…¨å“¡
6. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
7. Webã‚¢ãƒ—ãƒª URL ã‚’ã‚³ãƒ”ãƒ¼ (ä¾‹: https://script.google.com/macros/s/XXXXX/exec)
```

**3. URLã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š:**
```bash
# server/.env
GAS_WEBHOOK_URL=https://script.google.com/macros/s/XXXXX/exec
```

---

## 7.4 ngrok è¨­å®š

### 7.4.1 ngrok ã¨ã¯

- **ç›®çš„:** ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’å¤–éƒ¨ã‹ã‚‰HTTPSã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
- **ç”¨é€”:** LINE Webhookã¯HTTPSå¿…é ˆã®ãŸã‚ã€é–‹ç™ºç’°å¢ƒã§å¿…è¦

### 7.4.2 ngrokèµ·å‹•

```bash
# ngrokã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆ
ngrok http 3000

# å‡ºåŠ›ä¾‹:
# Forwarding  https://xxxx-xx-xx-xxx-xxx.ngrok.io -> http://localhost:3000
```

### 7.4.3 Webhook URLè¨­å®š

**LINE Developers Console:**
```
1. https://developers.line.biz/console/ ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒãƒ£ãƒãƒ«ã‚’é¸æŠž
3. ã€ŒMessaging APIè¨­å®šã€ã‚¿ãƒ–
4. Webhookè¨­å®š â†’ Webhook URL
5. ngrokã®HTTPS URLã‚’å…¥åŠ›
   ä¾‹: https://xxxx-xx-xx-xxx-xxx.ngrok.io/webhook
6. ã€Œæ¤œè¨¼ã€ãƒœã‚¿ãƒ³ã§æŽ¥ç¶šç¢ºèª
7. ã€ŒWebhookã®åˆ©ç”¨ã€ã‚’ã‚ªãƒ³
```

### 7.4.4 èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**macOS/Linux (`server_up.sh`):**
```bash
#!/bin/bash

echo "Starting ngrok..."
ngrok http 3000 &

sleep 5

echo "Starting Node.js server..."
cd server
node server.js
```

**Windows (`server_up.bat`):**
```batch
@echo off
echo Starting ngrok...
start ngrok http 3000

timeout /t 5

echo Starting Node.js server...
cd server
node server.js
```

---

## 7.5 ä½¿ã„æ–¹

### 7.5.1 ã‚µãƒ¼ãƒãƒ¼èµ·å‹•

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§
./server_up.sh  # macOS/Linux
# ã¾ãŸã¯
server_up.bat   # Windows
```

**ç¢ºèªäº‹é …:**
- âœ… ngrokãŒèµ·å‹•ã—ã¦HTTPS URLãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… Node.jsã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹• (`Server listening on port 3000`)
- âœ… LINE Developers Consoleã§Webhookæ¤œè¨¼ãŒæˆåŠŸ

### 7.5.2 ç”»åƒé€ä¿¡ãƒ†ã‚¹ãƒˆ

**æ‰‹é †:**
1. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ 
2. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’é€ä¿¡
3. Botã‹ã‚‰ã€Œç”»åƒã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ä¿¡ã•ã‚Œã‚‹
4. Google Driveã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
5. Google Sheetsã® `LINE_Uploads` ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### 7.5.3 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**WebhookãŒå±Šã‹ãªã„:**
```bash
# ngrok URLãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ç¢ºèª
# ç„¡æ–™ç‰ˆngrokã¯å†èµ·å‹•ã™ã‚‹ã¨ URLãŒå¤‰ã‚ã‚‹
# â†’ LINE Developers Consoleã§Webhook URLã‚’æ›´æ–°
```

**ç”»åƒãŒä¿å­˜ã•ã‚Œãªã„:**
```bash
# GASãƒ­ã‚°ã‚’ç¢ºèª
# Google Apps Script ã‚¨ãƒ‡ã‚£ã‚¿ â†’ å®Ÿè¡Œãƒ­ã‚°
# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
```

**èªè¨¼ã‚¨ãƒ©ãƒ¼:**
```bash
# server/.env ã¨ GASã® SHARED_SECRET ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª
```

---

## 7.6 å°†æ¥ã®æ‹¡å¼µæ©Ÿèƒ½

### 7.6.1 ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒžãƒ³ãƒ‰å¯¾å¿œ

**ä¾‹: ãƒãƒˆãƒ«ã‚³ãƒžãƒ³ãƒ‰**
```javascript
// server.js ã«è¿½åŠ 

if (event.message.type === 'text') {
  const text = event.message.text;

  if (text === 'ãƒãƒˆãƒ«') {
    // ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒˆãƒ«ã‚’å®Ÿè¡Œ
    // çµæžœã‚’LINEã«è¿”ä¿¡
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: 'å‹‡è€…ãã‚“ vs é­”çŽ‹\nå‹è€…: å‹‡è€…ãã‚“'
    });
  }

  if (text === 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°') {
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
    // çµæžœã‚’LINEã«è¿”ä¿¡
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: '1ä½: å‹‡è€…ãã‚“ (Rating: 45)\n2ä½: é­”çŽ‹ (Rating: 30)'
    });
  }
}
```

### 7.6.2 ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼å¯¾å¿œ

**LINE Developers Consoleã§è¨­å®š:**
```
1. Messaging APIè¨­å®š â†’ ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼
2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®:
   - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ² (ç”»åƒé€ä¿¡ã‚’ä¿ƒã™)
   - ãƒãƒˆãƒ«é–‹å§‹ (ãƒ†ã‚­ã‚¹ãƒˆ "ãƒãƒˆãƒ«" é€ä¿¡)
   - ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ãƒ†ã‚­ã‚¹ãƒˆ "ãƒ©ãƒ³ã‚­ãƒ³ã‚°" é€ä¿¡)
   - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ (ãƒ†ã‚­ã‚¹ãƒˆ "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼" é€ä¿¡)
```

### 7.6.3 Flex Message ã«ã‚ˆã‚‹ãƒªãƒƒãƒãªçµæžœè¡¨ç¤º

```javascript
// ãƒãƒˆãƒ«çµæžœã‚’Flex Messageã§é€ä¿¡
const flexMessage = {
  type: 'flex',
  altText: 'ãƒãƒˆãƒ«çµæžœ',
  contents: {
    type: 'bubble',
    header: {
      type: 'box',
      layout: 'vertical',
      contents: [
        {
          type: 'text',
          text: 'ãƒãƒˆãƒ«çµæžœ',
          weight: 'bold',
          size: 'xl'
        }
      ]
    },
    body: {
      type: 'box',
      layout: 'vertical',
      contents: [
        {
          type: 'text',
          text: 'å‹è€…: å‹‡è€…ãã‚“',
          size: 'lg',
          color: '#FFD700'
        },
        {
          type: 'text',
          text: 'ã‚¿ãƒ¼ãƒ³æ•°: 25'
        },
        {
          type: 'text',
          text: 'å‹‡è€…ãã‚“ HP: 50 â†’ 15'
        },
        {
          type: 'text',
          text: 'é­”çŽ‹ HP: 80 â†’ 0'
        }
      ]
    }
  }
};

return client.replyMessage(event.replyToken, flexMessage);
```

---

## 7.7 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 7.7.1 Webhookæ¤œè¨¼

**LINE Signatureæ¤œè¨¼ (LINE SDKãŒè‡ªå‹•ã§å®Ÿæ–½):**
```javascript
// line.middleware(config) ãŒç½²åæ¤œè¨¼ã‚’å®Ÿæ–½
// ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•çš„ã«æ‹’å¦ã•ã‚Œã‚‹
```

### 7.7.2 GASèªè¨¼

**å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ–¹å¼:**
```javascript
// GASå´ã§èªè¨¼ãƒã‚§ãƒƒã‚¯
if (data.secret !== SHARED_SECRET) {
  return ContentService.createTextOutput(JSON.stringify({
    error: 'Unauthorized'
  })).setMimeType(ContentService.MimeType.JSON);
}
```

### 7.7.3 ç’°å¢ƒå¤‰æ•°ç®¡ç†

**âš ï¸ çµ¶å¯¾ã«Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„:**
```bash
# .gitignore ã«è¿½åŠ 
server/.env
```

**æœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨:**
```bash
# Heroku, Renderç­‰ã®PaaSã§ã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®š
heroku config:set LINE_CHANNEL_SECRET=xxxxx
```

---

## 7.8 æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

### 7.8.1 Heroku ãƒ‡ãƒ—ãƒ­ã‚¤

**æ‰‹é †:**
```bash
# 1. Herokuã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
heroku login

# 2. Herokuã‚¢ãƒ—ãƒªä½œæˆ
heroku create oekaki-battler-linebot

# 3. ç’°å¢ƒå¤‰æ•°è¨­å®š
heroku config:set LINE_CHANNEL_SECRET=xxxxx
heroku config:set LINE_CHANNEL_ACCESS_TOKEN=xxxxx
heroku config:set GAS_WEBHOOK_URL=xxxxx
heroku config:set SHARED_SECRET=xxxxx

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤
git subtree push --prefix server heroku main

# 5. Webhook URLæ›´æ–°
# LINE Developers Console:
# https://oekaki-battler-linebot.herokuapp.com/webhook
```

### 7.8.2 Render ãƒ‡ãƒ—ãƒ­ã‚¤

**æ‰‹é †:**
```
1. https://render.com/ ã«ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
2. New â†’ Web Service
3. ãƒªãƒã‚¸ãƒˆãƒªã‚’æŽ¥ç¶š
4. Root Directory: server
5. Build Command: npm install
6. Start Command: node server.js
7. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
8. ãƒ‡ãƒ—ãƒ­ã‚¤
9. Webhook URLã‚’æ›´æ–°
```

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [08_TROUBLESHOOTING.md](08_TROUBLESHOOTING.md) ã§ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 08. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## 8.1 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–¢é€£ã®å•é¡Œ

### 8.1.1 Python ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `Microsoft Visual C++ 14.0 is required`**

**åŽŸå› :** Windowsç’°å¢ƒã§Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```powershell
# Visual Studio Build Tools ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# https://visualstudio.microsoft.com/visual-cpp-build-tools/
# "C++ build tools" ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€å†åº¦è©¦è¡Œ
pip install -r requirements.txt
```

---

**ã‚¨ãƒ©ãƒ¼: `error: command 'gcc' failed`**

**åŽŸå› :** Linuxç’°å¢ƒã§ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ãŒä¸è¶³

**è§£æ±ºæ–¹æ³•:**
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install build-essential python3-dev

# Fedora/RHEL
sudo dnf install gcc python3-devel

# å†åº¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt
```

---

**ã‚¨ãƒ©ãƒ¼: `ImportError: No module named 'tkinter'`**

**åŽŸå› :** TkinterãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ (Linux)

**è§£æ±ºæ–¹æ³•:**
```bash
# Ubuntu/Debian
sudo apt-get install python3-tk

# Fedora/RHEL
sudo dnf install python3-tkinter

# ç¢ºèª
python3 -m tkinter
```

---

### 8.1.2 OpenCV é–¢é€£ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `ImportError: libGL.so.1: cannot open shared object file`**

**åŽŸå› :** OpenCVã«å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä¸è¶³ (Linux)

**è§£æ±ºæ–¹æ³•:**
```bash
sudo apt-get install libgl1-mesa-glx libglib2.0-0
```

---

**ã‚¨ãƒ©ãƒ¼: `cv2.error: (-215:Assertion failed)`**

**åŽŸå› :** ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã€ã¾ãŸã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å½¢å¼

**è§£æ±ºæ–¹æ³•:**
```python
# ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
from PIL import Image
img = Image.open("your_image.png")
img.verify()  # ç ´æãƒã‚§ãƒƒã‚¯

# åˆ¥ã®å½¢å¼ã§ä¿å­˜ã—ã¦ãƒªãƒˆãƒ©ã‚¤
img = Image.open("your_image.jpg")
img.save("your_image_converted.png", "PNG")
```

---

## 8.2 Google API é–¢é€£ã®å•é¡Œ

### 8.2.1 Google Sheets æŽ¥ç¶šã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `gspread.exceptions.APIError: ... PERMISSION_DENIED`**

**åŽŸå› :** ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…±æœ‰ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```
1. credentials.json ã‚’é–‹ã„ã¦ "client_email" ã®å€¤ã‚’ã‚³ãƒ”ãƒ¼
   ä¾‹: oekaki-battler@project-id.iam.gserviceaccount.com

2. Google Sheetsã§å…±æœ‰è¨­å®š
   - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
   - å³ä¸Šã®ã€Œå…±æœ‰ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ã‚³ãƒ”ãƒ¼ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ 
   - æ¨©é™: ç·¨é›†è€…
   - ã€Œé€ä¿¡ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
```

---

**ã‚¨ãƒ©ãƒ¼: `FileNotFoundError: [Errno 2] No such file or directory: 'credentials.json'`**

**åŽŸå› :** credentials.jsonãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«å­˜åœ¨ã—ãªã„

**è§£æ±ºæ–¹æ³•:**
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
ls credentials.json

# å­˜åœ¨ã—ãªã„å ´åˆ
# 1. Google Cloud Console â†’ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ â†’ ã‚­ãƒ¼ä½œæˆ
# 2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ credentials.json ã«ãƒªãƒãƒ¼ãƒ 
# 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«é…ç½®
cp ~/Downloads/project-xxx-yyy.json ./credentials.json
```

---

**ã‚¨ãƒ©ãƒ¼: `gspread.exceptions.SpreadsheetNotFound`**

**åŽŸå› :** SPREADSHEET_ID ãŒé–“é•ã£ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```bash
# ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‹ã‚‰æ­£ã—ã„IDã‚’å–å¾—
# URLä¾‹: https://docs.google.com/spreadsheets/d/1AbC123XyZ.../edit
# SPREADSHEET_ID = 1AbC123XyZ...

# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ä¿®æ­£
nano .env

# æ­£ã—ã„IDã‚’è¨­å®š
SPREADSHEET_ID=1AbC123XyZ...
```

---

### 8.2.2 Google Drive ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `HttpError 403: The user does not have sufficient permissions`**

**åŽŸå› :** Drive APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```
1. Google Cloud Console ã«ã‚¢ã‚¯ã‚»ã‚¹
   https://console.cloud.google.com/

2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠž

3. APIã¨ã‚µãƒ¼ãƒ“ã‚¹ â†’ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

4. "Google Drive API" ã‚’æ¤œç´¢

5. ã€Œæœ‰åŠ¹ã«ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
```

---

**ã‚¨ãƒ©ãƒ¼: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒé…ã„**

**åŽŸå› :** å¤§ããªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```python
# ç”»åƒã‚’äº‹å‰ã«ãƒªã‚µã‚¤ã‚º
from PIL import Image

img = Image.open("large_image.png")
img.thumbnail((1000, 1000))  # æœ€å¤§1000x1000ã«ãƒªã‚µã‚¤ã‚º
img.save("resized_image.png", optimize=True)
```

---

### 8.2.3 Google Gemini AI ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼: `google.api_core.exceptions.PermissionDenied: ... API_KEY_INVALID`**

**åŽŸå› :** API ã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯è¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
cat .env | grep GOOGLE_API_KEY

# API ã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèª
# Google AI Studio ã§æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ
# https://makersuite.google.com/app/apikey

# .env ã‚’æ›´æ–°
nano .env
GOOGLE_API_KEY=AIzaSy...
```

---

**ã‚¨ãƒ©ãƒ¼: `google.api_core.exceptions.ResourceExhausted: ... QUOTA_EXCEEDED`**

**åŽŸå› :** APIã‚¯ã‚©ãƒ¼ã‚¿(ä½¿ç”¨é‡åˆ¶é™)ã‚’è¶…éŽ

**è§£æ±ºæ–¹æ³•:**
```
1. Google Cloud Console â†’ APIã¨ã‚µãƒ¼ãƒ“ã‚¹ â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
2. "Generative Language API" ã®ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèª
3. ç¿Œæ—¥ã¾ã§å¾…ã¤ã€ã¾ãŸã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
```

---

**ã‚¨ãƒ©ãƒ¼: AIè§£æžãŒå¤±æ•—ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒä½¿ç”¨ã•ã‚Œã‚‹**

**åŽŸå› :** ç”»åƒãŒå°ã•ã™ãŽã‚‹ã€ã¾ãŸã¯ä¸é®®æ˜Ž

**è§£æ±ºæ–¹æ³•:**
```python
# ã‚ˆã‚Šé«˜è§£åƒåº¦ã®ç”»åƒã‚’ä½¿ç”¨
# æœ€å°æŽ¨å¥¨ã‚µã‚¤ã‚º: 300x300px

# æ‰‹å‹•ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
# (å°†æ¥å®Ÿè£…äºˆå®šã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†æ©Ÿèƒ½)
```

---

## 8.3 ãƒãƒˆãƒ«é–¢é€£ã®å•é¡Œ

### 8.3.1 ãƒãƒˆãƒ«ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ã‚¨ãƒ©ãƒ¼: `pygame.error: No available video device`**

**åŽŸå› :** ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãŒæ¤œå‡ºã•ã‚Œãªã„ (ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ç­‰)

**è§£æ±ºæ–¹æ³•:**
```bash
# Linuxã§ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ç’°å¢ƒã®å ´åˆ
export SDL_VIDEODRIVER=dummy

# ã¾ãŸã¯ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’ä½¿ç”¨
sudo apt-get install xvfb
xvfb-run python main.py
```

---

**ã‚¨ãƒ©ãƒ¼: Pygameã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã‹ãªã„ (macOS)**

**åŽŸå› :** Retina ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å•é¡Œ

**è§£æ±ºæ–¹æ³•:**
```python
# main_menu.py ã® PygameåˆæœŸåŒ–éƒ¨åˆ†ã‚’ä¿®æ­£
import os
os.environ['SDL_VIDEO_WINDOW_POS'] = "0,0"

# ã¾ãŸã¯è§£åƒåº¦ã‚’èª¿æ•´
screen = pygame.display.set_mode((1024, 768), pygame.SCALED)
```

---

### 8.3.2 ãƒãƒˆãƒ«ãŒãƒ•ãƒªãƒ¼ã‚ºã™ã‚‹

**ç—‡çŠ¶:** ãƒãƒˆãƒ«ä¸­ã«ç”»é¢ãŒå›ºã¾ã‚‹

**åŽŸå› :** ç„¡é™ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®å•é¡Œ

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’ç¢ºèª
def _execute_turn(self):
    # Pygameã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’è¿½åŠ 
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            return False

    # ... (ãƒãƒˆãƒ«å‡¦ç†)
```

---

**ç—‡çŠ¶:** ãƒãƒˆãƒ«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŽŸå› :** ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿å¤±æ•—

**è§£æ±ºæ–¹æ³•:**
```python
# æ—¥æœ¬èªžãƒ•ã‚©ãƒ³ãƒˆã‚’æ˜Žç¤ºçš„ã«æŒ‡å®š
import pygame.font

# Windowsã®å ´åˆ
font_path = "C:/Windows/Fonts/msgothic.ttc"

# macOSã®å ´åˆ
font_path = "/System/Library/Fonts/ãƒ’ãƒ©ã‚®ãƒŽè§’ã‚´ã‚·ãƒƒã‚¯ W4.ttc"

# Linuxã®å ´åˆ
font_path = "/usr/share/fonts/truetype/noto/NotoSansCJK-Regular.ttc"

if os.path.exists(font_path):
    self.font_jp = pygame.font.Font(font_path, 28)
else:
    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    self.font_jp = pygame.font.SysFont('arial', 28)
```

---

## 8.4 ãƒ‡ãƒ¼ã‚¿é–¢é€£ã®å•é¡Œ

### 8.4.1 ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ãªã„

**ç—‡çŠ¶:** å¸¸ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹

**è¨ºæ–­:**
```python
# Pythonã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ã§ç¢ºèª
from src.services.sheets_manager import SheetsManager

manager = SheetsManager()
print(f"Online Mode: {manager.online_mode}")

# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
import logging
logging.basicConfig(level=logging.DEBUG)
manager = SheetsManager()
```

**è§£æ±ºæ–¹æ³•:**
```
1. credentials.json ã®å­˜åœ¨ç¢ºèª
2. .env ã® SPREADSHEET_ID ç¢ºèª
3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå…±æœ‰è¨­å®šç¢ºèª
4. Google Sheets API æœ‰åŠ¹åŒ–ç¢ºèª
5. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šç¢ºèª
```

---

### 8.4.2 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶:** ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ãŒç©º

**åŽŸå› 1:** ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©º

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒ‡ãƒ¼ã‚¿ç¢ºèª
from src.services.sheets_manager import SheetsManager

manager = SheetsManager()
characters = manager.get_all_characters()
print(f"Characters: {len(characters)}")

# ç©ºã®å ´åˆã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç™»éŒ²
```

---

**åŽŸå› 2:** ç”»åƒãƒ‘ã‚¹ãŒä¸æ­£

**è§£æ±ºæ–¹æ³•:**
```python
# ç”»åƒãƒ‘ã‚¹ã‚’ç¢ºèª
for char in characters:
    print(f"{char.name}: {char.sprite_path}")
    if not os.path.exists(char.sprite_path):
        print(f"  â†’ å­˜åœ¨ã—ã¾ã›ã‚“ï¼")

# ãƒ‘ã‚¹ã‚’ä¿®æ­£ (æ‰‹å‹•ã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ)
```

---

### 8.4.3 ãƒãƒˆãƒ«å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œãªã„

**ç—‡çŠ¶:** BattleHistoryã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œãªã„

**åŽŸå› :** ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒ¢ãƒ¼ãƒ‰ç¢ºèª
print(f"Online Mode: {self.db_manager.online_mode}")

# ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
# â†’ 8.4.1 ã®æ‰‹é †ã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
```

---

## 8.5 ç”»åƒå‡¦ç†ã®å•é¡Œ

### 8.5.1 èƒŒæ™¯ãŒé™¤åŽ»ã•ã‚Œãªã„

**ç—‡çŠ¶:** èƒŒæ™¯é™¤åŽ»å¾Œã‚‚ç™½èƒŒæ™¯ãŒæ®‹ã‚‹

**åŽŸå› :** èƒŒæ™¯ãŒå®Œå…¨ãªç™½ã§ã¯ãªã„

**è§£æ±ºæ–¹æ³•:**
```python
# é–¾å€¤ã‚’èª¿æ•´
# src/services/image_processor.py

def remove_background(self, image_path: str, threshold: int = 230):
    # threshold ã‚’ 240 â†’ 230 ã«ä¸‹ã’ã‚‹
    # ã‚ˆã‚Šåºƒã„ç¯„å›²ã‚’èƒŒæ™¯ã¨ã—ã¦èªè­˜
```

---

**ç—‡çŠ¶:** ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä¸€éƒ¨ãŒé€æ˜Žã«ãªã‚‹

**åŽŸå› :** é–¾å€¤ãŒä½Žã™ãŽã‚‹

**è§£æ±ºæ–¹æ³•:**
```python
# é–¾å€¤ã‚’ä¸Šã’ã‚‹
def remove_background(self, image_path: str, threshold: int = 245):
    # threshold ã‚’ä¸Šã’ã¦ã€ã‚ˆã‚Šç™½ã„éƒ¨åˆ†ã®ã¿é™¤åŽ»
```

---

### 8.5.2 ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡ºãŒãŠã‹ã—ã„

**ç—‡çŠ¶:** ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒåˆ‡ã‚Œã¦ã„ã‚‹

**åŽŸå› :** ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®è¨ˆç®—ãƒŸã‚¹

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒžãƒ¼ã‚¸ãƒ³ã‚’å¢—ã‚„ã™
def extract_sprite(self, image: Image) -> Image:
    # ...
    margin = 20  # 10 â†’ 20 ã«å¢—ã‚„ã™
    # ...
```

---

**ç—‡çŠ¶:** ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆãŒå°ã•ã™ãŽã‚‹/å¤§ãã™ãŽã‚‹

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒªã‚µã‚¤ã‚ºã‚µã‚¤ã‚ºã‚’èª¿æ•´
# src/services/image_processor.py

self.max_sprite_size = (400, 400)  # (300, 300) â†’ (400, 400)
```

---

## 8.6 LINE Bot ã®å•é¡Œ

### 8.6.1 Webhook ãŒå±Šã‹ãªã„

**ç—‡çŠ¶:** LINEã§ç”»åƒã‚’é€ä¿¡ã—ã¦ã‚‚åå¿œãŒãªã„

**è¨ºæ–­:**
```bash
# Node.jsã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèª
# "POST /webhook" ã¨ã„ã†ãƒ­ã‚°ãŒå‡ºã¦ã„ã‚‹ã‹ï¼Ÿ

# å‡ºã¦ã„ãªã„å ´åˆ:
# â†’ LINE Developers Console ã§ Webhook URL ã‚’ç¢ºèª
# â†’ ngrok URL ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ç¢ºèª
```

**è§£æ±ºæ–¹æ³•:**
```bash
# ngrok ã‚’å†èµ·å‹•
pkill ngrok
ngrok http 3000

# æ–°ã—ã„ URL ã‚’ LINE Developers Console ã«è¨­å®š
# Messaging APIè¨­å®š â†’ Webhook URL
# ä¾‹: https://xxxx-new-url.ngrok.io/webhook
```

---

### 8.6.2 ç”»åƒãŒä¿å­˜ã•ã‚Œãªã„

**ç—‡çŠ¶:** Botã¯åå¿œã™ã‚‹ãŒã€Driveã«ç”»åƒãŒä¿å­˜ã•ã‚Œãªã„

**åŽŸå› :** GAS ã®ã‚¨ãƒ©ãƒ¼

**è¨ºæ–­:**
```
1. Google Apps Script ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã
2. å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª (ç”»é¢ä¸‹éƒ¨)
3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
```

**ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼:**
- `PERMISSION_DENIED`: Driveãƒ•ã‚©ãƒ«ãƒ€IDãŒé–“é•ã£ã¦ã„ã‚‹
- `Unauthorized`: SHARED_SECRET ãŒä¸€è‡´ã—ã¦ã„ãªã„
- `Invalid argument`: ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒä¸æ­£

**è§£æ±ºæ–¹æ³•:**
```javascript
// GAS ã‚³ãƒ¼ãƒ‰ã§ãƒ­ã‚°è¿½åŠ 
function doPost(e) {
  Logger.log('Received data: ' + e.postData.contents);
  try {
    // ...
  } catch (error) {
    Logger.log('Error: ' + error.toString());
    Logger.log('Stack trace: ' + error.stack);
  }
}
```

---

### 8.6.3 ngrok ãŒé »ç¹ã«åˆ‡æ–­ã•ã‚Œã‚‹

**ç—‡çŠ¶:** ç„¡æ–™ç‰ˆ ngrok ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ2æ™‚é–“ã§åˆ‡ã‚Œã‚‹

**è§£æ±ºæ–¹æ³•:**
```bash
# ngrok ã‚’è‡ªå‹•å†èµ·å‹•ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# watch_ngrok.sh

#!/bin/bash
while true; do
    ngrok http 3000
    echo "ngrok disconnected. Restarting in 5 seconds..."
    sleep 5
done
```

**æœ¬ç•ªç’°å¢ƒã®å ´åˆ:**
```
# Heroku, Renderç­‰ã®PaaSã«ãƒ‡ãƒ—ãƒ­ã‚¤
# â†’ æ°¸ç¶šçš„ãªHTTPS URLãŒæä¾›ã•ã‚Œã‚‹
```

---

## 8.7 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®å•é¡Œ

### 8.7.1 èµ·å‹•ãŒé…ã„

**ç—‡çŠ¶:** ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã«30ç§’ä»¥ä¸Šã‹ã‹ã‚‹

**åŽŸå› :** Google Sheets ã‹ã‚‰å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```python
# èµ·å‹•æ™‚ã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ãšã€å¿…è¦æ™‚ã«å–å¾—
# main_menu.py

def __init__(self):
    # èµ·å‹•æ™‚ã¯æŽ¥ç¶šç¢ºèªã®ã¿
    self.db_manager = SheetsManager()
    # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã¯é…å»¶ãƒ­ãƒ¼ãƒ‰
    self.characters = None

def get_characters(self):
    if self.characters is None:
        self.characters = self.db_manager.get_all_characters()
    return self.characters
```

---

### 8.7.2 ãƒãƒˆãƒ«ãŒé‡ã„

**ç—‡çŠ¶:** ãƒãƒˆãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚«ã‚¯ã¤ã

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™
# battle_engine.py

clock = pygame.time.Clock()

while self._execute_turn():
    # ...
    pygame.display.flip()
    clock.tick(30)  # 30 FPSã«åˆ¶é™
```

---

### 8.7.3 Google Sheets APIåˆ¶é™

**ç—‡çŠ¶:** `RATE_LIMIT_EXCEEDED` ã‚¨ãƒ©ãƒ¼

**åŽŸå› :** 100 requests/100ç§’ã®åˆ¶é™ã‚’è¶…éŽ

**è§£æ±ºæ–¹æ³•:**
```python
# ãƒãƒƒãƒæ›´æ–°ã‚’ä½¿ç”¨
# sheets_manager.py

def update_multiple_characters(self, characters):
    """è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸€æ‹¬æ›´æ–°"""
    worksheet = self.sheet.worksheet("Characters")

    # å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã«å–å¾—
    all_data = worksheet.get_all_records()

    # æ›´æ–°å¯¾è±¡ã‚’ç‰¹å®š
    updates = []
    for char in characters:
        for i, row in enumerate(all_data, start=2):  # ãƒ˜ãƒƒãƒ€ãƒ¼é™¤ã
            if row['ID'] == char.id:
                updates.append({
                    'range': f'M{i}:O{i}',
                    'values': [[char.wins, char.losses, char.draws]]
                })

    # ä¸€æ‹¬æ›´æ–° (1å›žã®APIå‘¼ã³å‡ºã—)
    worksheet.batch_update(updates)
```

---

## 8.8 ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### 8.8.1 ãƒ­ã‚°å‡ºåŠ›

**åŸºæœ¬çš„ãªãƒ­ã‚°è¨­å®š:**
```python
# main.py ã®å†’é ­ã«è¿½åŠ 
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('oekaki_battler.log'),
        logging.StreamHandler()
    ]
)
```

**å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ãƒ­ã‚°ä½¿ç”¨:**
```python
import logging

logger = logging.getLogger(__name__)

def some_function():
    logger.debug("ãƒ‡ãƒãƒƒã‚°æƒ…å ±")
    logger.info("æƒ…å ±")
    logger.warning("è­¦å‘Š")
    logger.error("ã‚¨ãƒ©ãƒ¼")
```

---

### 8.8.2 å¯¾è©±åž‹ãƒ‡ãƒãƒƒã‚°

```python
# ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã§å¯¾è©±ã‚·ã‚§ãƒ«ã‚’èµ·å‹•
import pdb

def buggy_function():
    # ...
    pdb.set_trace()  # ã“ã“ã§ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ
    # ...

# å®Ÿè¡Œã™ã‚‹ã¨ pdb ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
# ã‚³ãƒžãƒ³ãƒ‰:
#   n: æ¬¡ã®è¡Œ
#   s: ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³
#   c: ç¶šè¡Œ
#   p variable: å¤‰æ•°è¡¨ç¤º
#   q: çµ‚äº†
```

---

### 8.8.3 ä¾‹å¤–ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯

```python
import traceback

try:
    risky_operation()
except Exception as e:
    logger.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
    logger.error(traceback.format_exc())
    # ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    with open('error_trace.txt', 'w') as f:
        f.write(traceback.format_exc())
```

---

## 8.9 ã‚ˆãã‚ã‚‹è³ªå• (FAQ)

### Q1: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã«ã¯ï¼Ÿ

**A:** è‡ªå‹•åˆ¤å®šã•ã‚Œã¾ã™ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ã«ã¯:
```
1. credentials.json ã‚’é…ç½®
2. .env ã« SPREADSHEET_ID ã‚’è¨­å®š
3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å…±æœ‰
4. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•
```

---

### Q2: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ãŸã„

**A:** ç¾åœ¨ã¯æ‰‹å‹•å‰Šé™¤ã®ã¿ã‚µãƒãƒ¼ãƒˆ:
```python
# Pythonã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ã§å®Ÿè¡Œ
from src.services.sheets_manager import SheetsManager

manager = SheetsManager()
manager.delete_character("character_id_here")
```

---

### Q3: ãƒãƒˆãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸã„

**A:** ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¨­å®šã‹ã‚‰å¤‰æ›´å¯èƒ½:
```
ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ è¨­å®š â†’ ãƒãƒˆãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰ â†’ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§èª¿æ•´ (0.1-2.0ç§’)
```

---

### Q4: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸã„

**A:** ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”»é¢ã‹ã‚‰:
```
ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ â†’ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠž â†’ é€²è¡ŒçŠ¶æ³ãƒªã‚»ãƒƒãƒˆ
```

---

### Q5: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã©ã“ã«ã‚ã‚‹ï¼Ÿ

**A:**
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°
cat oekaki_battler.log

# LINE Bot ãƒ­ã‚°
# ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹

# GAS ãƒ­ã‚°
# Google Apps Script ã‚¨ãƒ‡ã‚£ã‚¿ â†’ å®Ÿè¡Œãƒ­ã‚°
```

---

## æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³

æ¬¡ã¯ [09_API_REFERENCE.md](09_API_REFERENCE.md) ã§APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚


================================================================================

# 09. API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ä¸»è¦ãªã‚¯ãƒ©ã‚¹ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã®è©³ç´°ãªä»•æ§˜ã‚’æä¾›ã—ã¾ã™ã€‚

---

## 9.1 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« (Pydantic)

### 9.1.1 Character

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/models/character.py`

```python
class Character(BaseModel):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«"""

    # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    id: str
    name: str
    image_path: str
    sprite_path: str
    hp: int = Field(ge=10, le=200)
    attack: int = Field(ge=10, le=150)
    defense: int = Field(ge=10, le=100)
    speed: int = Field(ge=10, le=100)
    magic: int = Field(ge=10, le=100)
    luck: int = Field(ge=0, le=100)
    description: str
    created_at: datetime

    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    wins: int = Field(default=0, ge=0)
    losses: int = Field(default=0, ge=0)
    draws: int = Field(default=0, ge=0)
```

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:**

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | åž‹ | èª¬æ˜Ž |
|-----------|-----|------|
| `total_stats` | `int` | å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆè¨ˆ (â‰¤350) |
| `win_rate` | `float` | å‹çŽ‡ (0.0-1.0) |
| `rating` | `int` | ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (WinsÃ—3 + Draws) |

**ä½¿ç”¨ä¾‹:**
```python
from src.models.character import Character
from datetime import datetime
import uuid

character = Character(
    id=str(uuid.uuid4()),
    name="å‹‡è€…ãã‚“",
    image_path="data/characters/xxx_original.png",
    sprite_path="data/sprites/xxx_sprite.png",
    hp=150,
    attack=80,
    defense=60,
    speed=70,
    magic=50,
    luck=40,
    description="å‰£ã‚’æŒã£ãŸå‹‡æ•¢ãªæˆ¦å£«",
    created_at=datetime.now()
)

print(f"Total Stats: {character.total_stats}")  # 450
print(f"Win Rate: {character.win_rate}")       # 0.0 (åˆæœŸå€¤)
```

---

### 9.1.2 Battle

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/models/battle.py`

```python
class BattleTurn(BaseModel):
    """ãƒãƒˆãƒ«ã®1ã‚¿ãƒ¼ãƒ³æƒ…å ±"""
    turn_number: int
    attacker_name: str
    defender_name: str
    damage: int
    is_critical: bool = False
    is_guard_break: bool = False
    is_magic: bool = False
    is_evaded: bool = False
    attacker_hp: int
    defender_hp: int

class Battle(BaseModel):
    """ãƒãƒˆãƒ«çµæžœãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«"""
    id: str
    character1_id: str
    character1_name: str
    character2_id: str
    character2_name: str
    winner_id: Optional[str]
    winner_name: Optional[str]
    battle_log: list[str]
    turns: list[BattleTurn]
    duration: float
    created_at: datetime

    # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
    total_turns: int
    char1_final_hp: int
    char2_final_hp: int
    char1_damage_dealt: int
    char2_damage_dealt: int
    result_type: str  # "KO", "Time Limit", "Draw"
```

**ä½¿ç”¨ä¾‹:**
```python
from src.models.battle import Battle, BattleTurn

battle = Battle(
    id=str(uuid.uuid4()),
    character1_id=char1.id,
    character1_name=char1.name,
    character2_id=char2.id,
    character2_name=char2.name,
    winner_id=char1.id,
    winner_name=char1.name,
    battle_log=["å‹‡è€…ãã‚“ã®æ”»æ’ƒï¼", "30ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"],
    turns=[
        BattleTurn(
            turn_number=1,
            attacker_name="å‹‡è€…ãã‚“",
            defender_name="é­”çŽ‹",
            damage=30,
            is_critical=False,
            is_guard_break=False,
            is_magic=False,
            is_evaded=False,
            attacker_hp=150,
            defender_hp=120
        )
    ],
    duration=45.5,
    created_at=datetime.now(),
    total_turns=25,
    char1_final_hp=50,
    char2_final_hp=0,
    char1_damage_dealt=200,
    char2_damage_dealt=100,
    result_type="KO"
)
```

---

### 9.1.3 StoryBoss

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/models/story_boss.py`

```python
class StoryBoss(BaseModel):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«"""
    level: int = Field(ge=1, le=5)
    name: str
    hp: int = Field(ge=50, le=300)
    attack: int = Field(ge=30, le=200)
    defense: int = Field(ge=20, le=150)
    speed: int = Field(ge=40, le=180)
    magic: int = Field(ge=10, le=150)
    luck: int = Field(ge=0, le=100)
    description: str
    image_path: Optional[str] = None
    sprite_path: Optional[str] = None
```

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:**
| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | åž‹ | èª¬æ˜Ž |
|-----------|-----|------|
| `total_stats` | `int` | å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆè¨ˆ (â‰¤500) |

---

### 9.1.4 StoryProgress

```python
class StoryProgress(BaseModel):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é€²è¡ŒçŠ¶æ³"""
    character_id: str
    current_level: int = Field(default=1, ge=1, le=5)
    completed: bool = False
    victories: list[int] = Field(default_factory=list)
    attempts: int = 0
    last_played: datetime = Field(default_factory=datetime.now)

    def add_victory(self, level: int):
        """ãƒœã‚¹æ’ƒç ´ã‚’è¨˜éŒ²"""

    def reset(self):
        """é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ"""
```

---

## 9.2 ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹

### 9.2.1 SheetsManager (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/sheets_manager.py`

```python
class SheetsManager:
    """Google Sheets ãƒ‡ãƒ¼ã‚¿ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼"""

    def __init__(self):
        """åˆæœŸåŒ–ã¨Google SheetsæŽ¥ç¶š"""

    @property
    def online_mode(self) -> bool:
        """ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹"""
```

#### ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ“ä½œ

```python
def get_all_characters(self) -> list[Character]:
    """å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—

    Returns:
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
    """

def get_character_by_id(self, character_id: str) -> Optional[Character]:
    """IDã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—

    Args:
        character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID (UUID)

    Returns:
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å­˜åœ¨ã—ãªã„å ´åˆNone
    """

def save_character(self, character: Character):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¿å­˜ (æ–°è¦ã¾ãŸã¯æ›´æ–°)

    Args:
        character: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """

def update_character(self, character: Character):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ›´æ–° (æˆ¦ç¸¾æ›´æ–°ç­‰)

    Args:
        character: æ›´æ–°ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    """

def delete_character(self, character_id: str):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤

    Args:
        character_id: å‰Šé™¤ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
    """

def bulk_import_characters(self, characters: list[Character]):
    """è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸€æ‹¬ç™»éŒ² (APIå‘¼ã³å‡ºã—å‰Šæ¸›)

    Args:
        characters: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
    """
```

#### ãƒãƒˆãƒ«å±¥æ­´æ“ä½œ

```python
def save_battle_history(self, battle: Battle):
    """ãƒãƒˆãƒ«å±¥æ­´ã‚’ä¿å­˜

    Args:
        battle: ãƒãƒˆãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """

def get_battle_history(self, character_id: Optional[str] = None,
                       limit: int = 100) -> list[Battle]:
    """ãƒãƒˆãƒ«å±¥æ­´å–å¾—

    Args:
        character_id: ç‰¹å®šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å±¥æ­´ã®ã¿å–å¾— (Noneã§å…¨ä»¶)
        limit: å–å¾—ä»¶æ•°ä¸Šé™

    Returns:
        ãƒãƒˆãƒ«å±¥æ­´ãƒªã‚¹ãƒˆ
    """
```

#### ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ“ä½œ

```python
def update_rankings(self):
    """ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–° (å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è±¡)"""

def get_rankings(self, limit: int = 10) -> list[dict]:
    """ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—

    Args:
        limit: å–å¾—ä»¶æ•°

    Returns:
        ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ (dictå½¢å¼)
    """
```

#### ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰æ“ä½œ

```python
def get_story_boss(self, level: int) -> Optional[StoryBoss]:
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹å–å¾—

    Args:
        level: ãƒœã‚¹ãƒ¬ãƒ™ãƒ« (1-5)

    Returns:
        ãƒœã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€å­˜åœ¨ã—ãªã„å ´åˆNone
    """

def save_story_boss(self, boss: StoryBoss):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœã‚¹ä¿å­˜

    Args:
        boss: ãƒœã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """

def get_story_progress(self, character_id: str) -> Optional[StoryProgress]:
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡ŒçŠ¶æ³å–å¾—

    Args:
        character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID

    Returns:
        é€²è¡ŒçŠ¶æ³ã€å­˜åœ¨ã—ãªã„å ´åˆNone
    """

def save_story_progress(self, progress: StoryProgress):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡ŒçŠ¶æ³ä¿å­˜

    Args:
        progress: é€²è¡ŒçŠ¶æ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """
```

#### Google Driveæ“ä½œ

```python
def upload_image_to_drive(self, image_path: str, file_name: str) -> str:
    """ç”»åƒã‚’Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

    Args:
        image_path: ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒãƒ‘ã‚¹
        file_name: Driveã§ã®ãƒ•ã‚¡ã‚¤ãƒ«å

    Returns:
        å…¬é–‹URL
    """

def download_image_from_drive(self, drive_url: str, save_path: str):
    """DriveURLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

    Args:
        drive_url: Drive URL
        save_path: ä¿å­˜å…ˆãƒ‘ã‚¹
    """
```

---

### 9.2.2 DatabaseManager (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/database_manager.py`

```python
class DatabaseManager:
    """SQLite ãƒ‡ãƒ¼ã‚¿ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼"""

    def __init__(self):
        """SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–"""

    @property
    def online_mode(self) -> bool:
        """å¸¸ã«False (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰)"""
        return False
```

#### ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ“ä½œ

```python
def add_character(self, character: Character):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ 

    Args:
        character: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """

def get_all_characters(self) -> list[Character]:
    """å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—

    Returns:
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
    """

def get_character_by_id(self, character_id: str) -> Optional[Character]:
    """IDã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—

    Args:
        character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID

    Returns:
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å­˜åœ¨ã—ãªã„å ´åˆNone
    """

def update_character(self, character: Character):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ›´æ–°

    Args:
        character: æ›´æ–°ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    """

def delete_character(self, character_id: str):
    """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤

    Args:
        character_id: å‰Šé™¤ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
    """
```

---

### 9.2.3 AIAnalyzer

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/ai_analyzer.py`

```python
class AIAnalyzer:
    """Google Gemini AI ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è§£æž"""

    def __init__(self):
        """Gemini AIåˆæœŸåŒ–"""

    def analyze_character(self, image_path: str) -> dict:
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’è§£æžã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ

        Args:
            image_path: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

        Returns:
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¾žæ›¸
            {
                'hp': int,
                'attack': int,
                'defense': int,
                'speed': int,
                'magic': int,
                'luck': int,
                'description': str
            }

        Raises:
            Exception: APIå‘¼ã³å‡ºã—å¤±æ•—æ™‚
        """
```

**å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰:**
```python
def _build_prompt(self) -> str:
    """AIç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰"""

def _extract_json(self, response_text: str) -> str:
    """ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡º"""

def _validate_stats(self, stats: dict) -> dict:
    """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»èª¿æ•´"""

def _default_stats(self) -> dict:
    """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (AIå¤±æ•—æ™‚)"""
```

---

### 9.2.4 ImageProcessor

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/image_processor.py`

```python
class ImageProcessor:
    """ç”»åƒå‡¦ç† (èƒŒæ™¯é™¤åŽ»ãƒ»ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º)"""

    def __init__(self):
        self.max_sprite_size = (300, 300)
        self.background_threshold = 240

    def remove_background(self, image_path: str,
                          output_path: str,
                          threshold: int = 240) -> str:
        """èƒŒæ™¯é™¤åŽ»

        Args:
            image_path: å…¥åŠ›ç”»åƒãƒ‘ã‚¹
            output_path: å‡ºåŠ›ç”»åƒãƒ‘ã‚¹
            threshold: èƒŒæ™¯åˆ¤å®šé–¾å€¤ (0-255)

        Returns:
            å‡ºåŠ›ãƒ‘ã‚¹
        """

    def extract_sprite(self, image_path: str,
                       output_path: str) -> str:
        """ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º (è¼ªéƒ­æ¤œå‡º + ãƒˆãƒªãƒŸãƒ³ã‚°)

        Args:
            image_path: å…¥åŠ›ç”»åƒãƒ‘ã‚¹ (é€éŽPNGæŽ¨å¥¨)
            output_path: å‡ºåŠ›ãƒ‘ã‚¹

        Returns:
            å‡ºåŠ›ãƒ‘ã‚¹
        """

    def process_character_image(self,
                                 original_path: str,
                                 character_id: str) -> tuple[str, str]:
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’å‡¦ç† (èƒŒæ™¯é™¤åŽ» + ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆæŠ½å‡º)

        Args:
            original_path: ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒãƒ‘ã‚¹
            character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID

        Returns:
            (ã‚ªãƒªã‚¸ãƒŠãƒ«ä¿å­˜ãƒ‘ã‚¹, ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆä¿å­˜ãƒ‘ã‚¹)
        """
```

---

### 9.2.5 BattleEngine

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/battle_engine.py`

```python
class BattleEngine:
    """ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³"""

    def __init__(self,
                 character1: Character,
                 character2: Character,
                 battle_speed: float = 1.0):
        """åˆæœŸåŒ–

        Args:
            character1: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼1
            character2: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2
            battle_speed: ãƒãƒˆãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰ (0.1-2.0ç§’/ã‚¿ãƒ¼ãƒ³)
        """

    def execute_battle(self) -> Battle:
        """ãƒãƒˆãƒ«ã‚’å®Ÿè¡Œ

        Returns:
            ãƒãƒˆãƒ«çµæžœ
        """
```

**å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰:**
```python
def _execute_turn(self) -> bool:
    """1ã‚¿ãƒ¼ãƒ³å®Ÿè¡Œ

    Returns:
        ç¶™ç¶šã™ã‚‹å ´åˆTrueã€çµ‚äº†ã™ã‚‹å ´åˆFalse
    """

def _perform_attack(self,
                    attacker: Character,
                    defender: Character) -> int:
    """æ”»æ’ƒã‚’å®Ÿè¡Œ

    Args:
        attacker: æ”»æ’ƒå´
        defender: é˜²å¾¡å´

    Returns:
        ä¸Žãƒ€ãƒ¡ãƒ¼ã‚¸
    """

def _calculate_damage(self,
                      attacker: Character,
                      defender: Character,
                      is_magic: bool,
                      is_critical: bool = False,
                      is_guard_break: bool = False) -> int:
    """ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—

    Args:
        attacker: æ”»æ’ƒå´
        defender: é˜²å¾¡å´
        is_magic: é­”æ³•æ”»æ’ƒã‹
        is_critical: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‹
        is_guard_break: ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ã‹

    Returns:
        ãƒ€ãƒ¡ãƒ¼ã‚¸å€¤
    """

def _check_critical(self, attacker: Character) -> bool:
    """ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š

    ç¢ºçŽ‡: 5% + (luck / 10)%, æœ€å¤§35%

    Returns:
        True: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç™ºå‹•
    """

def _check_guard_break(self, attacker: Character) -> bool:
    """ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®š (ç‰©ç†æ”»æ’ƒã®ã¿)

    ç¢ºçŽ‡: 15% + (luck / 20)%, æœ€å¤§30%

    Returns:
        True: ã‚¬ãƒ¼ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯ç™ºå‹•
    """

def _check_evasion(self,
                   attacker: Character,
                   defender: Character) -> bool:
    """å›žé¿åˆ¤å®š

    ç¢ºçŽ‡: (speed/500) + (def_luck/1000) - (atk_luck/1000)

    Returns:
        True: å›žé¿æˆåŠŸ
    """

def _draw_battle_screen(self):
    """Pygameã§ãƒãƒˆãƒ«ç”»é¢æç”»"""

def _show_effect(self, effect_type: str, x: int, y: int):
    """ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º

    Args:
        effect_type: "critical" / "guard_break" / "magic"
        x, y: è¡¨ç¤ºåº§æ¨™
    """
```

---

### 9.2.6 StoryModeEngine

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/story_mode_engine.py`

```python
class StoryModeEngine:
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³"""

    def __init__(self,
                 db_manager,
                 character: Character):
        """åˆæœŸåŒ–

        Args:
            db_manager: SheetsManager ã¾ãŸã¯ DatabaseManager
            character: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        """

    def load_bosses(self):
        """å…¨ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ (Lv1-5)"""

    def load_progress(self) -> StoryProgress:
        """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€²è¡ŒçŠ¶æ³ã‚’èª­ã¿è¾¼ã¿

        Returns:
            é€²è¡ŒçŠ¶æ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        """

    def start_story_mode(self) -> bool:
        """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹

        Returns:
            True: Lv5ã‚¯ãƒªã‚¢, False: æ•—åŒ—
        """
```

**å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰:**
```python
def _show_challenge_screen(self, level: int):
    """æŒ‘æˆ¦ç”»é¢ã‚’2ç§’è¡¨ç¤º

    Args:
        level: ãƒœã‚¹ãƒ¬ãƒ™ãƒ«
    """

def _battle_boss(self, boss: StoryBoss) -> str:
    """ãƒœã‚¹ã¨ãƒãƒˆãƒ«

    Args:
        boss: ãƒœã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

    Returns:
        "win" or "lose"
    """

def _show_clear_screen(self):
    """ã‚¯ãƒªã‚¢ç”»é¢è¡¨ç¤º"""

def _show_game_over_screen(self, level: int):
    """ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢è¡¨ç¤º

    Args:
        level: æ•—åŒ—ã—ãŸãƒ¬ãƒ™ãƒ«
    """
```

---

### 9.2.7 EndlessBattleEngine

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/services/endless_battle_engine.py`

```python
class EndlessBattleEngine:
    """ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³"""

    def __init__(self,
                 db_manager,
                 characters: list[Character],
                 battle_speed: float = 1.0):
        """åˆæœŸåŒ–

        Args:
            db_manager: ãƒ‡ãƒ¼ã‚¿ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼
            characters: å‚åŠ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
            battle_speed: ãƒãƒˆãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰
        """

    def execute_endless_battle(self) -> Character:
        """ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒˆãƒ«ã‚’å®Ÿè¡Œ

        Returns:
            å„ªå‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        """
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
1. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
2. å…ˆé ­ã‚’ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã«è¨­å®š
3. æ®‹ã‚Šã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨é †æ¬¡å¯¾æˆ¦
4. å‹è€…ãŒãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã€æ•—è€…ã¯é™¤å¤–
5. æŒ‘æˆ¦è€…ãŒã„ãªããªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—

---

## 9.3 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

### 9.3.1 FileManager

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/utils/file_utils.py`

```python
class FileManager:
    """ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£"""

    def __init__(self):
        self.data_dir = Path("data")
        self.characters_dir = self.data_dir / "characters"
        self.sprites_dir = self.data_dir / "sprites"
        self.bosses_dir = self.data_dir / "story_bosses"

    def save_character_image(self,
                             src_path: str,
                             character_id: str,
                             image_type: str = "original") -> str:
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’ä¿å­˜

        Args:
            src_path: å…ƒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
            character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
            image_type: "original" or "sprite"

        Returns:
            ä¿å­˜å…ˆãƒ‘ã‚¹
        """

    def delete_character_files(self, character_id: str):
        """ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

        Args:
            character_id: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
        """
```

---

## 9.4 ä½¿ç”¨ä¾‹

### 9.4.1 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```python
from src.services.sheets_manager import SheetsManager
from src.services.ai_analyzer import AIAnalyzer
from src.services.image_processor import ImageProcessor
from src.models.character import Character
import uuid
from datetime import datetime

# 1. ç”»åƒå‡¦ç†
processor = ImageProcessor()
original_path, sprite_path = processor.process_character_image(
    "scanned_image.jpg",
    str(uuid.uuid4())
)

# 2. AIè§£æž
analyzer = AIAnalyzer()
stats = analyzer.analyze_character(sprite_path)

# 3. Characterãƒ¢ãƒ‡ãƒ«ä½œæˆ
character = Character(
    id=str(uuid.uuid4()),
    name="å‹‡è€…ãã‚“",
    image_path=original_path,
    sprite_path=sprite_path,
    hp=stats['hp'],
    attack=stats['attack'],
    defense=stats['defense'],
    speed=stats['speed'],
    magic=stats['magic'],
    luck=stats['luck'],
    description=stats['description'],
    created_at=datetime.now()
)

# 4. ãƒ‡ãƒ¼ã‚¿ä¿å­˜
manager = SheetsManager()
if manager.online_mode:
    # ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: Driveã«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    sprite_url = manager.upload_image_to_drive(sprite_path, f"{character.id}_sprite.png")
    character.sprite_path = sprite_url

manager.save_character(character)
```

### 9.4.2 ãƒãƒˆãƒ«å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```python
from src.services.battle_engine import BattleEngine
from src.services.sheets_manager import SheetsManager

# ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å–å¾—
manager = SheetsManager()
characters = manager.get_all_characters()
char1 = characters[0]
char2 = characters[1]

# ãƒãƒˆãƒ«å®Ÿè¡Œ
engine = BattleEngine(char1, char2, battle_speed=1.0)
battle = engine.execute_battle()

# çµæžœè¡¨ç¤º
print(f"Winner: {battle.winner_name}")
print(f"Turns: {battle.total_turns}")

# æˆ¦ç¸¾æ›´æ–°
if battle.winner_id == char1.id:
    char1.wins += 1
    char2.losses += 1
else:
    char2.wins += 1
    char1.losses += 1

manager.update_character(char1)
manager.update_character(char2)

# ãƒãƒˆãƒ«å±¥æ­´ä¿å­˜
manager.save_battle_history(battle)

# ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
manager.update_rankings()
```

### 9.4.3 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```python
from src.services.story_mode_engine import StoryModeEngine

# ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
story_engine = StoryModeEngine(manager, character)

# ãƒœã‚¹èª­ã¿è¾¼ã¿
story_engine.load_bosses()

# ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
cleared = story_engine.start_story_mode()

if cleared:
    print("ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼")
else:
    print("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼")
```

---

## 9.5 è¨­å®šå®šæ•°

**ãƒ•ã‚¡ã‚¤ãƒ«:** `config/settings.py`

```python
# Google API
GOOGLE_API_KEY: str
MODEL_NAME: str = "gemini-2.5-flash-lite-preview-06-17"
GOOGLE_CREDENTIALS_PATH: str = "credentials.json"
SPREADSHEET_ID: str
DRIVE_FOLDER_ID: Optional[str]

# ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆå
WORKSHEET_NAME: str = "Characters"
BATTLE_HISTORY_SHEET: str = "BattleHistory"
RANKING_SHEET: str = "Rankings"
STORY_BOSSES_SHEET: str = "StoryBosses"
STORY_PROGRESS_SHEET: str = "StoryProgress"

# ãƒãƒˆãƒ«è¨­å®š
MAX_BATTLE_TURNS: int = 100
DEFAULT_BATTLE_SPEED: float = 1.0  # ç§’/ã‚¿ãƒ¼ãƒ³

# ç”»åƒå‡¦ç†è¨­å®š
MAX_SPRITE_SIZE: tuple = (300, 300)
BACKGROUND_THRESHOLD: int = 240

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_PATH: str = "data/database.db"
```

---

## ã¾ã¨ã‚

ã“ã®APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã¯ã€ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ä¸»è¦ãªã‚¯ãƒ©ã‚¹ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç¶²ç¾…ã—ã¾ã—ãŸã€‚å®Ÿè£…ã®è©³ç´°ã¯å„ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
