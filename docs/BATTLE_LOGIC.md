# ðŸŽ® ãŠçµµæããƒãƒˆãƒ©ãƒ¼ - ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°ä»•æ§˜æ›¸

## ðŸ“‹ ç›®æ¬¡
1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹](#ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)
3. [ãƒãƒˆãƒ«ãƒ•ãƒ­ãƒ¼](#ãƒãƒˆãƒ«ãƒ•ãƒ­ãƒ¼)
4. [ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—](#ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—)
5. [ç‰¹æ®Šã‚·ã‚¹ãƒ†ãƒ ](#ç‰¹æ®Šã‚·ã‚¹ãƒ†ãƒ )
6. [ãƒãƒ©ãƒ³ã‚¹èª¿æ•´](#ãƒãƒ©ãƒ³ã‚¹èª¿æ•´)
7. [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)

---

## æ¦‚è¦

ãŠçµµæããƒãƒˆãƒ©ãƒ¼ã®ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ã®æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯5ã¤ã®åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã¡ã€ã“ã‚Œã‚‰ã®æ•°å€¤ã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«æˆ¦é—˜ãŒé€²è¡Œã—ã¾ã™ã€‚

### åŸºæœ¬åŽŸå‰‡
- **ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹**: ç´ æ—©ã•ã«ã‚ˆã£ã¦è¡Œå‹•é †ãŒæ±ºå®š
- **è‡ªå‹•æˆ¦é—˜**: AIãŒè¡Œå‹•ã‚’é¸æŠžï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä»‹å…¥ãªã—ï¼‰
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é‡è¦–**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å€‹æ€§ãŒãƒãƒˆãƒ«ã«ç›´æŽ¥å½±éŸ¿
- **é‹è¦ç´ **: ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã«ã‚ˆã‚Šäºˆæ¸¬ä¸å¯èƒ½æ€§ã‚’ç¢ºä¿

---

## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

### ðŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ§‹æˆ

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ç¯„å›² | åŠ¹æžœ |
|---|---|---|
| **HPï¼ˆä½“åŠ›ï¼‰** | 50-150 | ç”Ÿå‘½åŠ›ã€‚0ã«ãªã‚‹ã¨æ•—åŒ— |
| **Attackï¼ˆæ”»æ’ƒåŠ›ï¼‰** | 30-120 | ç‰©ç†æ”»æ’ƒã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã«å½±éŸ¿ |
| **Defenseï¼ˆé˜²å¾¡åŠ›ï¼‰** | 20-100 | å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸› |
| **Speedï¼ˆç´ æ—©ã•ï¼‰** | 40-130 | è¡Œå‹•é †ã¨å‘½ä¸­çŽ‡ã«å½±éŸ¿ |
| **Magicï¼ˆé­”åŠ›ï¼‰** | 10-100 | é­”æ³•æ”»æ’ƒã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ä½¿ç”¨é »åº¦ã«å½±éŸ¿ |

### è¨ˆç®—å¼
```python
# ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
total_stats = hp + attack + defense + speed + magic

# å‹çŽ‡ï¼ˆæˆ¦ç¸¾ãŒã‚ã‚‹å ´åˆï¼‰
win_rate = (win_count / battle_count) * 100
```

---

## ãƒãƒˆãƒ«ãƒ•ãƒ­ãƒ¼

### 1. ðŸš€ ãƒãƒˆãƒ«é–‹å§‹ãƒ•ã‚§ãƒ¼ã‚º

```python
# åˆæœŸåŒ–å‡¦ç†
char1_current_hp = char1.hp
char2_current_hp = char2.hp
battle = Battle(character1_id=char1.id, character2_id=char2.id)

# ãƒ­ã‚°è¨˜éŒ²
battle.add_log_entry(f"ðŸ¥Š ãƒãƒˆãƒ«é–‹å§‹ï¼ {char1.name} VS {char2.name}")
battle.add_log_entry(f"ðŸ’š {char1.name} HP: {char1_current_hp} / {char2.name} HP: {char2_current_hp}")
```

### 2. âš¡ ã‚¿ãƒ¼ãƒ³é †åºæ±ºå®š

```python
def determine_turn_order(char1: Character, char2: Character):
    # ç´ æ—©ã•ã«Â±5ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’è¿½åŠ 
    char1_speed = char1.speed + random.randint(-5, 5)
    char2_speed = char2.speed + random.randint(-5, 5)
    
    # å…ˆæ”»ãƒ»å¾Œæ”»ã‚’æ±ºå®š
    if char1_speed >= char2_speed:
        return [(char1, char2), (char2, char1)]
    else:
        return [(char2, char1), (char1, char2)]
```

### 3. ðŸŽ¯ è¡Œå‹•é¸æŠžã‚·ã‚¹ãƒ†ãƒ 

```python
def _choose_action(attacker: Character, defender: Character, defender_hp: int):
    # åŸºæœ¬é­”æ³•ç¢ºçŽ‡ï¼ˆé­”åŠ›ä¾å­˜ã€æœ€å¤§40%ï¼‰
    magic_prob = min(0.4, attacker.magic / 200)
    
    # æˆ¦è¡“çš„èª¿æ•´
    if defender.defense > 70:  # é«˜é˜²å¾¡ç›¸æ‰‹
        magic_prob += 0.2      # é­”æ³•ç¢ºçŽ‡+20%
    
    if defender_hp < defender.hp * 0.3:  # ç›¸æ‰‹ç€•æ­»
        magic_prob += 0.15     # ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥é­”æ³•+15%
    
    return "magic" if random.random() < magic_prob else "attack"
```

### 4. ðŸ’¥ æˆ¦é—˜å®Ÿè¡Œãƒ«ãƒ¼ãƒ—

```python
while turn_number <= MAX_TURNS:  # æœ€å¤§50ã‚¿ãƒ¼ãƒ³
    if char1_current_hp <= 0 or char2_current_hp <= 0:
        break  # æ±ºç€
    
    turn_order = determine_turn_order(char1, char2)
    
    for attacker, defender in turn_order:
        # ã‚¿ãƒ¼ãƒ³å®Ÿè¡Œ
        turn = execute_turn(attacker, defender, turn_number)
        battle.add_turn(turn)
        
        # HPæ›´æ–°ã¨ãƒ­ã‚°è¨˜éŒ²
        update_hp_and_log(turn)
        
        # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ›´æ–°
        if visual_mode:
            update_battle_display()
            time.sleep(1.0 * battle_speed)
    
    turn_number += 1
```

---

## ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—

### ðŸŽ² å‘½ä¸­åˆ¤å®š

```python
def calculate_hit_chance(attacker: Character, defender: Character):
    speed_diff = attacker.speed - defender.speed
    hit_chance = max(0.8, min(0.95, 0.85 + speed_diff * 0.001))
    
    # å‘½ä¸­çŽ‡ç¯„å›²: 80% - 95%
    return random.random() <= hit_chance
```

### âš”ï¸ ç‰©ç†æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸

```python
def calculate_physical_damage(attacker: Character, defender: Character):
    # åŸºæœ¬ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆÂ±15ã®å¤‰å‹•ï¼‰
    base_damage = attacker.attack + random.randint(-15, 15)
    
    # é˜²å¾¡åŠ›é©ç”¨
    effective_defense = defender.defense
    damage = max(1, base_damage - effective_defense + random.randint(-5, 5))
    
    return damage
```

### ðŸ”® é­”æ³•æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸

```python
def calculate_magic_damage(attacker: Character, defender: Character):
    # åŸºæœ¬ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆÂ±10ã®å¤‰å‹•ï¼‰
    base_damage = attacker.magic + random.randint(-10, 10)
    
    # é˜²å¾¡åŠ›åŠæ¸›åŠ¹æžœ
    effective_defense = max(0, defender.defense * 0.5)
    damage = max(1, base_damage - effective_defense + random.randint(-5, 5))
    
    return damage
```

### â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆ

```python
def check_critical_hit(action_type: str):
    critical_chance = 0.05  # åŸºæœ¬5%
    
    if action_type == "magic":
        critical_chance *= 0.7  # é­”æ³•ã¯3.5%
    
    is_critical = random.random() < critical_chance
    multiplier = 2.0 if is_critical else 1.0
    
    return is_critical, multiplier
```

---

## ç‰¹æ®Šã‚·ã‚¹ãƒ†ãƒ 

### ðŸ›¡ï¸ é˜²å¾¡åŠ›ã‚·ã‚¹ãƒ†ãƒ 

| æ”»æ’ƒã‚¿ã‚¤ãƒ— | é˜²å¾¡åŠ›åŠ¹æžœ |
|---|---|
| **ç‰©ç†æ”»æ’ƒ** | ãƒ•ãƒ«é˜²å¾¡åŠ›é©ç”¨ |
| **é­”æ³•æ”»æ’ƒ** | é˜²å¾¡åŠ›50%è»½æ¸› |

### ðŸŽ¯ å‘½ä¸­çŽ‡ã‚·ã‚¹ãƒ†ãƒ 

```python
# ç´ æ—©ã•å·®ã«ã‚ˆã‚‹å‘½ä¸­çŽ‡å¤‰å‹•
base_hit_rate = 85%
speed_bonus = (attacker_speed - defender_speed) * 0.1%
final_hit_rate = clamp(base_hit_rate + speed_bonus, 80%, 95%)
```

### ðŸŽª ç¢ºçŽ‡ãƒ†ãƒ¼ãƒ–ãƒ«

| è¦ç´  | åŸºæœ¬ç¢ºçŽ‡ | æ¡ä»¶ä¿®æ­£ |
|---|---|---|
| **é­”æ³•ä½¿ç”¨** | `min(40%, magic/200)` | é«˜é˜²å¾¡ç›¸æ‰‹+20%, ç€•æ­»ç›¸æ‰‹+15% |
| **ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«** | 5% | é­”æ³•æ™‚ã¯3.5% |
| **å‘½ä¸­** | 85% | ç´ æ—©ã•å·®ã§80-95%ã®ç¯„å›² |

---

## ãƒãƒ©ãƒ³ã‚¹èª¿æ•´

### ðŸ’ª ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å½±éŸ¿åº¦

```python
# å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é‡è¦åº¦
HP:      ç”Ÿå­˜æ™‚é–“ã«ç›´çµï¼ˆé«˜é‡è¦åº¦ï¼‰
Attack:  ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸ã®ä¸»åŠ›ï¼ˆä¸­é‡è¦åº¦ï¼‰
Defense: è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ï¼ˆä¸­é‡è¦åº¦ï¼‰
Speed:   å…ˆæ‰‹ï¼‹å‘½ä¸­çŽ‡ï¼ˆé«˜é‡è¦åº¦ï¼‰
Magic:   é˜²å¾¡è²«é€šï¼‹è¡Œå‹•é¸æŠžï¼ˆä¸­é‡è¦åº¦ï¼‰
```

### ðŸŽ® æˆ¦ç•¥çš„è¦ç´ 

1. **é«˜æ”»æ’ƒåž‹**: ç´ æ—©ã„æ±ºç€ã‚’ç‹™ã†
2. **é«˜é˜²å¾¡åž‹**: æŒä¹…æˆ¦ã§ç›¸æ‰‹ã‚’æ¶ˆè€—ã•ã›ã‚‹
3. **é«˜ç´ æ—©ã•åž‹**: å…ˆæ‰‹ã¨å‘½ä¸­çŽ‡ã§æœ‰åˆ©ã‚’å–ã‚‹
4. **é«˜é­”åŠ›åž‹**: é˜²å¾¡åŠ›ã‚’ç„¡è¦–ã—ãŸå®‰å®šãƒ€ãƒ¡ãƒ¼ã‚¸
5. **ãƒãƒ©ãƒ³ã‚¹åž‹**: å®‰å®šã—ãŸæˆ¦ç¸¾ã‚’æ®‹ã™

---

## å®Ÿè£…è©³ç´°

### ðŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```python
class BattleTurn:
    turn_number: int
    attacker_id: str
    defender_id: str
    action_type: str     # "attack" or "magic"
    damage: int
    is_critical: bool
    is_miss: bool
    attacker_hp_after: int
    defender_hp_after: int

class Battle:
    id: str
    character1_id: str
    character2_id: str
    winner_id: Optional[str]
    battle_log: List[str]
    turns: List[BattleTurn]
    duration: float
    created_at: datetime
```

### ðŸŽ¨ ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```python
# ãƒŸã‚¹
"ðŸ’¨ {attacker.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼"

# ç‰©ç†æ”»æ’ƒ
"âš”ï¸ {attacker.name}ã®æ”»æ’ƒï¼ {defender.name}ã«{damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"
"ðŸ’¥ {attacker.name}ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ”»æ’ƒï¼ {defender.name}ã«{damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"

# é­”æ³•æ”»æ’ƒ
"ðŸ”® {attacker.name}ã®é­”æ³•æ”»æ’ƒï¼ {defender.name}ã«{damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"
"âœ¨ {attacker.name}ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«é­”æ³•ï¼ {defender.name}ã«{damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"

# å‹æ•—
"ðŸ† {winner.name}ã®å‹åˆ©ï¼"
"â° æ™‚é–“åˆ‡ã‚Œï¼ {winner.name}ã®åˆ¤å®šå‹ã¡ï¼"
```

### âš™ï¸ è¨­å®šå€¤

```python
# config/settings.py
MAX_TURNS = 50
CRITICAL_CHANCE = 0.05
CRITICAL_MULTIPLIER = 2.0

# ãƒãƒˆãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆç§’ï¼‰
battle_speed = 0.5  # ã‚¿ãƒ¼ãƒ³é–“ã®å¾…æ©Ÿæ™‚é–“
```

### ðŸŽµ è¦–è¦šãƒ»éŸ³éŸ¿æ¼”å‡º

- **Pygame**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æˆ¦é—˜ç”»é¢è¡¨ç¤º
- **BGM**: ãƒãƒˆãƒ«ä¸­ã®èƒŒæ™¯éŸ³æ¥½
- **åŠ¹æžœéŸ³**: æ”»æ’ƒãƒ»é­”æ³•ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã®éŸ³éŸ¿åŠ¹æžœ
- **ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®å‹•ã

---

## ðŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---|---|
| `src/services/battle_engine.py` | ãƒ¡ã‚¤ãƒ³ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ |
| `src/models/character.py` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ« |
| `src/models/battle.py` | ãƒãƒˆãƒ«ãƒ»ã‚¿ãƒ¼ãƒ³ãƒ¢ãƒ‡ãƒ« |
| `config/settings.py` | ãƒãƒˆãƒ«è¨­å®šå€¤ |
| `src/services/database_manager.py` | ãƒãƒˆãƒ«çµæžœä¿å­˜ |

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ ãŠçµµæããƒãƒˆãƒ©ãƒ¼ v1.0 ã®ä»•æ§˜ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚*
*æœ€çµ‚æ›´æ–°: 2025å¹´1æœˆ*