# お絵描きバトラー - プロジェクト仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**お絵描きバトラー (Oekaki Battler)**

### 1.2 目的
アナログで描かれた手描きキャラクターをデジタル化し、AIがキャラクターの見た目を分析して自動生成したステータスに基づいて自動対戦を行うゲームシステムの構築。

### 1.3 基本コンセプト
- **創造性の活用**: 手描きの個性がゲーム性能に直接反映
- **AI活用**: 視覚分析による自動ステータス生成
- **観戦型ゲーム**: プレイヤーは操作せず、バトルを観戦

## 2. システム仕様

### 2.1 全体ワークフロー
1. **アナログ描画** - 紙にキャラクターを描画
2. **デジタル取り込み** - スキャナーまたはカメラで画像化
3. **キャラクター抽出** - 背景除去と前処理
4. **AI分析** - 見た目からステータス自動生成
5. **キャラクター登録** - バトル用データベースに保存
6. **自動バトル** - AIステータスに基づく自動戦闘
7. **結果表示** - バトル結果と統計の表示

### 2.2 技術要件

#### 2.2.1 開発環境
- **言語**: Python 3.11+
- **メインフレームワーク**: Pygame (ゲームエンジン)
- **AIライブラリ**: Google Generative AI
- **画像処理**: OpenCV, PIL/Pillow
- **GUI**: Tkinter (設定画面用)
- **データ管理**: SQLite + Pydantic

#### 2.2.2 必要ライブラリ
```
pygame>=2.5.0
opencv-python>=4.8.0
pillow>=10.0.0
google-generativeai>=0.3.0
pydantic>=2.0.0
python-dotenv>=1.0.0
numpy>=1.24.0
sqlite3 (標準ライブラリ)
tkinter (標準ライブラリ)
```

### 2.3 データモデル

#### 2.3.1 キャラクターモデル
```python
class Character(BaseModel):
    id: str
    name: str
    hp: int          # 体力 (50-150)
    attack: int      # 攻撃力 (30-120)
    defense: int     # 防御力 (20-100)
    speed: int       # 素早さ (40-130)
    magic: int       # 魔法力 (10-100)
    description: str # AI生成の説明文
    image_path: str  # 元画像パス
    sprite_path: str # 抽出済みスプライト
    created_at: datetime
    battle_count: int
    win_count: int
```

#### 2.3.2 バトルモデル
```python
class Battle(BaseModel):
    id: str
    character1_id: str
    character2_id: str
    winner_id: Optional[str]
    battle_log: List[str]
    duration: float
    created_at: datetime
```

## 3. 機能仕様

### 3.1 画像処理システム

#### 3.1.1 画像取り込み
- 対応形式: PNG, JPG, JPEG, BMP
- 推奨解像度: 1000x1000px以上
- 自動回転補正機能

#### 3.1.2 キャラクター抽出
- 背景自動除去 (GrabCut アルゴリズム)
- エッジ検出によるキャラクター境界抽出
- ノイズ除去とスムージング
- 透明背景での保存

#### 3.1.3 前処理
- サイズ正規化 (300x300px)
- コントラスト調整
- 線画強調フィルタ

### 3.2 AI分析システム

#### 3.2.1 ステータス生成ロジック
- **体力 (HP)**: キャラクターの大きさ、堅牢さから判定
- **攻撃力**: 武器の有無、鋭さ、攻撃的な見た目から判定
- **防御力**: 鎧・盾の有無、防御的な姿勢から判定
- **素早さ**: 体型、足の長さ、動的な描画から判定
- **魔法力**: 魔法的な要素、杖、魔法陣等の有無から判定

#### 3.2.2 分析プロンプト最適化
```
あなたは経験豊富なゲームバランス調整者です。
手描きキャラクターの絵を分析し、見た目の特徴からゲーム内での能力値を決定してください。

分析観点:
1. 体格・体型から体力を判定
2. 武器・攻撃的要素から攻撃力を判定  
3. 防具・防御姿勢から防御力を判定
4. 体型・手足から素早さを判定
5. 魔法的要素から魔法力を判定

ステータス範囲:
- HP: 50-150 (平均100)
- Attack: 30-120 (平均75)
- Defense: 20-100 (平均60)
- Speed: 40-130 (平均85)
- Magic: 10-100 (平均55)
```

### 3.3 バトルシステム

#### 3.3.1 戦闘メカニクス
- **ターン制**: 素早さ順で行動
- **基本攻撃**: ダメージ = 攻撃力 - 防御力
- **魔法攻撃**: 魔法力ベース、防御力無視
- **クリティカル**: 5%確率で2倍ダメージ
- **回避**: 素早さ差に基づく回避率

#### 3.3.2 バトル演出
- スプライトアニメーション
- ダメージエフェクト
- HPバー表示
- 効果音とBGM
- バトルログリアルタイム表示

#### 3.3.3 勝利条件
- 相手のHPを0にする
- 最大50ターン経過で、残りHP多い方の勝利

### 3.4 ユーザーインターフェース

#### 3.4.1 メインメニュー
- キャラクター登録
- バトル開始
- キャラクター一覧
- 設定
- 統計・履歴

#### 3.4.2 キャラクター登録画面
- 画像ファイル選択
- プレビュー表示
- 抽出結果確認
- 名前入力
- ステータス確認・調整

#### 3.4.3 バトル画面
- 対戦キャラクター選択
- リアルタイムバトル表示
- バトルログ
- 統計情報

## 4. ファイル構成

```
OekakiBattler/
├── main.py                 # メインアプリケーション
├── config/
│   ├── settings.py         # 設定管理
│   └── database.py         # DB接続設定
├── src/
│   ├── models/
│   │   ├── character.py    # キャラクターモデル
│   │   └── battle.py       # バトルモデル
│   ├── services/
│   │   ├── image_processor.py    # 画像処理
│   │   ├── ai_analyzer.py        # AI分析
│   │   ├── battle_engine.py      # バトルエンジン
│   │   └── database_manager.py   # データ管理
│   ├── ui/
│   │   ├── main_menu.py          # メインメニュー
│   │   ├── character_register.py # キャラ登録UI
│   │   ├── battle_screen.py      # バトル画面
│   │   └── statistics_screen.py  # 統計画面
│   └── utils/
│       ├── file_utils.py         # ファイル操作
│       └── image_utils.py        # 画像ユーティリティ
├── assets/
│   ├── images/
│   ├── sounds/
│   └── fonts/
├── data/
│   ├── characters/          # キャラクター画像保存
│   ├── sprites/            # 抽出済みスプライト
│   └── database.db         # SQLiteデータベース
├── tests/
├── docs/
│   ├── USER_MANUAL.md      # ユーザーマニュアル
│   └── API_REFERENCE.md    # API仕様
├── requirements.txt
├── CLAUDE.md
├── SPECIFICATION.md
└── README.md
```

## 5. 実装フェーズ

### フェーズ1: 基盤構築
- プロジェクト構造設計
- 基本ライブラリ統合
- データモデル実装

### フェーズ2: 画像処理
- 画像取り込み機能
- キャラクター抽出システム
- 前処理パイプライン

### フェーズ3: AI分析強化
- 既存AI分析の改良
- 複数ステータス対応
- プロンプト最適化

### フェーズ4: バトルシステム
- Pygameベースのバトルエンジン
- アニメーションシステム
- 音響システム

### フェーズ5: UI実装
- メインメニュー
- キャラクター管理画面
- バトル観戦画面

### フェーズ6: 統合・テスト
- 全システム統合
- バグ修正
- パフォーマンス最適化

## 6. 品質要件

### 6.1 パフォーマンス
- 画像処理時間: 30秒以内
- バトル開始まで: 5秒以内
- フレームレート: 60fps維持

### 6.2 使いやすさ
- 直感的なUI設計
- わかりやすいエラーメッセージ
- 豊富なヘルプ機能

### 6.3 拡張性
- 新ステータス追加容易
- バトル演出カスタマイズ可能
- AI分析ロジック変更可能

## 7. リスク管理

### 7.1 技術リスク
- AI分析精度の不安定性
- 画像処理の失敗ケース
- バトルバランスの調整

### 7.2 対策
- 手動ステータス調整機能
- 複数の画像処理手法
- 統計に基づくバランス調整

## 8. 今後の発展

### 8.1 追加機能候補
- オンライン対戦
- トーナメント機能
- キャラクターレベルアップ
- 特殊能力システム
- チーム戦

### 8.2 プラットフォーム展開
- Web版の開発
- モバイルアプリ化
- クラウドサービス対応