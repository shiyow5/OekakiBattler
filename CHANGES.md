# 変更履歴 (CHANGES.md)

## 2025-09-30 (修正13): 日本語テキストの文字化け修正

### 問題
勝利画面やバトル中のテキスト（キャラクター名、統計情報、指示テキストなど）で日本語が文字化けする。

### 原因
勝利画面やダメージ表示で新しいフォントを作成する際、`pygame.font.Font(None, size)`を使用していたが、これはデフォルトフォントのため日本語をサポートしていない。

### 解決策
1. **フォントパスの保存**: 初期化時に読み込んだ日本語フォントのパスを`self.japanese_font_path`に保存
2. **ヘルパーメソッドの追加**: `_create_font(size)`メソッドを追加し、保存されたフォントパスから任意のサイズのフォントを作成
3. **全フォント作成箇所の修正**: `pygame.font.Font(None, size)`を`self._create_font(size)`に置き換え

**修正ファイル:**
- `src/services/battle_engine.py`
  - `__init__()`: `japanese_font_path`属性を追加
  - `initialize_display()`: フォント読み込み時にパスを保存
  - `_create_font(size)`: 新規メソッド追加
  - `_show_battle_result()`: 全フォント作成を修正
  - ダメージ表示部分: フォント作成を修正

**修正箇所:**
```python
def _create_font(self, size: int) -> pygame.font.Font:
    """Create a font with Japanese support at the specified size"""
    try:
        if self.japanese_font_path:
            return pygame.font.Font(self.japanese_font_path, size)
        else:
            return pygame.font.Font(None, size)
    except Exception as e:
        logger.warning(f"Failed to create font with size {size}: {e}")
        return self.font
```

**置き換えたフォント:**
- `victory_font` (120pt) - "VICTORY!"表示
- `name_font` (72pt) - 勝者名表示
- `stats_font` (32pt) - 統計情報表示
- `button_font` (48pt) - OKボタン
- `instruction_font` (24pt) - 指示テキスト
- `damage_font` (52-72pt) - ダメージ表示

**対応フォント:**
- Linux: `/usr/share/fonts/truetype/fonts-japanese-gothic.ttf`
- Linux (Noto): `/usr/share/fonts/truetype/noto-cjk/NotoSansCJK-Regular.ttc`
- macOS: `/System/Library/Fonts/ヒラギノ角ゴシック W3.ttc`
- Windows: `C:/Windows/Fonts/msgothic.ttc`

**効果:**
- ✅ すべての画面で日本語が正しく表示される
- ✅ 統一されたフォントで視覚的に一貫性がある
- ✅ 各プラットフォームの標準日本語フォントを自動検出
- ✅ フォールバック機能付きでエラー耐性が高い

---

## 2025-09-30 (修正12): 絵文字の文字化け修正

### 問題
勝利画面で絵文字（👑、⏱️、🔄、❤️）が文字化けして正しく表示されない。

### 原因
システムフォントが絵文字をサポートしていない場合、正しく描画されない。

### 解決策
すべての絵文字をpygameのプリミティブ図形（円、多角形、線）で描画するカスタムアイコンに置き換え。

**修正ファイル:**
- `src/services/battle_engine.py` の `_show_battle_result()` メソッド

**置き換えた絵文字:**

1. **王冠（👑）→ カスタム多角形**
   - 5点の多角形で王冠の形状を描画
   - 3つの宝石（赤・緑・青の円）を追加
   - ゴールドの輪郭線付き

2. **時計（⏱️）→ カスタム図形**
   - 円（時計の外枠）
   - 2本の線（短針と長針）
   - 青色で描画

3. **循環矢印（🔄）→ カスタム図形**
   - 円（回転の軌跡）
   - 三角形（矢印）
   - オレンジ色で描画

4. **ハート（❤️）→ カスタム図形**
   - 2つの円（ハートの上部）
   - 三角形（ハートの下部）
   - 赤色で描画

**技術詳細:**
```python
# 王冠の描画例
crown_points = [
    (center_x, center_y - 15),      # 頂点
    (center_x - 20, center_y),      # 左点
    (center_x - 15, center_y + 10), # 左下
    (center_x + 15, center_y + 10), # 右下
    (center_x + 20, center_y),      # 右点
]
pygame.draw.polygon(screen, color, crown_points)
pygame.draw.circle(screen, jewel_color, jewel_pos, radius)
```

**効果:**
- ✅ すべてのプラットフォームで一貫した表示
- ✅ フォント依存なし
- ✅ カスタマイズ可能なデザイン
- ✅ 鮮明な描画

---

## 2025-09-30 (修正11): 勝利画面の大幅改善

### 変更内容
勝利画面を華やかで見やすいデザインに全面リニューアルしました。

**修正ファイル:**
- `src/services/battle_engine.py` の `_show_battle_result()` メソッド

**主な改善点:**

### 1. 背景デザイン
- **旧**: 単色の黒い半透明オーバーレイ
- **新**: グラデーション背景（上から下に濃くなる）
- ダークブルーのグラデーションで高級感を演出

### 2. 大型「VICTORY!」テキスト
- **フォントサイズ**: 120pt（超大型）
- **エフェクト**: グロー効果（影を5方向に配置）
- **色**: ゴールド（255, 215, 0）
- **位置**: 画面上部中央（目立つ位置）

### 3. キャラクター画像表示
**勝者（左側）:**
- 30%拡大表示（loserより大きい）
- ゴールドの二重枠（太さ8px + 4px）
- 頭上に王冠絵文字👑
- 鮮明な表示

**敗者（右側）:**
- 20%縮小表示
- グレーオーバーレイで暗く
- グレーの枠線
- 控えめな表示

### 4. 勝者名表示
- **フォントサイズ**: 72pt（大型）
- **色**: ゴールド
- **エフェクト**: 黒い太い輪郭線（3px）
- **位置**: VICTORYの下、目立つ場所

### 5. 統計情報パネル
- **背景**: 半透明の濃紺パネル
- **枠**: ゴールドの枠線（3px）
- **フォントサイズ**: 32pt（読みやすい）
- **色**: 淡い黄色（255, 255, 200）
- **アイコン付き**:
  - ⏱️ バトル時間
  - 🔄 総ターン数
  - ❤️ 各キャラのHP

### 6. OKボタン
- **サイズ**: 200×60px（大型）
- **色**: 緑系（100, 180, 100）
- **枠**: 明るい緑の太枠（4px）
- **フォントサイズ**: 48pt
- **位置**: 画面下部（見つけやすい）

### 7. 操作説明
- **テキスト**: "クリックまたはスペースキーで閉じる"
- **フォントサイズ**: 24pt
- **色**: 淡いグレー
- **位置**: OKボタンの上

**レイアウト構成:**
```
┌─────────────────────────────────┐
│         VICTORY! (120pt)         │  ← グロー効果
│                                  │
│        勝者名 (72pt)             │  ← ゴールド + 輪郭
│                                  │
│   👑                             │
│ [勝者画像]      [敗者画像]       │  ← サイズ差、色の違い
│  (大+金枠)       (小+灰色)       │
│                                  │
│ ┌──────────────────────────┐    │
│ │  統計パネル (半透明背景)  │    │
│ │  ⏱️ バトル時間            │    │
│ │  🔄 総ターン数            │    │
│ │  ❤️ HP情報               │    │
│ └──────────────────────────┘    │
│                                  │
│  クリックまたはスペース...       │
│      ┌────────┐                  │
│      │   OK   │                  │  ← 大型緑ボタン
│      └────────┘                  │
└─────────────────────────────────┘
```

**視覚的効果:**
- 勝者が一目で分かる（王冠、サイズ、色）
- 華やかで祝祭的な雰囲気
- 情報が整理されて読みやすい
- プロフェッショナルな見た目

---

## 2025-09-30 (修正10): ダメージ音のタイミング修正

### 変更内容
攻撃音が遅れて鳴る問題を修正し、攻撃の衝撃タイミングと同期するようにしました。

**修正ファイル:**
- `src/services/battle_engine.py` の `_animate_turn()` メソッド

**変更点:**

| 攻撃タイプ | 旧タイミング | 新タイミング |
|----------|------------|------------|
| 物理攻撃 | エフェクト生成後 | 溜め完了直後（エフェクト生成前） |
| 魔法攻撃 | エフェクト生成後 | チャージ完了直後（エフェクト生成前） |

**処理順序の変更:**

**物理攻撃:**
```
旧: 溜め → エフェクト生成 → 音再生
新: 溜め → 音再生 → エフェクト生成
```

**魔法攻撃:**
```
旧: チャージ → エフェクト生成 → 音再生
新: チャージ → 音再生 → エフェクト生成
```

**効果:**
- 攻撃音が衝撃の瞬間に鳴る
- 視覚エフェクトと音が完全同期
- より迫力のある攻撃演出
- 音とエフェクトのズレが解消

**技術詳細:**
- `audio_manager.play_sound()` の呼び出しを、エフェクト生成コードの前に移動
- 画面揺れとエフェクト生成は音の後に実行
- クリティカル音も同様に早いタイミングで再生

---

## 2025-09-30 (修正9): HP減少アニメーションの追加

### 変更内容
ダメージエフェクトが表示された後、HPバーが徐々に減少するアニメーションを追加しました。

**修正ファイル:**
- `src/services/battle_engine.py` の `start_battle()` と `_animate_turn()` メソッド

**変更点:**

1. **HP更新タイミングの変更:**
   - 旧: アニメーション前にHPを即座に更新
   - 新: アニメーション完了後にHPを更新

2. **HP減少アニメーション追加:**
   - Phase 3（着弾・回復）中にHPを段階的に減少
   - 補間式: `current_hp = hp_before - (hp_before - hp_after) × progress`
   - `progress`は0.0から1.0まで線形に増加

3. **処理の流れ:**
```
Phase 1: ぴょんぴょん → HP変化なし
Phase 2: 攻撃エフェクト → HP変化なし
Phase 3: ダメージ表示 + HPバー徐々に減少 ← 新機能
最終: HP完全に更新された状態で表示
```

**視覚的効果:**
- ダメージ数値が表示される
- 同時にHPバーが滑らかに減少していく
- 攻撃の衝撃とダメージが視覚的に連動
- より自然で分かりやすい演出

**例（50フレームの場合）:**
```
フレーム 0: HP 100 (ダメージ前)
フレーム 10: HP 92 (20%減少)
フレーム 25: HP 75 (50%減少)
フレーム 40: HP 58 (80%減少)
フレーム 50: HP 50 (100%減少、最終)
```

**技術詳細:**
- 線形補間でHPを滑らかに減少
- フレームごとに再計算して描画
- バトル速度設定に応じて減少速度も変化
- ミス時はHP変化なし

---

## 2025-09-30 (修正8): バトル速度設定との同期

### 変更内容
アニメーションフレーム数を設定画面の「バトル速度」設定に連動させました。

**修正ファイル:**
- `src/services/battle_engine.py` の `_animate_turn()` メソッド

**変更点:**
- 固定フレーム数 → `battle_speed`設定に応じた動的フレーム数
- 計算式: `基本フレーム数 × (battle_speed × 2)`

**バトル速度設定との対応:**

| 設定値 | 説明 | 速度倍率 | ぴょんぴょん | チャージ | 溜め | 回復 |
|--------|------|---------|------------|---------|------|------|
| 0.01 | 最速 | 0.02x | 1f | 1f | 1f | 1f |
| 0.1 | かなり速い | 0.2x | 10f | 6f | 3f | 10f |
| 0.5 | デフォルト | 1.0x | 50f | 30f | 15f | 50f |
| 1.0 | ゆっくり | 2.0x | 100f | 60f | 30f | 100f |
| 2.0 | かなりゆっくり | 4.0x | 200f | 120f | 60f | 200f |
| 3.0 | 最遅 | 6.0x | 300f | 180f | 90f | 300f |

**動的に調整されるフレーム数:**
- `bounce_frames`: ぴょんぴょんアニメーション
- `charge_frames`: 魔法チャージ
- `windup_frames`: 物理攻撃の溜め
- `recovery_frames`: 着弾・回復
- `miss_frames`: ミスアニメーション
- `shake_frames`: 被弾振動

**利点:**
- ユーザーが設定画面で好みの速度を選択可能
- 速い設定では素早いテンポ感
- 遅い設定ではエフェクトをじっくり鑑賞可能
- 既存のバトル速度設定が完全に機能

**実装詳細:**
```python
speed_multiplier = self.battle_speed * 2
bounce_frames = int(50 * speed_multiplier)
# 例: battle_speed=0.5 → 50フレーム (約0.83秒@60FPS)
# 例: battle_speed=1.0 → 100フレーム (約1.67秒@60FPS)
```

---

## 2025-09-30 (修正7): アニメーション速度の調整

### 変更内容
攻撃アニメーション全体の速度を調整し、より見やすく、迫力のあるタイミングにしました。

**変更点:**

| フェーズ | 旧フレーム数 | 新フレーム数 | 時間（60FPS） |
|---------|------------|------------|--------------|
| Phase 1: ぴょんぴょん | 20 | 50 | 0.83秒 |
| Phase 2a: 魔法チャージ | 15 | 30 | 0.5秒 |
| Phase 2b: 物理攻撃溜め | 0 | 15 | 0.25秒 |
| Phase 3: 着弾・回復 | 30 | 50 | 0.83秒 |

**アニメーション時間の変更:**
- ぴょんぴょん（bounce）: 20フレーム → **50フレーム** (2.5倍)
- 魔法チャージ: 15フレーム → **30フレーム** (2倍)
- 物理攻撃: 即座 → **15フレーム溜め追加**
- 着弾・回復: 30フレーム → **50フレーム** (1.67倍)
- ミスジャンプ: 15フレーム → **30フレーム** (2倍)
- 被弾振動: 10フレーム → **20フレーム** (2倍)

**総アニメーション時間:**
- 物理攻撃（通常）: 約1.2秒 → **約1.9秒**
- 魔法攻撃（通常）: 約1.4秒 → **約2.2秒**

**改善効果:**
- ぴょんぴょんモーションがゆっくりで認識しやすい
- 攻撃の溜めが明確になり、インパクトが増加
- エフェクトを鑑賞する時間が十分に確保される
- 全体的にゆったりとした、見応えのある演出に

---

## 2025-09-30 (修正6): ダメージ表示タイミングの修正

### 修正内容
ダメージ表示が攻撃エフェクトより早く表示される問題を修正しました。

**問題:**
- 攻撃準備段階（ジャンプ、チャージ）からダメージが表示されていた
- エフェクトと同期していないため違和感があった

**修正:**
- Phase 1（攻撃準備）では`current_turn`に`None`を渡し、ダメージを非表示
- Phase 2（攻撃実行）の衝撃タイミングでのみダメージ表示
- 魔法攻撃の場合、チャージ中は非表示、発動時に表示

**タイミング:**
```
Phase 1: ジャンプ/バウンス (20フレーム) → ダメージ非表示
Phase 2a: (魔法のみ) チャージ (15フレーム) → ダメージ非表示
Phase 2b: 攻撃衝撃/爆発 → ダメージ表示開始 ★
Phase 3: 着弾/回復 (30フレーム) → ダメージ表示継続
```

**視覚的改善:**
- ダメージ数値が攻撃の衝撃と同時に表示される
- より自然で没入感のあるタイミング
- 攻撃→衝撃→ダメージの流れが明確に

---

## 2025-09-30 (修正5): エフェクトとダメージ表示の強化

### 変更内容
攻撃エフェクトとダメージ表示を大幅に拡大し、より迫力ある演出にしました。

**変更ファイル:**
- `src/services/battle_effects.py` - 全エフェクトの拡大
- `src/services/battle_engine.py` - ダメージ表示の拡大とパーティクル数増加

**エフェクトの変更:**

| エフェクト | 旧サイズ | 新サイズ | 旧速度 | 新速度 | 旧寿命 | 新寿命 |
|----------|---------|---------|--------|--------|--------|--------|
| 爆発 | 2-6 | 4-10 | 2-8 | 3-12 | 20-40 | 25-50 |
| 斬撃軌跡 | 3-7 | 5-12 | - | - | 10-20 | 15-30 |
| 魔法パーティクル | 2-5 | 4-9 | 1-5 | 2-8 | 30-60 | 40-70 |
| 衝撃パーティクル | 2-5 | 4-9 | 3-10 | 5-15 | 15-30 | 20-40 |
| チャージ | 2-4 | 4-8 | - | - | 20-35 | 25-45 |

**パーティクル数の変更:**

| 攻撃タイプ | 旧数 | 新数 |
|----------|------|------|
| チャージエフェクト | 15 | 25 |
| 魔法パーティクル | 30 | 50 |
| 爆発（通常） | 30 | 50 |
| 爆発（クリティカル） | 40 | 60 |
| 衝撃パーティクル | 15 | 25 |
| 斬撃軌跡ステップ | 15 | 25 |

**ダメージ表示の変更:**

| 表示タイプ | 旧フォントサイズ | 新フォントサイズ | 旧位置 | 新位置 |
|----------|---------------|---------------|--------|--------|
| 通常ダメージ | 28 | 52 | -140 | -180 |
| クリティカル | 36 | 72 | -140 | -180 |

**その他の改善:**
- ダメージテキストの輪郭を太く（±2 → ±3、中間値追加）
- 浮遊アニメーションの振幅拡大（15 → 25）
- 画面揺れの強度増加（通常攻撃: 6→8、クリティカル: 12→18、魔法クリティカル: 15→20）
- 斬撃軌跡の幅拡大（±5 → ±10）
- チャージエフェクトの開始距離拡大（40-80 → 60-120）

**視覚的効果:**
- パーティクルが約2倍のサイズになり、遠くからでも見やすい
- ダメージ数値が約2倍の大きさになり、インパクト増加
- より広範囲にパーティクルが飛散し、攻撃の迫力が向上
- 画面揺れが強くなり、衝撃感が増加

---

## 2025-09-30 (修正4): バトルログ表示の修正

### 修正内容
アニメーション中にバトルログ（画面下のメッセージ）が消える問題を修正しました。

**問題:**
- `_animate_turn()`メソッドで`_render_battle_frame()`を呼び出す際、`recent_logs`に空のリスト`[]`を渡していた
- これにより、アニメーション中は画面下部のバトルログが表示されなかった

**修正:**
- `_animate_turn()`の最初で`self.current_battle.battle_log[-5:]`から最新5件のログを取得
- すべての`_render_battle_frame()`呼び出しに`recent_logs`を渡すように変更

**影響:**
- アニメーション中もバトルログが継続的に表示されるようになった
- ユーザーは何が起こっているかを常に確認できる

---

## 2025-09-30 (修正3): サウンドファイル対応

### 変更内容
外部サウンドファイルを優先的に読み込むように変更しました。

**修正ファイル:**
- `src/services/audio_manager.py` の `create_default_sounds()` メソッド

**新機能:**
- `assets/sounds/`ディレクトリにサウンドファイルがある場合、それを優先的に読み込む
- ファイルがない場合は従来通りプログラム生成音を使用
- 複数フォーマット対応（wav, ogg, mp3）の優先順位読み込み

**対応サウンド:**
1. `attack.wav/ogg/mp3` - 通常攻撃音
2. `critical.wav/ogg/mp3` - クリティカル攻撃音
3. `magic.wav/ogg/mp3` - 魔法攻撃音
4. `miss.wav/ogg/mp3` - 攻撃ミス音
5. `victory.wav/ogg/mp3` - 勝利音

**新規ファイル:**
- `assets/sounds/README.md` - サウンドファイルの使い方ガイド

**動作:**
```python
# 各サウンドについて、以下の順序で検索:
1. attack.wav を探す
2. なければ attack.ogg を探す
3. なければ attack.mp3 を探す
4. すべてなければプログラム生成音を使用
```

---

## 2025-09-30 (修正2): 色引数エラーの修正

### 修正内容
`invalid color argument` エラーを修正しました。

**修正箇所:**
- `src/services/battle_effects.py` の `draw()` メソッド
  - 色値を明示的に整数に変換: `int(particle.color[0])` など
  - alpha値も整数に変換
- `create_explosion()` メソッド
  - 色のバリエーション計算で負の値を防止: `max(0, min(255, ...))`

**原因:**
- パーティクルの色値がfloatになっていた
- pygameのdraw関数は整数のRGBA値を要求する

---

## 2025-09-30: バトルエフェクトとアニメーションシステムの大幅改善

### 概要
お絵描きバトラーのバトルシステムに、滑らかなアニメーション、迫力あるエフェクト、自然なキャラクター動作を実装しました。

### 新規ファイル

#### `src/services/battle_effects.py`
バトルビジュアルエフェクト専用モジュール

**主要クラス:**

1. **`Particle`データクラス**
   - パーティクル個別の状態管理（位置、速度、寿命、色、サイズ）
   - 重力、フェード効果のサポート
   - アルファ値の自動計算

2. **`BattleEffects`クラス**
   - パーティクルシステムの管理
   - 画面揺れエフェクト
   - 各種エフェクト生成メソッド:
     - `create_explosion()`: 爆発エフェクト（20-40パーティクル）
     - `create_slash_trail()`: 斬撃の軌跡（15パーティクル）
     - `create_magic_particles()`: 魔法のキラキラ（30パーティクル、上昇効果）
     - `create_impact_particles()`: 衝撃の飛沫（15パーティクル、方向性あり）
     - `create_charge_effect()`: エネルギーチャージ（10パーティクル、中心に収束）
   - `screen_shake()`: 画面揺れ効果（強度と持続時間指定可能）
   - `update()`: 全エフェクトの更新
   - `draw()`: 全エフェクトの描画

3. **`CharacterAnimator`クラス**
   - キャラクターアニメーション管理
   - イージング関数による滑らかな動き:
     - `ease_in_quad()`: 加速
     - `ease_out_quad()`: 減速
     - `ease_in_out_quad()`: 加速→減速
   - アニメーションタイプ:
     - `jump`: ジャンプ（上昇→下降）
     - `bounce`: バウンド（複数回跳ねる）
     - `shake`: 振動
     - `move_to`: 位置間の滑らかな移動
   - `get_offset()`: 現在のアニメーションオフセット取得
   - `is_animating()`: アニメーション中か判定

### 変更ファイル

#### `src/services/battle_engine.py`

**追加機能:**

1. **エフェクトシステム統合**
   - `self.effects`: BattleEffectsインスタンス
   - `self.animator`: CharacterAnimatorインスタンス
   - `initialize_display()`でエフェクトシステムを初期化

2. **新メソッド: `_animate_turn()`**
   - ターン全体のアニメーション制御
   - 3フェーズ構成:
     - **フェーズ1（20フレーム）**: 攻撃準備
       - 攻撃者が3回バウンド（bounceアニメーション）
     - **フェーズ2**: 攻撃実行
       - 物理攻撃: 斬撃軌跡 + 衝撃パーティクル + 画面揺れ
       - 魔法攻撃: チャージエフェクト（15フレーム）→ 魔法パーティクル + 画面揺れ
       - クリティカル: 爆発エフェクト + 強い画面揺れ
       - 通常: 通常画面揺れ
       - ミス: 防御側がジャンプ
     - **フェーズ3（30フレーム）**: 着弾と回復
       - 防御側に振動アニメーション
   - 効果音の再生タイミングを最適化

3. **新メソッド: `_render_battle_frame()`**
   - 1フレーム分のバトル画面を描画
   - エフェクトシステムの更新（`effects.update()`）
   - アニメーターの更新（`animator.update()`）
   - 画面揺れオフセットの適用
   - キャラクターアニメーションオフセットの適用
   - エフェクトの描画（`effects.draw()`）
   - ダメージテキストの表示
   - バトルログの表示

4. **新メソッド: `_draw_hp_bars()`**
   - HP バー描画ロジックを分離
   - HPバーとHPテキストの描画

5. **改善された`_draw_character()`**
   - アニメーションオフセットに対応（引数はpositionのみ）
   - HP比率の安全な計算（`max(0, ...)` で負の値を防止）
   - 旧来の自動ボブ効果を削除（アニメーターで制御）

6. **改善された`_draw_damage_text()`**
   - フォントサイズ拡大（クリティカル: 36, 通常: 28）
   - より大きな浮遊アニメーション（振幅15）
   - 太い輪郭線（±2ピクセル）

7. **改善された`_update_battle_display()`**
   - イベント処理のみに特化
   - 描画は`_render_battle_frame()`に委譲

8. **改善された`_cleanup_battle()`**
   - エフェクトシステムのクリア
   - アニメーターのクリア

9. **削除されたメソッド**
   - `_draw_attack_effect()`: エフェクトシステムに統合
   - `_draw_magic_effect()`: エフェクトシステムに統合
   - `_draw_critical_effect()`: エフェクトシステムに統合
   - `_draw_normal_attack_effect()`: エフェクトシステムに統合
   - `_draw_miss_effect()`: 不要（ジャンプアニメーションで代替）

**バトルフロー変更:**
```python
# 旧: 静的な1フレーム描画
self._update_battle_display(...)
time.sleep(1.0 * self.battle_speed)

# 新: 複数フェーズの滑らかなアニメーション
self._animate_turn(...)  # 60FPSで50-65フレームのアニメーション
self._update_battle_display(...)  # ログ表示用の最終フレーム
time.sleep(0.5 * self.battle_speed)
```

### 技術的詳細

#### パーティクルシステム
- **ライフサイクル管理**: 各パーティクルは寿命を持ち、自動的に消滅
- **物理シミュレーション**: 速度、重力、フェード効果
- **カラーバリエーション**: ランダムな色変化で自然な見た目
- **アルファブレンド**: pygame.SRCALPHAによる透明度制御

#### アニメーションシステム
- **時間ベース**: フレーム非依存のアニメーション
- **イージング**: 自然な加速・減速曲線
- **複数同時アニメーション**: キャラクターごとに独立したアニメーション
- **自動クリーンアップ**: 完了したアニメーションは自動削除

#### 画面揺れ
- **強度調整可能**: 攻撃タイプに応じた揺れの強さ
  - 物理攻撃（通常）: 強度6
  - 物理攻撃（クリティカル）: 強度12
  - 魔法攻撃（通常）: 強度8
  - 魔法攻撃（クリティカル）: 強度15
- **持続時間制御**: フレーム単位で持続時間を指定
- **ランダムオフセット**: 自然な揺れ感

#### レンダリング最適化
- **60FPS**: `clock.tick(60)`で滑らかな描画
- **スプライトキャッシュ**: キャラクター画像の再利用
- **効率的な描画順序**: 背景→キャラクター→エフェクト→UI

### エフェクト一覧

| エフェクト種類 | トリガー | パーティクル数 | 色 | 特徴 |
|------------|---------|------------|-----|------|
| 爆発 | クリティカルヒット | 30-40 | オレンジ/黄/紫 | 全方向に拡散 |
| 斬撃軌跡 | 物理攻撃 | 15 | 黄白 | 攻撃ラインに沿って生成 |
| 魔法パーティクル | 魔法攻撃 | 30 | 青/紫/白 | 上昇しながら消える |
| 衝撃パーティクル | 物理攻撃 | 15 | 赤 | 攻撃方向に飛散 |
| チャージ | 魔法攻撃開始 | 10 | 黄白 | 中心に収束 |

### アニメーション一覧

| アニメーション | 用途 | 持続時間 | 特徴 |
|------------|------|---------|------|
| bounce | 攻撃準備 | 20フレーム | 3回バウンド、高さ20 |
| jump | ミス回避 | 15フレーム | 単発ジャンプ、高さ25 |
| shake | 被弾反応 | 10フレーム | 左右上下に振動、強度8 |

### 効果音統合

攻撃タイプとエフェクトに応じた効果音再生:
- 物理攻撃: `attack`
- 物理攻撃（クリティカル）: `critical`
- 魔法攻撃: `magic`（1.0倍速）
- 魔法攻撃（クリティカル）: `magic`（1.2倍速） + `critical`
- ミス: `miss`

### パフォーマンス

- **フレームレート**: 60FPS維持
- **ターンあたりの処理時間**: 約1-1.5秒（従来の半分）
- **メモリ管理**: 使用後のパーティクル自動削除
- **スプライトキャッシュ**: 画像読み込みの最適化

### 拡張性

新しいエフェクトやアニメーションを簡単に追加可能:

```python
# 新しいパーティクルエフェクト
self.effects.create_custom_effect(x, y, particle_count, color, behavior)

# 新しいアニメーション
self.animator.start_animation(char_id, 'custom_anim', duration, **params)
```

### 今後の拡張候補

- [ ] キャラクター固有のエフェクト
- [ ] コンボ演出
- [ ] 勝利/敗北アニメーション
- [ ] 天候エフェクト
- [ ] 背景アニメーション
- [ ] スローモーション効果
- [ ] トレイルエフェクト（残像）
- [ ] ライティングエフェクト

### 互換性

- 既存のバトルシステムと完全互換
- `visual_mode=False`で従来の高速バトルも使用可能
- 既存のキャラクターデータ、データベースに影響なし

### テスト推奨項目

- [ ] 通常攻撃のアニメーション
- [ ] クリティカル攻撃のエフェクト
- [ ] 魔法攻撃の演出
- [ ] ミス時のアニメーション
- [ ] 連続攻撃時のパフォーマンス
- [ ] HP低下時の視覚効果
- [ ] バトル終了時のクリーンアップ